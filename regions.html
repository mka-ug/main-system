<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Umoomi Uganda Regions Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Segoe UI', sans-serif; background: #f2f2f2; padding: 20px; }
.container { max-width: 1400px; margin: auto; }

/* HEADER */
header { background: #ccdc; padding: 20px; border-radius: 10px; display: flex; gap: 15px; align-items: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
header i { font-size: 2.5rem; color: #2c3e50; }

/* LAYOUT */
.layout { display: grid; grid-template-columns: 240px 1fr; gap: 20px; }

/* SIDEBAR */
aside { background: #fff; border-radius: 10px; padding: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); height: calc(100vh - 160px); }
aside a { display: block; text-decoration: none; padding: 12px 15px; border-radius: 6px; color: #2c3e50; margin-bottom: 6px; font-size: 1rem; }
aside a i { width: 22px; margin-right: 10px; }
aside a:hover, aside a.active { background: #3498db; color: #fff; }

/* MAIN */
main { background: #fff; border-radius: 10px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

/* MAP */
#map { height: 80vh; width: 100%; border-radius: 10px; }

/* MODAL */
.modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); justify-content: center; align-items: center; z-index: 2000; }
.modal { background: rgba(255,255,255,0.85); backdrop-filter: blur(6px); width: 85%; max-width: 1100px; height: 80vh; border-radius: 12px; padding: 30px; overflow-y: auto; position: relative; color: #2c3e50; }
.modal h2 { margin-bottom: 10px; }
.modal h3 { margin-top: 25px; margin-bottom: 10px; }
.close-btn { position: absolute; top: 15px; right: 20px; font-size: 1.4rem; cursor: pointer; color: #e74c3c; }
.board-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px,1fr)); gap: 15px; }
.member-card { background: #f8f9fa; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display:flex; gap:10px; align-items:center; }
.member-card img { width:50px; height:50px; border-radius:50%; object-fit:cover; border:2px solid #3498db; }
.qaid-card { background: #eaf4ff; border-left: 5px solid #3498db; }
.stats { margin-top: 10px; color: #555; }
.filter-select { margin-bottom:15px; padding:6px 10px; border-radius:6px; border:1px solid #ccc; font-size:1rem; }
</style>
</head>
<body>

<div class="container">

<header>
  <i class="fas fa-shield-alt"></i>
  <div>
    <h2>Regions</h2>
    <small>Majlis Khuddamul Ahmadiyya</small>
  </div>
</header>

<div class="layout">

<aside>
  <a href="index.html"><i class="fas fa-users"></i> Dashboard</a>
  <a href="members.html"><i class="fas fa-chart-line"></i> Members</a>
  <a href="scanner.html"><i class="fas fa-qrcode"></i> Scan ID</a>
  <a href="regions.html" class="active"><i class="fas fa-map-marker-alt"></i> Regions</a>
  <a href="scan-logs.html"><i class="fas fa-history"></i> Activity Logs</a>
  <a href="admin.html"><i class="fas fa-user-shield"></i> Admin Panel</a>
  <a href="settings.html"><i class="fas fa-cog"></i> Settings</a>
</aside>

<main>
  <h3>Uganda Regions Map</h3>
  <div id="map"></div>
</main>

</div>
</div>

<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <span class="close-btn" id="closeModal">&times;</span>
    <select class="filter-select" id="departmentFilter">
      <option value="All">All Departments</option>
    </select>
    <div id="modalContent"></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
const SUPABASE_URL = "https://pqrsljahrnjgkadflbmr.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBxcnNsamFocm5qZ2thZGZsYm1yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NTg0NTYsImV4cCI6MjA4NjEzNDQ1Nn0.egED0C2iRp6j3Xp4ldgrdI0GBep2J7VUR52rBbzsVdo";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const ugandaBounds = [[-1.5, 29.5], [4.5, 35.0]];
const map = L.map("map", {
  maxBounds: ugandaBounds,
  maxBoundsViscosity: 1.0,
  minZoom: 6,
  maxZoom: 12
}).setView([1.3733, 32.2903], 7);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "&copy; OpenStreetMap contributors"
}).addTo(map);

let markers = [];
let currentMembers = [];

async function loadMapData(){
  const { data, error } = await supabaseClient
    .from("umoomi_members")
    .select(`
      id,
      full_name,
      position,
      department,
      photo_url,
      member_id,
      region_id,
      regions (
        id,
        name,
        latitude,
        longitude
      )
    `);

  if(error){ console.error(error); return; }
  clearMarkers();

  const grouped = {};
  data.forEach(member => {
    if(!member.regions) return;
    const r = member.regions;
    if(!grouped[r.id]){
      grouped[r.id] = { id:r.id, name:r.name, lat:r.latitude, lng:r.longitude, members:[] };
    }
    grouped[r.id].members.push(member);
  });

  Object.values(grouped).forEach(region => {
    const marker = L.marker([region.lat, region.lng]).addTo(map);
    marker.bindTooltip(`${region.name}<br/>Members: ${region.members.length}`, {direction:"top", offset:[0,-10]});
    marker.on("click", () => openRegionPopup(region));
    markers.push(marker);
  });
}

function populateFilterOptions(members){
  const select = document.getElementById('departmentFilter');
  const departments = [...new Set(members.map(m => m.department).filter(Boolean))];
  select.innerHTML = '<option value="All">All Departments</option>';
  departments.forEach(d => select.innerHTML += `<option value="${d}">${d}</option>`);
  select.onchange = () => displayMembers(currentMembers, select.value);
}

function displayMembers(members, filter="All"){
  const qaid = members.filter(m => m.member_id.includes("UM-RQ"));
  let others = members.filter(m => !m.member_id.includes("UM-RQ"));
  if(filter !== "All") others = others.filter(m => m.department === filter);

  const html = `
    <h2>${members[0]?.regions?.name || "Region"}</h2>
    <div class="stats">Total Members: ${members.length}</div>

    <h3>Regional Qaid</h3>
    <div class="board-grid">
      ${qaid.length ? qaid.map(m => `
        <div class="member-card qaid-card">
          <img src="${m.photo_url || 'https://via.placeholder.com/50'}" alt="photo"/>
          <div>
            <strong>${m.full_name}</strong><br/>
            ${m.position || 'No position'}
          </div>
        </div>
      `).join("") : "No Qaid assigned"}
    </div>

    <h3>Administration Board</h3>
    <div class="board-grid">
      ${others.length ? others.map(m => `
        <div class="member-card">
          <img src="${m.photo_url || 'https://via.placeholder.com/50'}" alt="photo"/>
          <div>
            <strong>${m.full_name}</strong><br/>
            ${m.position || "Member"}
          </div>
        </div>
      `).join("") : "No members"}
    </div>
  `;
  document.getElementById("modalContent").innerHTML = html;
}

function openRegionPopup(region){
  currentMembers = region.members;
  document.getElementById("modalOverlay").style.display = "flex";
  populateFilterOptions(region.members);
  displayMembers(region.members);
}

function clearMarkers(){
  markers.forEach(m => map.removeLayer(m));
  markers = [];
}

document.getElementById("closeModal").onclick = () => document.getElementById("modalOverlay").style.display = "none";
document.getElementById("modalOverlay").addEventListener("click", function(e){ if(e.target===this)this.style.display="none"; });

loadMapData();
</script>

</body>
</html>
