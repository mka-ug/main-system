<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Umoomi Security Â· Print ID Cards</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- ICONS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>

<!-- QR CODE & BARCODE LIBRARIES -->
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

<!-- SUPABASE -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- JSPDF FOR PDF EXPORT -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
* { box-sizing:border-box; margin:0; padding:0; }
body { font-family:'Segoe UI', Roboto, sans-serif; background:#f4f6f9; padding:20px; }
.container { max-width:1400px; margin:0 auto; display:flex; flex-direction:column; }

/* HEADER */
header { background:linear-gradient(145deg,#fff,#f0f4f8); padding:20px 28px; border-radius:28px; margin-bottom:24px; display:flex; gap:18px; align-items:center; }
header i { font-size:3rem; color:#1e3c5c; }
header h2 { font-weight:700; color:#0b2a41; font-size:1.4rem; }
header small { color:#3a5e7a; font-size:0.9rem; display:block; margin-top:4px; }

/* MAIN CONTENT */
main { background:#fff; border-radius:32px; padding:24px 28px; box-shadow:0 16px 30px rgba(0,10,30,0.04); height:calc(100vh - 140px); overflow-y:auto; display:flex; flex-direction:column; }

/* STATS */
.quick-stats { display:grid; grid-template-columns:repeat(4,1fr); gap:18px; margin-bottom:24px; }
.stat-card { background:linear-gradient(145deg,#1e3f5f,#2c5a85); color:white; padding:20px 14px; border-radius:26px; text-align:center; }
.stat-card i { font-size:2rem; opacity:0.95; margin-bottom:8px; }
.stat-card .stat-number { font-size:1.8rem; font-weight:700; }
.stat-card .stat-label { font-size:0.9rem; opacity:0.9; }

/* CONTROLS */
.controls-bar { display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; flex-wrap:wrap; gap:15px; background:#f8faff; padding:16px 20px; border-radius:24px; border:1px solid rgba(148,184,218,0.2); }
.controls-left, .controls-right { display:flex; gap:12px; flex-wrap:wrap; }
.search-box { position:relative; min-width:250px; }
.search-box i { position:absolute; left:15px; top:50%; transform:translateY(-50%); color:#1e3f5f; }
.search-box input { width:100%; padding:12px 15px 12px 45px; border:1px solid #c4d7ec; border-radius:40px; font-size:0.95rem; outline:none; transition:border-color 0.2s; }
.search-box input:focus { border-color:#1d4d7c; box-shadow:0 0 0 3px rgba(29,77,124,0.1); }

button { padding:12px 22px; border:none; border-radius:50px; font-weight:600; cursor:pointer; display:inline-flex; align-items:center; gap:10px; background:#f6faff; color:#1e3f5f; border:1px solid rgba(148,184,218,0.3); transition:all 0.2s; }
button:hover { transform:translateY(-1px); box-shadow:0 4px 12px rgba(0,0,0,0.08); }
.btn-primary { background:#1d4d7c; color:white; border-color:#1d4d7c; }
.btn-primary:hover { background:#163a5c; }
.btn-success { background:#e3f0fd; border-color:#9ac7ff; color:#1d4d7c; }
.btn-success:hover { background:#c9e2ff; }
.btn-outline { background:transparent; border:1px solid #c4d7ec; }
.btn-outline:hover { background:#edf5fa; }
.btn-warning { background:#fff3cd; border-color:#ffc107; color:#856404; }
.btn-warning:hover { background:#ffeaa7; }

/* FILTER CHIPS */
.filter-chips { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:20px; }
.chip { padding:8px 16px; border-radius:40px; background:#f4faff; border:1px solid #c4d7ec; color:#1e3f5f; cursor:pointer; display:flex; align-items:center; gap:8px; transition:all 0.2s; font-size:0.9rem; }
.chip:hover { background:#e6f2fa; }
.chip.active { background:#1d4d7c; color:white; border-color:#1d4d7c; box-shadow:0 2px 8px rgba(29,77,124,0.25); }
.chip i { font-size:0.85rem; }

/* ID CARD - NEW DESIGN FROM CODE 2 WITH FRONT & BACK */
.cards-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(360px,1fr)); gap:25px; margin-top:20px; padding:5px 0; }

/* Card container - holds both front and back */
.id-card-wrapper {
  background: transparent;
  perspective: 1000px;
  height: 190mm; /* Height to accommodate both cards stacked */
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.id-card { 
  width: 55mm;
  height: 85mm;
  border: 2px solid #004080;
  border-radius: 6px;
  background: linear-gradient(to bottom, #ffffff, #f0f6ff);
  padding: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  display: flex;
  flex-direction: column;
  position: relative;
  overflow: hidden;
  margin: 0 auto;
  page-break-inside: avoid;
  transition: all 0.25s ease; 
}

/* Watermark */
.id-card::before {
  content: "MKA UGANDA";
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) rotate(-30deg);
  font-size: 18pt;
  color: rgba(0,64,128,0.08);
  font-weight: bold;
  white-space: nowrap;
  z-index: 0;
  pointer-events: none;
}

.id-card.selected { 
  border:4px solid #1d4d7c; 
  box-shadow:0 0 0 3px rgba(29,77,124,0.15), 0 8px 25px rgba(0,20,40,0.12);
  transform: translateY(-2px);
}
.id-card:hover { 
  box-shadow:0 8px 25px rgba(0,20,40,0.12), 0 2px 5px rgba(0,0,0,0.08);
  transform: translateY(-2px);
}

/* Flag bar */
.flag-bar {
  height: 12mm;
  border-radius: 4px 4px 0 0;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  position: relative;
  z-index: 1;
}
.flag-stripe { flex: 1; }
.flag-black { background: #000000; }
.flag-yellow { background: #ffcd00; }
.flag-red { background: #d00000; }

/* Circle emblem centered in flag */
.emblem {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 12mm;
  height: 12mm;
  background: #fff;
  border-radius: 50%;
  border: 2px solid #000;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 8pt;
  font-weight: bold;
  color: #000;
  z-index: 2;
}

/* Title below flag */
.header-title {
  text-align: center;
  font-size: 11pt;
  font-weight: bold;
  margin: 6px 0;
  color: #004080;
  z-index: 1;
}

.logo {
  width: 18mm;
  height: 18mm;
  margin: 6px auto;
  background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><circle cx="32" cy="20" r="12" fill="%23004080"/><path d="M8 58c0-13 10-24 24-24s24 11 24 24H8z" fill="%23004080"/></svg>') no-repeat center;
  background-size: contain;
  z-index: 1;
}

.photo {
  width: 28mm;
  height: 34mm;
  margin: 0 auto 6px auto;
  background: #f0f0f0;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 2px solid #004080;
  border-radius: 4px;
  z-index: 1;
}
.photo svg {
  width: 18mm;
  height: 18mm;
  fill: #004080;
}

.section {
  font-size: 9pt;
  margin: 2px 0;
  color: #222;
  z-index: 1;
  position: relative;
}
.label { font-weight: bold; color: #004080; }

.accent { color: #b8860b; font-weight: bold; }

.qr, .barcode {
  text-align: center;
  font-size: 8pt;
  margin-top: 4px;
  color: #004080;
  z-index: 1;
  position: relative;
}

.qr-container {
  width: 30px;
  height: 30px;
  margin: 0 auto 2px;
}
.barcode-container svg {
  max-width: 100%;
  height: 15px;
}

/* Back side specific styles */
.back-text {
  font-size: 8pt;
  margin: 4px 0;
  text-align: center;
  color: #333;
  z-index: 1;
  position: relative;
}

.contacts {
  font-size: 8pt;
  margin-top: 4px;
  color: #222;
  display: flex;
  flex-direction: column;
  gap: 4px;
  z-index: 1;
  position: relative;
}
.contact-block {
  border: 1px solid #004080;
  border-radius: 4px;
  padding: 3px;
  background: #f9f9f9;
}
.handwrite {
  border-bottom: 1px dotted #333;
  display: inline-block;
  min-width: 20mm;
}

/* CARD ACTIONS */
.card-actions { 
  display:flex; 
  gap:8px; 
  padding:8px 10px; 
  justify-content:flex-end; 
  border-top:1px solid #f0f4fa;
  background:#fafcff;
  flex-shrink:0;
  z-index: 2;
  position: relative;
  margin-top: 4px;
}
.card-actions button {
  padding:4px 12px;
  font-size:0.8rem;
  border-radius:20px;
}

/* SELECT BAR */
.select-all-bar { 
  display:flex; 
  align-items:center; 
  gap:15px; 
  padding:12px 20px; 
  background:#e3f0fd; 
  border-radius:40px; 
  margin-bottom:20px;
  font-size:0.95rem;
  color:#1e3f5f;
}
.select-all-bar input[type="checkbox"] {
  width:18px;
  height:18px;
  margin-right:6px;
  cursor:pointer;
  accent-color:#1d4d7c;
}

/* MODAL */
.modal { 
  position:fixed; 
  inset:0; 
  background:rgba(8,25,45,0.65); 
  backdrop-filter:blur(4px); 
  display:none; 
  align-items:center; 
  justify-content:center; 
  z-index:2000; 
  padding:20px; 
}
.modal-content { 
  background:white; 
  border-radius:24px; 
  padding:30px; 
  max-width:1000px; 
  width:100%; 
  max-height:90vh; 
  overflow-y:auto; 
  box-shadow:0 40px 80px rgba(0,15,40,0.5); 
  border:1px solid #b9d4f0;
  position:relative;
}
.modal-header { 
  display:flex; 
  justify-content:space-between; 
  align-items:center; 
  margin-bottom:22px; 
  padding-bottom:16px; 
  border-bottom:2px solid #1d4d7c; 
}
.modal-header h3 {
  font-size:1.3rem;
  color:#0b2a41;
  display:flex;
  align-items:center;
  gap:10px;
}
.modal-close { 
  width:40px; 
  height:40px; 
  border-radius:50%; 
  background:#f4faff; 
  display:flex; 
  align-items:center; 
  justify-content:center; 
  cursor:pointer; 
  font-size:1.2rem; 
  color:#1e3f5f;
  transition:all 0.2s;
  border:1px solid #c4d7ec;
}
.modal-close:hover {
  background:#e6f2fa;
  transform:rotate(90deg);
}

/* EMPTY STATE */
.empty-state { 
  text-align:center; 
  padding:60px 20px; 
  color:#7f8c8d; 
}
.empty-state i { 
  font-size:4rem; 
  margin-bottom:20px; 
  opacity:0.3; 
  color:#1d4d7c;
}
.empty-state h3 { 
  color:#1e3f5f; 
  margin-bottom:10px;
  font-size:1.3rem;
}

/* PRINT STYLES - UPDATED FOR FRONT & BACK */
@media print {
  @page { size: 60mm 90mm; margin: 2mm; }
  body * { visibility: hidden; }
  #printSection, #printSection * { visibility: visible; }
  #printSection { 
    position: absolute; left: 0; top: 0; width: 100%; 
    padding: 2mm; display: grid; grid-template-columns: repeat(2, 1fr); gap: 2mm;
  }
  .print-card { 
    width: 55mm;
    height: 85mm;
    border: 2px solid #004080;
    border-radius: 6px;
    background: linear-gradient(to bottom, #ffffff, #f0f6ff);
    padding: 8px;
    box-shadow: none;
    display: flex;
    flex-direction: column;
    position: relative;
    overflow: hidden;
    page-break-inside: avoid;
    font-size: 9pt;
  }
  .print-card::before {
    content: "MKA UGANDA";
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) rotate(-30deg);
    font-size: 18pt;
    color: rgba(0,64,128,0.08);
    font-weight: bold;
    white-space: nowrap;
    z-index: 0;
  }
  .print-flag-bar {
    height: 12mm;
    border-radius: 4px 4px 0 0;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    position: relative;
    z-index: 1;
  }
  .print-flag-stripe { flex: 1; }
  .print-flag-black { background: #000000; }
  .print-flag-yellow { background: #ffcd00; }
  .print-flag-red { background: #d00000; }
  .print-emblem {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 12mm;
    height: 12mm;
    background: #fff;
    border-radius: 50%;
    border: 2px solid #000;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 8pt;
    font-weight: bold;
    color: #000;
    z-index: 2;
  }
  .print-header-title {
    text-align: center;
    font-size: 11pt;
    font-weight: bold;
    margin: 6px 0;
    color: #004080;
    z-index: 1;
  }
  .print-logo {
    width: 18mm;
    height: 18mm;
    margin: 6px auto;
    background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><circle cx="32" cy="20" r="12" fill="%23004080"/><path d="M8 58c0-13 10-24 24-24s24 11 24 24H8z" fill="%23004080"/></svg>') no-repeat center;
    background-size: contain;
    z-index: 1;
  }
  .print-photo {
    width: 28mm;
    height: 34mm;
    margin: 0 auto 6px auto;
    background: #f0f0f0;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid #004080;
    border-radius: 4px;
    z-index: 1;
  }
  .print-section {
    font-size: 9pt;
    margin: 2px 0;
    color: #222;
    z-index: 1;
  }
  .print-label { font-weight: bold; color: #004080; }
  .print-accent { color: #b8860b; font-weight: bold; }
  .print-qr, .print-barcode {
    text-align: center;
    font-size: 8pt;
    margin-top: 4px;
    color: #004080;
    z-index: 1;
  }
  .print-qr-container {
    width: 30px;
    height: 30px;
    margin: 0 auto 2px;
  }
  .print-barcode-container svg {
    max-width: 100%;
    height: 15px;
  }
  .print-back-text {
    font-size: 8pt;
    margin: 4px 0;
    text-align: center;
    color: #333;
  }
  .print-contacts {
    font-size: 8pt;
    margin-top: 4px;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  .print-contact-block {
    border: 1px solid #004080;
    border-radius: 4px;
    padding: 3px;
    background: #f9f9f9;
  }
  .print-handwrite {
    border-bottom: 1px dotted #333;
    display: inline-block;
    min-width: 20mm;
  }
}

/* PDF PREVIEW MODAL */
.pdf-modal { 
  position:fixed; inset:0; background:rgba(8,25,45,0.65); backdrop-filter:blur(4px); 
  display:none; align-items:center; justify-content:center; z-index:2000; padding:20px; 
}
.pdf-modal .modal-content { max-width:600px; text-align:center; }
.pdf-preview { 
  background:white; border-radius:12px; padding:20px; margin:15px 0; 
  border:1px solid #c4d7ec; max-height:60vh; overflow-y:auto; 
}
.pdf-preview img { max-width:100%; border-radius:8px; box-shadow:0 4px 20px rgba(0,0,0,0.15); }

/* RESPONSIVE */
@media (max-width: 768px) {
  .quick-stats { grid-template-columns: repeat(2, 1fr); }
  .controls-bar { flex-direction: column; align-items: stretch; }
  .controls-left, .controls-right { justify-content: center; }
  .cards-grid { grid-template-columns: 1fr; }
  #printSection { grid-template-columns: 1fr; }
}
</style>
</head>
<body>

<div class="container">
<header>
<i class="fas fa-id-card-clip"></i>
<div>
<h2>Umoomi Security Â· ID Card Printer</h2>
<small>Ahmadiyya Muslim Community Uganda Â· Official Member Identification</small>
</div>
</header>

<main>
<div class="quick-stats">
  <div class="stat-card"><i class="fas fa-users"></i><div class="stat-number" id="totalMembers">0</div><div class="stat-label">Total Members</div></div>
  <div class="stat-card"><i class="fas fa-user-check"></i><div class="stat-number" id="activeMembers">0</div><div class="stat-label">Active</div></div>
  <div class="stat-card"><i class="fas fa-id-badge"></i><div class="stat-number" id="selectedCount">0</div><div class="stat-label">Selected</div></div>
  <div class="stat-card"><i class="fas fa-file-pdf"></i><div class="stat-number" id="totalPages">0</div><div class="stat-label">Est. Pages</div></div>
</div>

<div class="controls-bar">
  <div class="controls-left">
    <div class="search-box"><i class="fas fa-search"></i><input type="text" id="searchInput" placeholder="Search by name or ID..."></div>
    <button class="btn-outline" onclick="filterByStatus('all')"><i class="fas fa-list"></i> All</button>
    <button class="btn-outline" onclick="filterByStatus('active')"><i class="fas fa-check-circle"></i> Active</button>
  </div>
  <div class="controls-right">
    <button class="btn-success" onclick="selectAll()"><i class="fas fa-check-double"></i> Select All</button>
    <button class="btn-success" onclick="deselectAll()"><i class="fas fa-times-circle"></i> Clear</button>
    <button class="btn-primary" onclick="openPrintPreview()"><i class="fas fa-eye"></i> Preview</button>
    <button class="btn-primary" onclick="printSelected()"><i class="fas fa-print"></i> Print</button>
    <button class="btn-warning" onclick="exportSelectedPDF()"><i class="fas fa-file-pdf"></i> Export PDF</button>
  </div>
</div>

<div class="filter-chips" id="filterChips">
  <div class="chip active" onclick="filterRegion('all')" id="chipAll"><i class="fas fa-globe-africa"></i> All Regions</div>
</div>

<div class="select-all-bar">
  <label><input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()"> Select all displayed cards</label>
  <span id="displayedCount">0 members displayed</span>
</div>

<div id="cardsGrid" class="cards-grid"></div>
</main>
</div>

<!-- PRINT PREVIEW MODAL -->
<div class="modal" id="printPreviewModal">
<div class="modal-content">
<div class="modal-header">
<h3><i class="fas fa-print"></i> Print Preview</h3>
<div class="modal-close" onclick="closePrintPreview()"><i class="fas fa-times"></i></div>
</div>
<div style="margin-bottom:18px; display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;">
<button class="btn-primary" onclick="window.print()"><i class="fas fa-print"></i> Print Now</button>
<button class="btn-outline" onclick="closePrintPreview()"><i class="fas fa-times"></i> Close</button>
</div>
<div id="printSection" class="print-preview-grid"></div>
<p style="text-align:center; color:#6a8aa5; font-size:0.85rem; margin-top:15px;">
  <i class="fas fa-info-circle"></i> Cards print 2 per page (60mm Ã— 90mm each). Enable "Background Graphics" in print settings.
</p>
</div>
</div>

<!-- PDF EXPORT MODAL -->
<div class="pdf-modal" id="pdfExportModal">
<div class="modal-content">
<div class="modal-header">
<h3><i class="fas fa-file-pdf"></i> PDF Export</h3>
<div class="modal-close" onclick="closePDFExport()"><i class="fas fa-times"></i></div>
</div>
<div id="pdfPreview" class="pdf-preview">
  <p style="color:#5a7a95">Generating preview...</p>
</div>
<div style="display:flex; gap:10px; justify-content:center; margin-top:15px;">
<button class="btn-primary" id="downloadPDFBtn" onclick="downloadPDF()"><i class="fas fa-download"></i> Download PDF</button>
<button class="btn-outline" onclick="closePDFExport()"><i class="fas fa-times"></i> Close</button>
</div>
<p style="text-align:center; color:#6a8aa5; font-size:0.8rem; margin-top:12px;">
  <i class="fas fa-info-circle"></i> Each card exported as separate page in PDF (60mm Ã— 90mm)
</p>
</div>
</div>

<script>
// SUPABASE CONFIG
const SUPABASE_URL = "https://pqrsljahrnjgkadflbmr.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBxcnNsamFocm5qZ2thZGZsYm1yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NTg0NTYsImV4cCI6MjA4NjEzNDQ1Nn0.egED0C2iRp6j3Xp4ldgrdI0GBep2J7VUR52rBbzsVdo";

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let allMembers = [], filteredMembers = [], selectedMembers = new Set(), regions = [];
let currentFilter = { status: 'all', region: 'all', search: '' };
let generatedPDF = null;

// DOM Elements
const cardsGrid = document.getElementById('cardsGrid');
const searchInput = document.getElementById('searchInput');
const displayedCount = document.getElementById('displayedCount');
const totalMembersEl = document.getElementById('totalMembers');
const activeMembersEl = document.getElementById('activeMembers');
const selectedCountEl = document.getElementById('selectedCount');
const totalPagesEl = document.getElementById('totalPages');
const filterChips = document.getElementById('filterChips');
const printPreviewModal = document.getElementById('printPreviewModal');
const printSection = document.getElementById('printSection');
const pdfExportModal = document.getElementById('pdfExportModal');
const pdfPreview = document.getElementById('pdfPreview');
const downloadPDFBtn = document.getElementById('downloadPDFBtn');

// Initialize
document.addEventListener('DOMContentLoaded', async () => { 
  await loadMembers(); 
  setupEventListeners(); 
});

async function loadMembers() {
  try {
    const { data, error } = await supabaseClient.from('members').select('*');
    if (error) throw error;
    allMembers = data || [];
    if (allMembers.length === 0) allMembers = generateMockMembers();
    regions = [...new Set(allMembers.map(m => m.region).filter(Boolean))];
    renderRegionChips(); 
    applyFilters();
  } catch (err) { 
    console.error('Error loading members:', err); 
    allMembers = generateMockMembers();
    regions = [...new Set(allMembers.map(m => m.region).filter(Boolean))];
    renderRegionChips();
    applyFilters();
  }
}

// Mock data generator WITH POSITION FIELD
function generateMockMembers() {
  const names = ['Abdul Rahman', 'Fatima Nalweyiso', 'Ibrahim Ssemanda', 'Aisha Nakato', 'Yusuf Kiggundu', 'Mariam Nakimuli'];
  const regions = ['Kampala', 'Wakiso', 'Mukono', 'Jinja', 'Mbarara'];
  const departments = ['Security', 'Administration', 'Logistics', 'Media', 'Welfare'];
  const positions = ['Coordinator', 'Secretary', 'Treasurer', 'Volunteer', 'Supervisor', 'Member'];
  return names.map((name, i) => ({
    id: `mock-${i+1}`,
    full_name: name,
    member_id: `MKA-UG-${String(1000 + i).padStart(4, '0')}`,
    region: regions[i % regions.length],
    department: departments[i % departments.length],
    position: positions[i % positions.length],
    status: i % 3 === 0 ? 'inactive' : 'active',
    expiry_date: new Date(Date.now() + (365 * 24 * 60 * 60 * 1000 * (1 + (i % 3)))).toISOString().split('T')[0]
  }));
}

function renderRegionChips() {
  let chips = `<div class="chip active" onclick="filterRegion('all')" id="chipAll"><i class="fas fa-globe-africa"></i> All Regions</div>`;
  regions.sort().forEach(region => { 
    const safeId = region.replace(/\s+/g, '-').toLowerCase();
    chips += `<div class="chip" onclick="filterRegion('${region}')" id="chip-${safeId}"><i class="fas fa-map-marker-alt"></i> ${region}</div>`; 
  });
  filterChips.innerHTML = chips;
}

function setupEventListeners() { 
  searchInput.addEventListener('input', e => { 
    currentFilter.search = e.target.value.toLowerCase(); 
    applyFilters(); 
  }); 
}

function filterRegion(region) { 
  currentFilter.region = region; 
  document.querySelectorAll('.chip').forEach(c => c.classList.remove('active')); 
  const chip = region === 'all' 
    ? document.getElementById('chipAll') 
    : document.getElementById(`chip-${region.replace(/\s+/g, '-').toLowerCase()}`); 
  if (chip) chip.classList.add('active'); 
  applyFilters(); 
}

function filterByStatus(status) { 
  currentFilter.status = status; 
  applyFilters(); 
}

function applyFilters() {
  filteredMembers = allMembers.filter(m => {
    if (currentFilter.status !== 'all' && (m.status || '').toLowerCase() !== currentFilter.status) return false;
    if (currentFilter.region !== 'all' && m.region !== currentFilter.region) return false;
    if (currentFilter.search) {
      const s = currentFilter.search;
      const searchable = `${m.full_name || ''} ${m.member_id || ''} ${m.region || ''} ${m.department || ''} ${m.position || ''}`.toLowerCase();
      if (!searchable.includes(s)) return false;
    }
    return true;
  });
  renderCards(); 
  updateStats(); 
}

function renderCards() {
  if (!filteredMembers.length) { 
    cardsGrid.innerHTML = `<div class="empty-state"><i class="fas fa-id-card"></i><h3>No Members Found</h3><p>Try adjusting your search or filters.</p></div>`; 
    displayedCount.textContent = "0 members displayed"; 
    return; 
  }

  cardsGrid.innerHTML = filteredMembers.map(m => {
    const expiryDate = m.expiry_date || new Date(Date.now() + 365*24*60*60*1000).toISOString().split('T')[0];
    const isSelected = selectedMembers.has(m.id);
    const memberId = m.member_id || `MKA-UG-${m.id}`;
    
    return `
    <div style="display: flex; flex-direction: column; gap: 10px; align-items: center;">
      <!-- FRONT OF CARD -->
      <div class="id-card ${isSelected ? 'selected' : ''}" data-member-id="${m.id}-front" onclick="toggleSelect('${m.id}', event)">
        <!-- Flag bar with emblem -->
        <div class="flag-bar">
          <div class="flag-stripe flag-black"></div>
          <div class="flag-stripe flag-yellow"></div>
          <div class="flag-stripe flag-red"></div>
          <div class="emblem">ðŸ•Š</div>
        </div>
        
        <!-- Title -->
        <div class="header-title">MKA Uganda</div>
        
        <!-- Logo -->
        <div class="logo"></div>
        
        <!-- Photo placeholder -->
        <div class="photo">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
            <circle cx="32" cy="20" r="12" fill="#004080"/>
            <path d="M8 58c0-13 10-24 24-24s24 11 24 24H8z" fill="#004080"/>
          </svg>
        </div>
        
        <!-- Member Details -->
        <div class="section"><span class="label">Name:</span> ${m.full_name || 'Member'}</div>
        <div class="section"><span class="label">ID No.:</span> ${memberId}</div>
        <div class="section"><span class="label">Position:</span> ${m.position || 'Member'}</div>
        <div class="section"><span class="label accent">Department:</span> ${m.department || 'Security'}</div>
        <div class="section"><span class="label accent">Region:</span> ${m.region || 'Uganda'}</div>
        <div class="section"><span class="label">Valid Until:</span> ${formatExpiryDate(expiryDate)}</div>
        
        <!-- QR and Barcode -->
        <div class="qr">
          <div class="qr-container" id="qr-${m.id}"></div>
          <div>SCAN TO VERIFY</div>
        </div>
        <div class="barcode">
          <div class="barcode-container">
            <svg id="barcode-${m.id}"></svg>
          </div>
        </div>
      </div>
      
      <!-- BACK OF CARD -->
      <div class="id-card ${isSelected ? 'selected' : ''}" data-member-id="${m.id}-back" onclick="toggleSelect('${m.id}', event)">
        <!-- Flag bar with emblem (same on back) -->
        <div class="flag-bar">
          <div class="flag-stripe flag-black"></div>
          <div class="flag-stripe flag-yellow"></div>
          <div class="flag-stripe flag-red"></div>
          <div class="emblem">ðŸ•Š</div>
        </div>
        
        <!-- Title -->
        <div class="header-title">MKA Uganda</div>
        
        <!-- Logo -->
        <div class="logo"></div>
        
        <!-- Back Text -->
        <div class="back-text">
          This card certifies that the bearer is a member of Majlis Khuddam-ul-Ahmadiyya Uganda.
        </div>
        
        <!-- Contact Info -->
        <div class="section"><span class="label">Helpdesk:</span> +256 123 456 789</div>
        <div class="section"><span class="label">Website:</span> www.mka.ug</div>
        
        <!-- Barcode (same as front) -->
        <div class="barcode">
          <div class="barcode-container">
            <svg id="barcode-back-${m.id}"></svg>
          </div>
        </div>
        
        <!-- QR Code (larger on back) -->
        <div class="qr">
          <div class="qr-container" id="qr-back-${m.id}" style="width: 40px; height: 40px;"></div>
          <div>SCAN TO VERIFY</div>
        </div>
        
        <!-- Emergency Contacts -->
        <div class="contacts">
          <div class="contact-block">
            <span class="label">Emergency Contact 1:</span><br>
            Name: <span class="handwrite"></span><br>
            Phone: <span class="handwrite"></span>
          </div>
          <div class="contact-block">
            <span class="label">Emergency Contact 2:</span><br>
            Name: <span class="handwrite"></span><br>
            Phone: <span class="handwrite"></span>
          </div>
        </div>
      </div>
      
      <!-- Card Actions (shared for both cards) -->
      <div class="card-actions" onclick="event.stopPropagation()" style="width: 55mm; margin: 0 auto;">
        <button class="${isSelected ? 'btn-primary' : 'btn-outline'}" 
                onclick="toggleSelect('${m.id}', event)">
          ${isSelected ? '<i class="fas fa-check"></i> Selected' : '<i class="fas fa-plus"></i> Select'}
        </button>
      </div>
    </div>
  `}).join('');

  // Generate QR codes and Barcodes after DOM insertion
  setTimeout(() => {
    filteredMembers.forEach(m => { 
      const memberId = m.member_id || `MKA-UG-${m.id}`;
      
      // Front QR Code
      const qrEl = document.getElementById(`qr-${m.id}`); 
      if (qrEl) {
        qrEl.innerHTML = ''; 
        new QRCode(qrEl, {
          text: memberId,
          width: 30, 
          height: 30,
          correctLevel: QRCode.CorrectLevel.M
        });
      }
      
      // Back QR Code (larger)
      const qrBackEl = document.getElementById(`qr-back-${m.id}`);
      if (qrBackEl) {
        qrBackEl.innerHTML = '';
        new QRCode(qrBackEl, {
          text: memberId,
          width: 40,
          height: 40,
          correctLevel: QRCode.CorrectLevel.M
        });
      }
      
      // Front Barcode
      const barcodeEl = document.getElementById(`barcode-${m.id}`);
      if (barcodeEl) {
        JsBarcode(barcodeEl, memberId, {
          format: "CODE128",
          width: 1.0,
          height: 15,
          displayValue: false,
          margin: 0
        });
      }
      
      // Back Barcode
      const barcodeBackEl = document.getElementById(`barcode-back-${m.id}`);
      if (barcodeBackEl) {
        JsBarcode(barcodeBackEl, memberId, {
          format: "CODE128",
          width: 1.0,
          height: 15,
          displayValue: false,
          margin: 0
        });
      }
    });
  }, 150);
  
  displayedCount.textContent = `${filteredMembers.length} members displayed`;
}

function formatExpiryDate(dateStr) {
  if (!dateStr) return '__________';
  const date = new Date(dateStr);
  return date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' });
}

function toggleSelect(id, e) { 
  if (e) e.stopPropagation(); 
  selectedMembers.has(id) ? selectedMembers.delete(id) : selectedMembers.add(id); 
  renderCards(); 
  updateStats(); 
}

function selectAll() { 
  filteredMembers.forEach(m => selectedMembers.add(m.id)); 
  renderCards(); 
  updateStats(); 
}

function deselectAll() { 
  selectedMembers.clear(); 
  renderCards(); 
  updateStats(); 
}

function toggleSelectAll() { 
  const cb = document.getElementById('selectAllCheckbox'); 
  cb.checked ? selectAll() : deselectAll(); 
}

function updateStats() {
  totalMembersEl.textContent = allMembers.length;
  activeMembersEl.textContent = allMembers.filter(m => (m.status || '').toLowerCase() === 'active').length;
  selectedCountEl.textContent = selectedMembers.size;
  totalPagesEl.textContent = Math.max(1, Math.ceil(selectedMembers.size / 4));
}

// ========== PRINT FUNCTIONS ==========
function openPrintPreview() {
  if (selectedMembers.size === 0) { alert('Please select at least one member to print.'); return; }
  printPreviewModal.style.display = 'flex'; 
  printSection.innerHTML = '';
  
  Array.from(selectedMembers).forEach(id => {
    const m = allMembers.find(x => x.id === id); 
    if (m) {
      const expiryDate = m.expiry_date || new Date(Date.now() + 365*24*60*60*1000).toISOString().split('T')[0];
      const memberId = m.member_id || `MKA-UG-${m.id}`;
      
      // Print both front and back
      printSection.innerHTML += `
        <!-- FRONT -->
        <div class="print-card">
          <div class="print-flag-bar">
            <div class="print-flag-stripe print-flag-black"></div>
            <div class="print-flag-stripe print-flag-yellow"></div>
            <div class="print-flag-stripe print-flag-red"></div>
            <div class="print-emblem">ðŸ•Š</div>
          </div>
          <div class="print-header-title">MKA Uganda</div>
          <div class="print-logo"></div>
          <div class="print-photo">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="18mm" height="18mm">
              <circle cx="32" cy="20" r="12" fill="#004080"/>
              <path d="M8 58c0-13 10-24 24-24s24 11 24 24H8z" fill="#004080"/>
            </svg>
          </div>
          <div class="print-section"><span class="print-label">Name:</span> ${m.full_name || 'Member'}</div>
          <div class="print-section"><span class="print-label">ID No.:</span> ${memberId}</div>
          <div class="print-section"><span class="print-label">Position:</span> ${m.position || 'Member'}</div>
          <div class="print-section"><span class="print-accent">Department:</span> ${m.department || 'Security'}</div>
          <div class="print-section"><span class="print-accent">Region:</span> ${m.region || 'Uganda'}</div>
          <div class="print-section"><span class="print-label">Valid Until:</span> ${formatExpiryDate(expiryDate)}</div>
          <div class="print-qr">
            <div class="print-qr-container" id="print-qr-${m.id}"></div>
            <div>SCAN TO VERIFY</div>
          </div>
          <div class="print-barcode">
            <div class="print-barcode-container">
              <svg id="print-barcode-${m.id}"></svg>
            </div>
          </div>
        </div>
        
        <!-- BACK -->
        <div class="print-card">
          <div class="print-flag-bar">
            <div class="print-flag-stripe print-flag-black"></div>
            <div class="print-flag-stripe print-flag-yellow"></div>
            <div class="print-flag-stripe print-flag-red"></div>
            <div class="print-emblem">ðŸ•Š</div>
          </div>
          <div class="print-header-title">MKA Uganda</div>
          <div class="print-logo"></div>
          <div class="print-back-text">
            This card certifies that the bearer is a member of Majlis Khuddam-ul-Ahmadiyya Uganda.
          </div>
          <div class="print-section"><span class="print-label">Helpdesk:</span> +256 123 456 789</div>
          <div class="print-section"><span class="print-label">Website:</span> www.mka.ug</div>
          <div class="print-barcode">
            <div class="print-barcode-container">
              <svg id="print-barcode-back-${m.id}"></svg>
            </div>
          </div>
          <div class="print-qr">
            <div class="print-qr-container" id="print-qr-back-${m.id}" style="width:40px; height:40px;"></div>
            <div>SCAN TO VERIFY</div>
          </div>
          <div class="print-contacts">
            <div class="print-contact-block">
              <span class="print-label">Emergency Contact 1:</span><br>
              Name: <span class="print-handwrite"></span><br>
              Phone: <span class="print-handwrite"></span>
            </div>
            <div class="print-contact-block">
              <span class="print-label">Emergency Contact 2:</span><br>
              Name: <span class="print-handwrite"></span><br>
              Phone: <span class="print-handwrite"></span>
            </div>
          </div>
        </div>
      `;
      
      setTimeout(() => {
        // Front QR
        const printQr = document.getElementById(`print-qr-${m.id}`);
        if (printQr) {
          printQr.innerHTML = '';
          new QRCode(printQr, { text: memberId, width: 30, height: 30, correctLevel: QRCode.CorrectLevel.M });
        }
        
        // Back QR
        const printQrBack = document.getElementById(`print-qr-back-${m.id}`);
        if (printQrBack) {
          printQrBack.innerHTML = '';
          new QRCode(printQrBack, { text: memberId, width: 40, height: 40, correctLevel: QRCode.CorrectLevel.M });
        }
        
        // Front Barcode
        const printBarcode = document.getElementById(`print-barcode-${m.id}`);
        if (printBarcode) {
          JsBarcode(printBarcode, memberId, {
            format: "CODE128", width: 1.0, height: 15, displayValue: false, margin: 0
          });
        }
        
        // Back Barcode
        const printBarcodeBack = document.getElementById(`print-barcode-back-${m.id}`);
        if (printBarcodeBack) {
          JsBarcode(printBarcodeBack, memberId, {
            format: "CODE128", width: 1.0, height: 15, displayValue: false, margin: 0
          });
        }
      }, 80);
    }
  });
}

function closePrintPreview() { printPreviewModal.style.display = 'none'; }
function printSelected() { 
  if (selectedMembers.size === 0) { alert('Please select members first.'); return; }
  openPrintPreview(); 
  setTimeout(() => window.print(), 400); 
}

// ========== PDF EXPORT FUNCTIONS ==========
async function exportSelectedPDF() {
  if (selectedMembers.size === 0) { alert('Please select at least one member to export.'); return; }
  
  pdfExportModal.style.display = 'flex';
  pdfPreview.innerHTML = '<p style="color:#5a7a95"><i class="fas fa-spinner fa-spin"></i> Generating PDF preview...</p>';
  downloadPDFBtn.disabled = true;
  
  try {
    const pdfContainer = document.createElement('div');
    pdfContainer.style.cssText = 'position:absolute; left:-9999px; top:-9999px; width:210mm; background:white;';
    
    const cards = [];
    
    for (const id of selectedMembers) {
      const m = allMembers.find(x => x.id === id);
      if (!m) continue;
      
      const expiryDate = m.expiry_date || new Date(Date.now() + 365*24*60*60*1000).toISOString().split('T')[0];
      const memberId = m.member_id || `MKA-UG-${m.id}`;
      
      // PDF Card HTML - FRONT
      const cardFrontHTML = `
        <div style="width:210mm; min-height:297mm; padding:15mm; box-sizing:border-box; page-break-after:always; display:flex; align-items:center; justify-content:center;">
          <div style="width:55mm; height:85mm; border:2px solid #004080; border-radius:6px; background:linear-gradient(to bottom, #ffffff, #f0f6ff); padding:8px; position:relative; overflow:hidden; display:flex; flex-direction:column;">
            <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%) rotate(-30deg); font-size:18pt; color:rgba(0,64,128,0.08); font-weight:bold; white-space:nowrap; z-index:0;">MKA UGANDA</div>
            
            <!-- Flag bar -->
            <div style="height:12mm; border-radius:4px 4px 0 0; display:flex; flex-direction:column; overflow:hidden; position:relative; z-index:1;">
              <div style="flex:1; background:#000000;"></div>
              <div style="flex:1; background:#ffcd00;"></div>
              <div style="flex:1; background:#d00000;"></div>
              <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); width:12mm; height:12mm; background:#fff; border-radius:50%; border:2px solid #000; display:flex; align-items:center; justify-content:center; font-size:8pt; font-weight:bold; color:#000; z-index:2;">ðŸ•Š</div>
            </div>
            
            <!-- Title -->
            <div style="text-align:center; font-size:11pt; font-weight:bold; margin:6px 0; color:#004080; z-index:1;">MKA Uganda</div>
            
            <!-- Logo -->
            <div style="width:18mm; height:18mm; margin:6px auto; background:url('data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 64 64\'><circle cx=\'32\' cy=\'20\' r=\'12\' fill=\'%23004080\'/><path d=\'M8 58c0-13 10-24 24-24s24 11 24 24H8z\' fill=\'%23004080\'/></svg>') no-repeat center; background-size:contain; z-index:1;"></div>
            
            <!-- Photo -->
            <div style="width:28mm; height:34mm; margin:0 auto 6px auto; background:#f0f0f0; display:flex; align-items:center; justify-content:center; border:2px solid #004080; border-radius:4px; z-index:1;">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="18mm" height="18mm">
                <circle cx="32" cy="20" r="12" fill="#004080"/>
                <path d="M8 58c0-13 10-24 24-24s24 11 24 24H8z" fill="#004080"/>
              </svg>
            </div>
            
            <!-- Details -->
            <div style="font-size:9pt; margin:2px 0; color:#222; z-index:1;"><span style="font-weight:bold; color:#004080;">Name:</span> ${m.full_name || 'Member'}</div>
            <div style="font-size:9pt; margin:2px 0; color:#222; z-index:1;"><span style="font-weight:bold; color:#004080;">ID No.:</span> ${memberId}</div>
            <div style="font-size:9pt; margin:2px 0; color:#222; z-index:1;"><span style="font-weight:bold; color:#004080;">Position:</span> ${m.position || 'Member'}</div>
            <div style="font-size:9pt; margin:2px 0; color:#222; z-index:1;"><span style="font-weight:bold; color:#b8860b;">Department:</span> ${m.department || 'Security'}</div>
            <div style="font-size:9pt; margin:2px 0; color:#222; z-index:1;"><span style="font-weight:bold; color:#b8860b;">Region:</span> ${m.region || 'Uganda'}</div>
            <div style="font-size:9pt; margin:2px 0; color:#222; z-index:1;"><span style="font-weight:bold; color:#004080;">Valid Until:</span> ${formatExpiryDate(expiryDate)}</div>
            
            <!-- QR and Barcode -->
            <div style="text-align:center; font-size:8pt; margin-top:4px; color:#004080; z-index:1;">
              <div id="pdf-qr-${m.id}" style="width:30px; height:30px; margin:0 auto 2px;"></div>
              <div>SCAN TO VERIFY</div>
            </div>
            <div style="text-align:center; font-size:8pt; color:#004080; z-index:1;">
              <div style="max-width:100%;">
                <svg id="pdf-barcode-${m.id}" style="max-width:100%; height:15px;"></svg>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // PDF Card HTML - BACK
      const cardBackHTML = `
        <div style="width:210mm; min-height:297mm; padding:15mm; box-sizing:border-box; page-break-after:always; display:flex; align-items:center; justify-content:center;">
          <div style="width:55mm; height:85mm; border:2px solid #004080; border-radius:6px; background:linear-gradient(to bottom, #ffffff, #f0f6ff); padding:8px; position:relative; overflow:hidden; display:flex; flex-direction:column;">
            <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%) rotate(-30deg); font-size:18pt; color:rgba(0,64,128,0.08); font-weight:bold; white-space:nowrap; z-index:0;">MKA UGANDA</div>
            
            <!-- Flag bar -->
            <div style="height:12mm; border-radius:4px 4px 0 0; display:flex; flex-direction:column; overflow:hidden; position:relative; z-index:1;">
              <div style="flex:1; background:#000000;"></div>
              <div style="flex:1; background:#ffcd00;"></div>
              <div style="flex:1; background:#d00000;"></div>
              <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); width:12mm; height:12mm; background:#fff; border-radius:50%; border:2px solid #000; display:flex; align-items:center; justify-content:center; font-size:8pt; font-weight:bold; color:#000; z-index:2;">ðŸ•Š</div>
            </div>
            
            <!-- Title -->
            <div style="text-align:center; font-size:11pt; font-weight:bold; margin:6px 0; color:#004080; z-index:1;">MKA Uganda</div>
            
            <!-- Logo -->
            <div style="width:18mm; height:18mm; margin:6px auto; background:url('data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 64 64\'><circle cx=\'32\' cy=\'20\' r=\'12\' fill=\'%23004080\'/><path d=\'M8 58c0-13 10-24 24-24s24 11 24 24H8z\' fill=\'%23004080\'/></svg>') no-repeat center; background-size:contain; z-index:1;"></div>
            
            <!-- Back Text -->
            <div style="font-size:8pt; margin:4px 0; text-align:center; color:#333; z-index:1;">
              This card certifies that the bearer is a member of Majlis Khuddam-ul-Ahmadiyya Uganda.
            </div>
            
            <!-- Contact Info -->
            <div style="font-size:9pt; margin:2px 0; color:#222; z-index:1;"><span style="font-weight:bold; color:#004080;">Helpdesk:</span> +256 123 456 789</div>
            <div style="font-size:9pt; margin:2px 0; color:#222; z-index:1;"><span style="font-weight:bold; color:#004080;">Website:</span> www.mka.ug</div>
            
            <!-- Barcode -->
            <div style="text-align:center; font-size:8pt; color:#004080; z-index:1;">
              <div style="max-width:100%;">
                <svg id="pdf-barcode-back-${m.id}" style="max-width:100%; height:15px;"></svg>
              </div>
            </div>
            
            <!-- QR Code (larger) -->
            <div style="text-align:center; font-size:8pt; margin-top:4px; color:#004080; z-index:1;">
              <div id="pdf-qr-back-${m.id}" style="width:40px; height:40px; margin:0 auto 2px;"></div>
              <div>SCAN TO VERIFY</div>
            </div>
            
            <!-- Emergency Contacts -->
            <div style="font-size:8pt; margin-top:4px; display:flex; flex-direction:column; gap:4px; z-index:1;">
              <div style="border:1px solid #004080; border-radius:4px; padding:3px; background:#f9f9f9;">
                <span style="font-weight:bold; color:#004080;">Emergency Contact 1:</span><br>
                Name: <span style="border-bottom:1px dotted #333; display:inline-block; min-width:20mm;"></span><br>
                Phone: <span style="border-bottom:1px dotted #333; display:inline-block; min-width:20mm;"></span>
              </div>
              <div style="border:1px solid #004080; border-radius:4px; padding:3px; background:#f9f9f9;">
                <span style="font-weight:bold; color:#004080;">Emergency Contact 2:</span><br>
                Name: <span style="border-bottom:1px dotted #333; display:inline-block; min-width:20mm;"></span><br>
                Phone: <span style="border-bottom:1px dotted #333; display:inline-block; min-width:20mm;"></span>
              </div>
            </div>
          </div>
        </div>
      `;
      
      cards.push({ member: m, frontHTML: cardFrontHTML, backHTML: cardBackHTML, id: m.id });
    }
    
    // Add both front and back for each card
    cards.forEach(c => {
      pdfContainer.innerHTML += c.frontHTML;
      pdfContainer.innerHTML += c.backHTML;
    });
    document.body.appendChild(pdfContainer);
    
    await new Promise(resolve => setTimeout(resolve, 500));
    
    cards.forEach(c => {
      const memberId = c.member.member_id || `MKA-UG-${c.id}`;
      
      // Front QR
      const qrEl = document.getElementById(`pdf-qr-${c.id}`);
      if (qrEl) {
        qrEl.innerHTML = '';
        new QRCode(qrEl, { text: memberId, width: 30, height: 30, correctLevel: QRCode.CorrectLevel.M });
      }
      
      // Back QR
      const qrBackEl = document.getElementById(`pdf-qr-back-${c.id}`);
      if (qrBackEl) {
        qrBackEl.innerHTML = '';
        new QRCode(qrBackEl, { text: memberId, width: 40, height: 40, correctLevel: QRCode.CorrectLevel.M });
      }
      
      // Front Barcode
      const barcodeEl = document.getElementById(`pdf-barcode-${c.id}`);
      if (barcodeEl) {
        JsBarcode(barcodeEl, memberId, {
          format: "CODE128", width: 1.0, height: 15, displayValue: false, margin: 0
        });
      }
      
      // Back Barcode
      const barcodeBackEl = document.getElementById(`pdf-barcode-back-${c.id}`);
      if (barcodeBackEl) {
        JsBarcode(barcodeBackEl, memberId, {
          format: "CODE128", width: 1.0, height: 15, displayValue: false, margin: 0
        });
      }
    });
    
    await new Promise(resolve => setTimeout(resolve, 800));
    
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
    const pageWidth = 210;
    const pageHeight = 297;
    
    for (let i = 0; i < cards.length * 2; i++) { // *2 for front and back
      if (i > 0) pdf.addPage();
      
      const cardEl = pdfContainer.children[i];
      const canvas = await html2canvas(cardEl, { 
        scale: 2, 
        useCORS: true,
        backgroundColor: '#ffffff',
        logging: false
      });
      
      const imgData = canvas.toDataURL('image/png');
      const imgWidth = 180;
      const imgHeight = (canvas.height * imgWidth) / canvas.width;
      
      const x = (pageWidth - imgWidth) / 2;
      const y = (pageHeight - imgHeight) / 2;
      
      pdf.addImage(imgData, 'PNG', x, y, imgWidth, imgHeight);
    }
    
    generatedPDF = pdf.output('blob');
    
    const previewCanvas = await html2canvas(pdfContainer.children[0], { scale: 1.5, useCORS: true });
    pdfPreview.innerHTML = `<img src="${previewCanvas.toDataURL('image/png')}" alt="PDF Preview">`;
    downloadPDFBtn.disabled = false;
    
    document.body.removeChild(pdfContainer);
    
  } catch (err) {
    console.error('PDF generation error:', err);
    pdfPreview.innerHTML = `<p style="color:#dc3545"><i class="fas fa-exclamation-circle"></i> Error generating PDF: ${err.message}</p>`;
  }
}

function closePDFExport() { 
  pdfExportModal.style.display = 'none'; 
  generatedPDF = null;
}

function downloadPDF() {
  if (!generatedPDF) { alert('PDF not ready. Please try again.'); return; }
  const url = URL.createObjectURL(generatedPDF);
  const a = document.createElement('a');
  a.href = url;
  a.download = `MKA-Uganda-ID-Cards-${new Date().toISOString().split('T')[0]}.pdf`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

[printPreviewModal, pdfExportModal].forEach(modal => {
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      if (modal === printPreviewModal) closePrintPreview();
      else closePDFExport();
    }
  });
});
</script>

</body>
</html>