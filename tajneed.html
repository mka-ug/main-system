<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tajneed Department • MKA Uganda</title>
<!-- Fonts & Icons -->
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600;700&family=Libre+Franklin:wght@300;400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root {
--tajneed-blue: #1e3a5f;
--tajneed-gold: #c6a43c;
--cream: #FAF9F5;
--border: #E8E2D9;
--success: #28a745;
--danger: #dc3545;
--warning: #ffc107;
--info: #17a2b8;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Libre Franklin', sans-serif; background: var(--cream); color: #2d2d2d; min-height: 100vh; }

/* Header */
header { background: var(--tajneed-blue); border-bottom: 3px solid var(--tajneed-gold); color: white; padding: 1rem 2rem; position: sticky; top: 0; z-index: 100; }
.header-container { display: flex; align-items: center; justify-content: space-between; max-width: 1400px; margin: 0 auto; flex-wrap: wrap; gap: 15px; }
.logo { font-family: 'Cormorant Garamond', serif; font-size: 1.8rem; display: flex; align-items: center; gap: 12px; color: white; text-decoration: none; }
.logo i { color: var(--tajneed-gold); }
.logo small { font-size: 0.75rem; color: var(--tajneed-gold); letter-spacing: 1px; display: block; margin-top: -3px; }

/* Action Buttons */
.action-bar { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
.region-selector { background: rgba(255,255,255,0.1); padding: 8px 16px; border-radius: 30px; display: flex; align-items: center; gap: 10px; }
.region-selector select { background: white; color: var(--tajneed-blue); border: none; padding: 8px 15px; border-radius: 20px; font-weight: 600; min-width: 180px; cursor: pointer; }
.btn { padding: 10px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: all 0.3s; font-size: 0.95rem; }
.btn-primary { background: var(--tajneed-gold); color: var(--tajneed-blue); }
.btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
.btn-success { background: var(--success); color: white; }
.btn-success:hover { background: #218838; transform: translateY(-2px); }
.btn-info { background: var(--info); color: white; }
.btn-info:hover { background: #138496; transform: translateY(-2px); }
.btn-outline { background: transparent; border: 2px solid white; color: white; }
.btn-outline:hover { background: white; color: var(--tajneed-blue); }
.btn-refresh { background: rgba(255,255,255,0.2); color: white; }
.btn-refresh:hover { background: rgba(255,255,255,0.3); }

/* Main Content */
.main { max-width: 1400px; margin: 0 auto; padding: 30px 20px; }

/* Welcome Banner */
.welcome-banner { background: linear-gradient(135deg, var(--tajneed-blue) 0%, #0a1f33 100%); color: white; padding: 25px 30px; border-radius: 15px; margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; }
.welcome-banner h1 { font-family: 'Cormorant Garamond', serif; font-size: 2rem; display: flex; align-items: center; gap: 10px; }
.welcome-banner h1 i { color: var(--tajneed-gold); }
.region-badge { background: var(--tajneed-gold); color: var(--tajneed-blue); padding: 8px 20px; border-radius: 40px; font-size: 1rem; font-weight: 700; }
.last-updated { font-size: 0.85rem; opacity: 0.9; margin-top: 3px; }

/* Stats Grid */
.stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 25px; }
.stat-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-left: 4px solid var(--tajneed-gold); }
.stat-card .stat-icon { font-size: 1.5rem; color: var(--tajneed-gold); margin-bottom: 10px; }
.stat-card .stat-label { font-size: 0.85rem; color: #777; text-transform: uppercase; letter-spacing: 0.5px; }
.stat-card .stat-value { font-size: 1.8rem; font-weight: 700; color: var(--tajneed-blue); font-family: 'Cormorant Garamond', serif; }
.stat-card .stat-sub { font-size: 0.75rem; color: #999; margin-top: 3px; }

/* Section Card */
.section-card { background: white; border-radius: 15px; padding: 25px; margin-bottom: 25px; box-shadow: 0 3px 10px rgba(0,0,0,0.05); }
.section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
.section-header h2 { font-family: 'Cormorant Garamond', serif; font-size: 1.6rem; color: var(--tajneed-blue); display: flex; align-items: center; gap: 10px; }
.section-header h2 i { color: var(--tajneed-gold); }

/* Filters */
.filters-bar { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; background: #f8f9fa; padding: 15px; border-radius: 10px; }
.filter-group { flex: 1; min-width: 180px; }
.filter-group label { display: block; font-size: 0.8rem; color: #777; margin-bottom: 5px; }
.filter-group select, .filter-group input { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 0.95rem; }

/* Table */
.table-responsive { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; }
th { background: var(--tajneed-blue); color: white; font-weight: 600; padding: 12px 15px; text-align: left; font-size: 0.85rem; text-transform: uppercase; }
td { padding: 12px 15px; border-bottom: 1px solid var(--border); font-size: 0.95rem; }
tr:hover { background: rgba(198, 164, 60, 0.05); }
.status-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; display: inline-block; }
.status-badge.active { background: #e8f5e9; color: #2e7d32; }
.status-badge.inactive { background: #ffebee; color: #c62828; }
.status-badge.suspended { background: #fff3e0; color: #ef6c00; }
.age-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
.age-badge.khuddam { background: #d1e7ff; color: #0d47a1; }
.age-badge.atfal { background: #fff9c4; color: #f57f17; }
.action-btn { padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; display: inline-flex; align-items: center; gap: 5px; transition: all 0.2s; margin-right: 5px; }
.action-btn.view { background: var(--tajneed-blue); color: white; }
.action-btn.edit { background: var(--tajneed-gold); color: var(--tajneed-blue); }
.action-btn.delete { background: var(--danger); color: white; }
.action-btn:hover { transform: translateY(-1px); opacity: 0.9; }

/* Loading */
.loading-spinner { text-align: center; padding: 40px; }
.loading-spinner i { font-size: 2.5rem; color: var(--tajneed-gold); animation: spin 1s linear infinite; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

/* Notification */
.notification { position: fixed; top: 20px; right: 20px; padding: 15px 25px; background: white; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); display: none; z-index: 1000; border-left: 4px solid var(--tajneed-gold); }
.notification.show { display: block; animation: slideIn 0.3s ease; }
@keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
.notification.success { border-left-color: var(--success); }
.notification.error { border-left-color: var(--danger); }

/* Modal */
.modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; align-items: center; justify-content: center; padding: 20px; }
.modal.show { display: flex; }
.modal-content { background: white; border-radius: 15px; width: 100%; max-width: 900px; max-height: 90vh; overflow-y: auto; }
.modal-content.large { max-width: 1200px; }
.modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 25px; border-bottom: 1px solid var(--border); position: sticky; top: 0; background: white; z-index: 10; }
.modal-header h3 { font-family: 'Cormorant Garamond', serif; font-size: 1.5rem; color: var(--tajneed-blue); display: flex; align-items: center; gap: 10px; }
.modal-header h3 i { color: var(--tajneed-gold); }
.modal-close { background: none; border: none; font-size: 1.5rem; color: #999; cursor: pointer; }
.modal-close:hover { color: var(--danger); }
.modal-body { padding: 25px; }
.modal-footer { display: flex; justify-content: flex-end; gap: 10px; padding: 15px 25px; border-top: 1px solid var(--border); position: sticky; bottom: 0; background: white; }

/* Form */
.form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
.form-group { margin-bottom: 5px; }
.form-group.full-width { grid-column: span 2; }
.form-group label { display: block; font-weight: 600; color: var(--tajneed-blue); margin-bottom: 6px; font-size: 0.9rem; }
.form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 0.95rem; transition: border-color 0.3s; }
.form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--tajneed-gold); }
.form-group input[readonly] { background: #e9ecef; cursor: not-allowed; }

/* Reports Section */
.reports-nav { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; border-bottom: 2px solid var(--border); padding-bottom: 10px; }
.report-nav-btn { padding: 10px 20px; background: transparent; border: 2px solid var(--tajneed-gold); color: var(--tajneed-blue); border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
.report-nav-btn:hover, .report-nav-btn.active { background: var(--tajneed-gold); color: white; }
.report-nav-btn i { margin-right: 8px; }

.report-section { display: none; }
.report-section.active { display: block; }

/* Report Filters */
.report-filters { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
.report-filters h4 { color: var(--tajneed-blue); margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
.report-filters h4 i { color: var(--tajneed-gold); }
.filter-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
.filter-row:last-child { margin-bottom: 0; }

/* Report Cards Grid */
.reports-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
.report-card { background: white; border-radius: 12px; padding: 20px; border-left: 4px solid var(--tajneed-gold); box-shadow: 0 2px 8px rgba(0,0,0,0.05); cursor: pointer; transition: all 0.3s; }
.report-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
.report-card i { font-size: 2rem; color: var(--tajneed-gold); margin-bottom: 15px; }
.report-card h4 { font-weight: 600; color: var(--tajneed-blue); margin-bottom: 8px; }
.report-card p { font-size: 0.9rem; color: #666; }

/* Report Results */
.report-results { background: white; border-radius: 12px; padding: 20px; margin-top: 20px; }
.report-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
.summary-item { background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; }
.summary-item .value { font-size: 1.8rem; font-weight: 700; color: var(--tajneed-blue); font-family: 'Cormorant Garamond', serif; }
.summary-item .label { font-size: 0.85rem; color: #666; margin-top: 5px; }
.report-charts { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
.chart-box { background: #f8f9fa; padding: 15px; border-radius: 8px; height: 300px; position: relative; }
.chart-box h5 { color: var(--tajneed-blue); margin-bottom: 10px; font-size: 0.95rem; }
.chart-box canvas { max-height: 250px; width: 100% !important; height: auto !important; }

/* Responsive */
@media (max-width: 1024px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } .form-grid { grid-template-columns: 1fr; } .form-group.full-width { grid-column: span 1; } }
@media (max-width: 768px) { .stats-grid { grid-template-columns: 1fr; } .header-container { flex-direction: column; align-items: stretch; } .welcome-banner { flex-direction: column; text-align: center; } .action-bar { justify-content: center; } .modal-content { max-width: 95%; } }
</style>
</head>
<body>
<div id="notification" class="notification"></div>

<!-- Header -->
<header>
<div class="header-container">
<a href="#" class="logo">
<i class="fas fa-address-book"></i>
<div>
TAJNEED DEPARTMENT
<small>MEMBERSHIP • ENROLLMENT • RECORDS</small>
</div>
</a>
<div class="action-bar">
<div class="region-selector">
<i class="fas fa-map-marker-alt" style="color: var(--tajneed-gold);"></i>
<select id="regionSelector" onchange="switchRegion()">
<option value="">All Regions (National)</option>
</select>
</div>
<button class="btn btn-refresh" onclick="loadAllData()"><i class="fas fa-sync-alt"></i> Refresh</button>
<button class="btn btn-primary" onclick="openAddModal()"><i class="fas fa-user-plus"></i> Add Member</button>
<button class="btn btn-info" onclick="openReportsModal()"><i class="fas fa-chart-bar"></i> Reports</button>
</div>
</div>
</header>

<!-- Main Content -->
<div class="main">
<!-- Welcome Banner -->
<div class="welcome-banner">
<div>
<h1><i class="fas fa-users"></i> Member Directory</h1>
<div class="last-updated" id="lastUpdated">Loading...</div>
</div>
<div class="region-badge" id="currentRegionDisplay">All Regions</div>
</div>

<!-- Stats Grid -->
<div class="stats-grid">
<div class="stat-card">
<div class="stat-icon"><i class="fas fa-user"></i></div>
<div class="stat-label">Total Khuddam (14+)</div>
<div class="stat-value" id="statKhuddam">0</div>
<div class="stat-sub">Above 14 years</div>
</div>
<div class="stat-card">
<div class="stat-icon"><i class="fas fa-child"></i></div>
<div class="stat-label">Total Atfal (0-15)</div>
<div class="stat-value" id="statAtfal">0</div>
<div class="stat-sub">Below 15 years</div>
</div>
<div class="stat-card">
<div class="stat-icon"><i class="fas fa-people-group"></i></div>
<div class="stat-label">Total Members</div>
<div class="stat-value" id="statTotal">0</div>
<div class="stat-sub">All ages</div>
</div>
<div class="stat-card">
<div class="stat-icon"><i class="fas fa-map-pin"></i></div>
<div class="stat-label">Active Subregions</div>
<div class="stat-value" id="statSubregions">0</div>
<div class="stat-sub">With members</div>
</div>
</div>

<!-- Members Section -->
<div class="section-card">
<div class="section-header">
<h2><i class="fas fa-list"></i> All Members</h2>
</div>
<div class="filters-bar">
<div class="filter-group">
<label>Search</label>
<input type="text" id="memberSearch" placeholder="Name, ID, phone..." oninput="filterMembers()">
</div>
<div class="filter-group">
<label>Subregion</label>
<select id="subregionFilter" onchange="filterMembers()">
<option value="all">All Subregions</option>
</select>
</div>
<div class="filter-group">
<label>Status</label>
<select id="statusFilter" onchange="filterMembers()">
<option value="all">All Status</option>
<option value="Active">Active</option>
<option value="Inactive">Inactive</option>
<option value="Suspended">Suspended</option>
</select>
</div>
</div>
<div class="table-responsive">
<table>
<thead>
<tr>
<th>Member ID</th>
<th>Full Name</th>
<th>Age Group</th>
<th>Subregion</th>
<th>Region</th>
<th>Phone</th>
<th>Status</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="membersTable">
<tr><td colspan="8" class="loading-spinner"><i class="fas fa-spinner fa-pulse"></i> Loading members...</td></tr>
</tbody>
</table>
</div>
</div>
</div>

<!-- Add Member Modal -->
<div id="addModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h3><i class="fas fa-user-plus"></i> Register New Member</h3>
<button class="modal-close" onclick="closeAddModal()">&times;</button>
</div>
<div class="modal-body">
<form id="enrollmentForm" class="form-grid">
<div class="form-group full-width">
<label>Full Name *</label>
<input type="text" id="fullName" required placeholder="Enter full name">
</div>
<div class="form-group">
<label>Member ID (Auto)</label>
<input type="text" id="memberId" readonly placeholder="Generated on submit" style="background:#e9ecef;cursor:not-allowed;">
</div>
<div class="form-group">
<label>Date of Birth *</label>
<input type="date" id="dob" required onchange="previewAgeGroup()">
</div>
<div class="form-group">
<label>Phone</label>
<input type="tel" id="phone" placeholder="e.g., 0772 123456">
</div>
<div class="form-group">
<label>Email</label>
<input type="email" id="email" placeholder="name@example.com">
</div>
<div class="form-group">
<label>Region *</label>
<select id="region" required onchange="loadSubregionsForForm()">
<option value="">Select Region</option>
</select>
</div>
<div class="form-group">
<label>Subregion (Qiadat) *</label>
<select id="qiadatId" required>
<option value="">Select Subregion</option>
</select>
</div>
<div class="form-group">
<label>Department</label>
<select id="departmentId">
<option value="">Select Department</option>
</select>
</div>
<div class="form-group">
<label>Position</label>
<input type="text" id="position" placeholder="e.g., Muhtamim">
</div>
<div class="form-group">
<label>Status</label>
<select id="status">
<option value="Active">Active</option>
<option value="Inactive">Inactive</option>
<option value="Suspended">Suspended</option>
</select>
</div>
<div class="form-group full-width">
<label>Address</label>
<textarea id="address" rows="2" placeholder="Physical address"></textarea>
</div>
<div class="form-group full-width">
<label>Age Group (Auto)</label>
<div style="background:#f8f9fa;padding:12px;border-radius:8px;border-left:4px solid var(--tajneed-gold);display:flex;align-items:center;gap:12px;">
<i class="fas fa-user" id="ageIcon" style="color:var(--tajneed-gold);font-size:1.3rem;"></i>
<div>
<div style="font-weight:600;" id="ageGroupDisplay">Not calculated</div>
<div style="font-size:0.85rem;color:#666;" id="ageDescDisplay">Enter DOB to calculate</div>
</div>
</div>
</div>
</form>
</div>
<div class="modal-footer">
<button class="btn" style="background:#6c757d;color:white;" onclick="closeAddModal()">Cancel</button>
<button class="btn btn-success" onclick="submitMemberForm()"><i class="fas fa-save"></i> Register Member</button>
</div>
</div>
</div>

<!-- Reports Modal -->
<div id="reportsModal" class="modal">
<div class="modal-content large">
<div class="modal-header">
<h3><i class="fas fa-chart-pie"></i> Advanced Reports & Analytics</h3>
<button class="modal-close" onclick="closeReportsModal()">&times;</button>
</div>
<div class="modal-body">
<!-- Report Navigation -->
<div class="reports-nav">
<button class="report-nav-btn active" onclick="showReportSection('overview')"><i class="fas fa-home"></i>Overview</button>
<button class="report-nav-btn" onclick="showReportSection('members')"><i class="fas fa-users"></i>Members Report</button>
<button class="report-nav-btn" onclick="showReportSection('age')"><i class="fas fa-birthday-cake"></i>Age Report</button>
<button class="report-nav-btn" onclick="showReportSection('region')"><i class="fas fa-map-marked-alt"></i>Region Report</button>
<button class="report-nav-btn" onclick="showReportSection('status')"><i class="fas fa-clipboard-list"></i>Status Report</button>
<button class="report-nav-btn" onclick="showReportSection('department')"><i class="fas fa-sitemap"></i>Department Report</button>
<button class="report-nav-btn" onclick="showReportSection('custom')"><i class="fas fa-sliders-h"></i>Custom Report</button>
</div>

<!-- Overview Report -->
<div id="overviewReport" class="report-section active">
<div class="report-summary">
<div class="summary-item">
<div class="value" id="ovTotal">0</div>
<div class="label">Total Members</div>
</div>
<div class="summary-item">
<div class="value" id="ovKhuddam">0</div>
<div class="label">Khuddam (14+)</div>
</div>
<div class="summary-item">
<div class="value" id="ovAtfal">0</div>
<div class="label">Atfal (0-15)</div>
</div>
<div class="summary-item">
<div class="value" id="ovActive">0</div>
<div class="label">Active</div>
</div>
<div class="summary-item">
<div class="value" id="ovRegions">0</div>
<div class="label">Regions</div>
</div>
<div class="summary-item">
<div class="value" id="ovSubregions">0</div>
<div class="label">Subregions</div>
</div>
</div>
<div class="report-charts">
<div class="chart-box">
<h5><i class="fas fa-chart-pie"></i> Age Distribution</h5>
<canvas id="ovAgeChart"></canvas>
</div>
<div class="chart-box">
<h5><i class="fas fa-chart-bar"></i> Members by Region</h5>
<canvas id="ovRegionChart"></canvas>
</div>
</div>
<div style="text-align:center;margin-top:20px;">
<button class="btn btn-primary" onclick="exportOverviewReport()"><i class="fas fa-download"></i> Export Overview PDF</button>
</div>
</div>

<!-- Members Report -->
<div id="membersReport" class="report-section">
<div class="report-filters">
<h4><i class="fas fa-filter"></i> Filter Members Report</h4>
<div class="filter-row">
<div class="filter-group">
<label>Region</label>
<select id="mrRegion" onchange="generateMembersReport()">
<option value="all">All Regions</option>
</select>
</div>
<div class="filter-group">
<label>Subregion</label>
<select id="mrSubregion" onchange="generateMembersReport()">
<option value="all">All Subregions</option>
</select>
</div>
<div class="filter-group">
<label>Age Group</label>
<select id="mrAgeGroup" onchange="generateMembersReport()">
<option value="all">All Age Groups</option>
<option value="khuddam">Khuddam (14+)</option>
<option value="atfal">Atfal (0-15)</option>
</select>
</div>
<div class="filter-group">
<label>Status</label>
<select id="mrStatus" onchange="generateMembersReport()">
<option value="all">All Status</option>
<option value="Active">Active</option>
<option value="Inactive">Inactive</option>
<option value="Suspended">Suspended</option>
</select>
</div>
</div>
<div class="filter-row">
<div class="filter-group">
<label>Date Joined From</label>
<input type="date" id="mrDateFrom" onchange="generateMembersReport()">
</div>
<div class="filter-group">
<label>Date Joined To</label>
<input type="date" id="mrDateTo" onchange="generateMembersReport()">
</div>
<div class="filter-group">
<label>Search</label>
<input type="text" id="mrSearch" placeholder="Name, ID, phone..." oninput="generateMembersReport()">
</div>
<div class="filter-group">
<label>Department</label>
<select id="mrDepartment" onchange="generateMembersReport()">
<option value="all">All Departments</option>
</select>
</div>
</div>
</div>
<div class="report-results">
<div class="report-summary" id="mrSummary"></div>
<div class="table-responsive">
<table id="mrTable">
<thead>
<tr>
<th>Member ID</th>
<th>Full Name</th>
<th>Age</th>
<th>Region</th>
<th>Subregion</th>
<th>Department</th>
<th>Status</th>
<th>Date Joined</th>
</tr>
</thead>
<tbody id="mrTableBody"></tbody>
</table>
</div>
<div style="text-align:center;margin-top:20px;">
<button class="btn btn-success" onclick="exportMembersReport()"><i class="fas fa-file-csv"></i> Export to CSV</button>
<button class="btn btn-primary" onclick="printMembersReport()"><i class="fas fa-print"></i> Print Report</button>
</div>
</div>
</div>

<!-- Age Report -->
<div id="ageReport" class="report-section">
<div class="report-filters">
<h4><i class="fas fa-filter"></i> Filter Age Report</h4>
<div class="filter-row">
<div class="filter-group">
<label>Region</label>
<select id="arRegion" onchange="generateAgeReport()">
<option value="all">All Regions</option>
</select>
</div>
<div class="filter-group">
<label>Subregion</label>
<select id="arSubregion" onchange="generateAgeReport()">
<option value="all">All Subregions</option>
</select>
</div>
</div>
</div>
<div class="report-results">
<div class="report-summary" id="arSummary"></div>
<div class="report-charts">
<div class="chart-box">
<h5><i class="fas fa-chart-pie"></i> Age Group Distribution</h5>
<canvas id="arPieChart"></canvas>
</div>
<div class="chart-box">
<h5><i class="fas fa-chart-bar"></i> Age Range Breakdown</h5>
<canvas id="arBarChart"></canvas>
</div>
</div>
<div class="table-responsive">
<table id="arTable">
<thead>
<tr>
<th>Age Range</th>
<th>Khuddam</th>
<th>Atfal</th>
<th>Total</th>
<th>Percentage</th>
</tr>
</thead>
<tbody id="arTableBody"></tbody>
</table>
</div>
<div style="text-align:center;margin-top:20px;">
<button class="btn btn-success" onclick="exportAgeReport()"><i class="fas fa-file-csv"></i> Export to CSV</button>
</div>
</div>
</div>

<!-- Region Report -->
<div id="regionReport" class="report-section">
<div class="report-filters">
<h4><i class="fas fa-filter"></i> Filter Region Report</h4>
<div class="filter-row">
<div class="filter-group">
<label>Age Group</label>
<select id="rrAgeGroup" onchange="generateRegionReport()">
<option value="all">All Age Groups</option>
<option value="khuddam">Khuddam (14+)</option>
<option value="atfal">Atfal (0-15)</option>
</select>
</div>
<div class="filter-group">
<label>Status</label>
<select id="rrStatus" onchange="generateRegionReport()">
<option value="all">All Status</option>
<option value="Active">Active</option>
<option value="Inactive">Inactive</option>
<option value="Suspended">Suspended</option>
</select>
</div>
</div>
</div>
<div class="report-results">
<div class="report-summary" id="rrSummary"></div>
<div class="report-charts">
<div class="chart-box">
<h5><i class="fas fa-chart-bar"></i> Members by Region</h5>
<canvas id="rrBarChart"></canvas>
</div>
<div class="chart-box">
<h5><i class="fas fa-chart-pie"></i> Region Distribution</h5>
<canvas id="rrPieChart"></canvas>
</div>
</div>
<div class="table-responsive">
<table id="rrTable">
<thead>
<tr>
<th>Region</th>
<th>Subregions</th>
<th>Total Members</th>
<th>Khuddam</th>
<th>Atfal</th>
<th>Active</th>
<th>Inactive</th>
</tr>
</thead>
<tbody id="rrTableBody"></tbody>
</table>
</div>
<div style="text-align:center;margin-top:20px;">
<button class="btn btn-success" onclick="exportRegionReport()"><i class="fas fa-file-csv"></i> Export to CSV</button>
</div>
</div>
</div>

<!-- Status Report -->
<div id="statusReport" class="report-section">
<div class="report-filters">
<h4><i class="fas fa-filter"></i> Filter Status Report</h4>
<div class="filter-row">
<div class="filter-group">
<label>Region</label>
<select id="srRegion" onchange="generateStatusReport()">
<option value="all">All Regions</option>
</select>
</div>
<div class="filter-group">
<label>Age Group</label>
<select id="srAgeGroup" onchange="generateStatusReport()">
<option value="all">All Age Groups</option>
<option value="khuddam">Khuddam (14+)</option>
<option value="atfal">Atfal (0-15)</option>
</select>
</div>
</div>
</div>
<div class="report-results">
<div class="report-summary" id="srSummary"></div>
<div class="report-charts">
<div class="chart-box">
<h5><i class="fas fa-chart-pie"></i> Status Distribution</h5>
<canvas id="srPieChart"></canvas>
</div>
<div class="chart-box">
<h5><i class="fas fa-chart-bar"></i> Status by Age Group</h5>
<canvas id="srBarChart"></canvas>
</div>
</div>
<div class="table-responsive">
<table id="srTable">
<thead>
<tr>
<th>Status</th>
<th>Total</th>
<th>Khuddam</th>
<th>Atfal</th>
<th>Percentage</th>
</tr>
</thead>
<tbody id="srTableBody"></tbody>
</table>
</div>
<div style="text-align:center;margin-top:20px;">
<button class="btn btn-success" onclick="exportStatusReport()"><i class="fas fa-file-csv"></i> Export to CSV</button>
</div>
</div>
</div>

<!-- Department Report -->
<div id="departmentReport" class="report-section">
<div class="report-filters">
<h4><i class="fas fa-filter"></i> Filter Department Report</h4>
<div class="filter-row">
<div class="filter-group">
<label>Region</label>
<select id="drRegion" onchange="generateDepartmentReport()">
<option value="all">All Regions</option>
</select>
</div>
<div class="filter-group">
<label>Status</label>
<select id="drStatus" onchange="generateDepartmentReport()">
<option value="all">All Status</option>
<option value="Active">Active</option>
<option value="Inactive">Inactive</option>
<option value="Suspended">Suspended</option>
</select>
</div>
</div>
</div>
<div class="report-results">
<div class="report-summary" id="drSummary"></div>
<div class="report-charts">
<div class="chart-box">
<h5><i class="fas fa-chart-bar"></i> Members by Department</h5>
<canvas id="drBarChart"></canvas>
</div>
</div>
<div class="table-responsive">
<table id="drTable">
<thead>
<tr>
<th>Department</th>
<th>Total Members</th>
<th>Khuddam</th>
<th>Atfal</th>
<th>Active</th>
<th>Inactive</th>
</tr>
</thead>
<tbody id="drTableBody"></tbody>
</table>
</div>
<div style="text-align:center;margin-top:20px;">
<button class="btn btn-success" onclick="exportDepartmentReport()"><i class="fas fa-file-csv"></i> Export to CSV</button>
</div>
</div>
</div>

<!-- Custom Report -->
<div id="customReport" class="report-section">
<div class="report-filters">
<h4><i class="fas fa-sliders-h"></i> Build Custom Report</h4>
<div class="filter-row">
<div class="filter-group">
<label>Region</label>
<select id="crRegion">
<option value="all">All Regions</option>
</select>
</div>
<div class="filter-group">
<label>Subregion</label>
<select id="crSubregion">
<option value="all">All Subregions</option>
</select>
</div>
<div class="filter-group">
<label>Age Group</label>
<select id="crAgeGroup">
<option value="all">All Age Groups</option>
<option value="khuddam">Khuddam (14+)</option>
<option value="atfal">Atfal (0-15)</option>
</select>
</div>
<div class="filter-group">
<label>Status</label>
<select id="crStatus">
<option value="all">All Status</option>
<option value="Active">Active</option>
<option value="Inactive">Inactive</option>
<option value="Suspended">Suspended</option>
</select>
</div>
</div>
<div class="filter-row">
<div class="filter-group">
<label>Department</label>
<select id="crDepartment">
<option value="all">All Departments</option>
</select>
</div>
<div class="filter-group">
<label>Date Joined From</label>
<input type="date" id="crDateFrom">
</div>
<div class="filter-group">
<label>Date Joined To</label>
<input type="date" id="crDateTo">
</div>
<div class="filter-group">
<label>Search</label>
<input type="text" id="crSearch" placeholder="Name, ID, phone...">
</div>
</div>
<div style="margin-top:15px;">
<button class="btn btn-primary" onclick="generateCustomReport()"><i class="fas fa-play"></i> Generate Report</button>
<button class="btn" style="background:#6c757d;color:white;" onclick="resetCustomFilters()"><i class="fas fa-undo"></i> Reset Filters</button>
</div>
</div>
<div class="report-results">
<div class="report-summary" id="crSummary"></div>
<div class="table-responsive">
<table id="crTable">
<thead>
<tr>
<th>Member ID</th>
<th>Full Name</th>
<th>Age</th>
<th>Region</th>
<th>Subregion</th>
<th>Department</th>
<th>Status</th>
<th>Date Joined</th>
</tr>
</thead>
<tbody id="crTableBody"></tbody>
</table>
</div>
<div style="text-align:center;margin-top:20px;">
<button class="btn btn-success" onclick="exportCustomReport()"><i class="fas fa-file-csv"></i> Export to CSV</button>
<button class="btn btn-primary" onclick="printCustomReport()"><i class="fas fa-print"></i> Print Report</button>
</div>
</div>
</div>

</div>
</div>
</div>

<script>
(function() {
    'use strict';

    // === CONFIG ===
    const SUPABASE_URL = "https://pqrsljahrnjgkadflbmr.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBxcnNsamFocm5qZ2thZGZsYm1yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NTg0NTYsImV4cCI6MjA4NjEzNDQ1Nn0.egED0C2iRp6j3Xp4ldgrdI0GBep2J7VUR52rBbzsVdo";

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        db: { schema: 'public' },
        auth: { persistSession: false }
    });

    // State
    let allMembers = [], allSubregions = [], allRegions = [], allDepartments = [];
    let currentRegionId = null;
    let regionNames = {}, subregionNames = {}, departmentNames = {};
    let charts = {};

    const notification = document.getElementById('notification');

    // === HELPERS ===
    function escapeHtml(str) {
        if (!str) return str;
        return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
    }

    function calculateAge(dob) {
        if (!dob) return null;
        const birth = new Date(dob), today = new Date();
        let age = today.getFullYear() - birth.getFullYear();
        const m = today.getMonth() - birth.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--;
        return age;
    }

    function showNotification(msg, type = 'success') {
        notification.textContent = msg;
        notification.className = `notification show ${type}`;
        setTimeout(() => notification.classList.remove('show'), 3000);
    }

    // === LOAD DROPDOWNS ===
    async function loadDropdownData() {
        try {
            // Regions
            const { data: regions, error: regErr } = await supabase.from('regions').select('id, name').eq('active', true).order('name');
            if (regErr) throw regErr;
            allRegions = regions || [];
            regionNames = {};
            allRegions.forEach(r => regionNames[r.id] = r.name);
            
            let selOpts = '<option value="">All Regions (National)</option>';
            let formOpts = '<option value="">Select Region</option>';
            let reportOpts = '<option value="all">All Regions</option>';
            allRegions.forEach(r => {
                selOpts += `<option value="${r.id}">${escapeHtml(r.name)}</option>`;
                formOpts += `<option value="${r.id}">${escapeHtml(r.name)}</option>`;
                reportOpts += `<option value="${r.id}">${escapeHtml(r.name)}</option>`;
            });
            document.getElementById('regionSelector').innerHTML = selOpts;
            document.getElementById('region').innerHTML = formOpts;
            
            // Update all report region filters
            ['mrRegion','arRegion','srRegion','drRegion','crRegion'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.innerHTML = reportOpts;
            });

            // Departments
            const { data: depts, error: deptErr } = await supabase.from('departments').select('id, name').order('name');
            if (deptErr) throw deptErr;
            allDepartments = depts || [];
            departmentNames = {};
            allDepartments.forEach(d => departmentNames[d.id] = d.name);
            
            let deptOpts = '<option value="">Select Department</option>';
            let reportDeptOpts = '<option value="all">All Departments</option>';
            allDepartments.forEach(d => {
                deptOpts += `<option value="${d.id}">${escapeHtml(d.name)}</option>`;
                reportDeptOpts += `<option value="${d.id}">${escapeHtml(d.name)}</option>`;
            });
            document.getElementById('departmentId').innerHTML = deptOpts;
            
            // Update report department filters
            ['mrDepartment','crDepartment'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.innerHTML = reportDeptOpts;
            });

            // Subregions
            const { data: subs, error: subErr } = await supabase.from('subregions').select('id, region_id, name').eq('active', true).order('name');
            if (subErr) throw subErr;
            allSubregions = subs || [];
            subregionNames = {};
            allSubregions.forEach(s => subregionNames[s.id] = s.name);

        } catch (err) {
            console.error('Dropdown load error:', err);
            showNotification('Could not load dropdown data', 'error');
        }
    }

    // === LOAD SUBREGIONS FOR FORM ===
    async function loadSubregionsForForm() {
        const regionId = document.getElementById('region').value;
        const qiadatSel = document.getElementById('qiadatId');
        qiadatSel.innerHTML = '<option value="">Select Subregion</option>';
        if (!regionId) { qiadatSel.disabled = true; return; }
        qiadatSel.disabled = false;
        
        try {
            const { data, error } = await supabase.from('subregions').select('id, name').eq('region_id', regionId).order('name');
            if (error) throw error;
            let opts = '<option value="">Select Subregion</option>';
            (data || []).forEach(s => { opts += `<option value="${s.id}">${escapeHtml(s.name)}</option>`; });
            qiadatSel.innerHTML = opts;
        } catch (e) { console.error('Subregion load error:', e); }
    }

    // === LOAD SUBREGIONS FOR REPORTS ===
    async function loadSubregionsForReports(regionId, selectId) {
        const sel = document.getElementById(selectId);
        sel.innerHTML = '<option value="all">All Subregions</option>';
        if (!regionId || regionId === 'all') return;
        
        try {
            const { data, error } = await supabase.from('subregions').select('id, name').eq('region_id', regionId).order('name');
            if (error) throw error;
            (data || []).forEach(s => { sel.innerHTML += `<option value="${s.id}">${escapeHtml(s.name)}</option>`; });
        } catch (e) { console.error('Subregion load error:', e); }
    }

    // Add event listeners for region changes in reports
    function setupReportRegionListeners() {
        ['mrRegion','arRegion','srRegion','drRegion','crRegion'].forEach(regionId => {
            const el = document.getElementById(regionId);
            if(el) {
                el.addEventListener('change', function() {
                    const subregionSelectId = regionId.replace('Region', 'Subregion');
                    loadSubregionsForReports(this.value, subregionSelectId);
                });
            }
        });
    }

    // === ENRICH MEMBER WITH NAMES ===
    async function enrichMember(m) {
        const enriched = { ...m };
        if (m.region_id && regionNames[m.region_id]) enriched.region_name = regionNames[m.region_id];
        else if (m.region_id) {
            try { const { data } = await supabase.from('regions').select('name').eq('id', m.region_id).single();
                if (data) { enriched.region_name = data.name; regionNames[m.region_id] = data.name; }
            } catch(e) { enriched.region_name = m.region || '-'; }
        } else enriched.region_name = m.region || '-';
        
        const subId = m.qiadat_id || m.subregion_id;
        if (subId && subregionNames[subId]) enriched.subregion_name = subregionNames[subId];
        else if (subId) {
            try { const { data } = await supabase.from('subregions').select('name').eq('id', subId).single();
                if (data) { enriched.subregion_name = data.name; subregionNames[subId] = data.name; }
            } catch(e) { enriched.subregion_name = '-'; }
        } else enriched.subregion_name = '-';
        
        if (m.department_id && departmentNames[m.department_id]) enriched.department_name = departmentNames[m.department_id];
        else if (m.department_id) {
            try { const { data } = await supabase.from('departments').select('name').eq('id', m.department_id).single();
                if (data) { enriched.department_name = data.name; departmentNames[m.department_id] = data.name; }
            } catch(e) { enriched.department_name = '-'; }
        } else enriched.department_name = '-';
        return enriched;
    }

    // === LOAD MEMBERS ===
    async function loadMembers() {
        const tbody = document.getElementById('membersTable');
        tbody.innerHTML = `<tr><td colspan="8" class="loading-spinner"><i class="fas fa-spinner fa-pulse"></i> Loading...</td></tr>`;
        
        try {
            let query = supabase.from('members').select('*').order('full_name', { ascending: true });
            if (currentRegionId) {
                query = query.eq('region_id', currentRegionId);
                const region = allRegions.find(r => r.id === currentRegionId);
                document.getElementById('currentRegionDisplay').textContent = region?.name || 'Selected Region';
            } else document.getElementById('currentRegionDisplay').textContent = 'All Regions';

            const { data: members, error } = await query;
            if (error) {
                console.error('Members query error:', error);
                const fallback = await supabase.from('members').select('*').order('full_name');
                allMembers = (fallback.data || []).map(m => enrichMember(m));
            } else {
                const enriched = [];
                for (const m of (members || [])) enriched.push(await enrichMember(m));
                allMembers = enriched;
            }

            updateStats();
            renderMembers();
            updateSubregionFilter();
            document.getElementById('lastUpdated').textContent = `Last updated: ${new Date().toLocaleString()}`;
            
        } catch (err) {
            console.error('Load members error:', err);
            tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;color:var(--danger);"><i class="fas fa-exclamation-triangle"></i> Error: ${err.message}</td></tr>`;
            showNotification('Failed to load members', 'error');
        }
    }

    // === MAIN LOAD ===
    async function loadAllData() {
        try {
            await loadDropdownData();
            setupReportRegionListeners();
            await loadMembers();
            generateOverviewReport();
        } catch (e) {
            console.error('LoadAllData error:', e);
            showNotification('Failed to load data: ' + e.message, 'error');
        }
    }

    // === REGION SWITCH ===
    async function switchRegion() {
        currentRegionId = document.getElementById('regionSelector').value || null;
        await loadAllData();
    }

    // === UPDATE STATS ===
    function updateStats() {
        let k = 0, a = 0;
        allMembers.forEach(m => { const age = calculateAge(m.dob); if (age !== null) { if (age >= 14) k++; else a++; } });
        document.getElementById('statKhuddam').textContent = k;
        document.getElementById('statAtfal').textContent = a;
        document.getElementById('statTotal').textContent = allMembers.length;
        const activeSubs = new Set(allMembers.map(m => m.qiadat_id || m.subregion_id).filter(Boolean)).size;
        document.getElementById('statSubregions').textContent = activeSubs;
    }

    // === UPDATE SUBREGION FILTER ===
    function updateSubregionFilter() {
        const filter = document.getElementById('subregionFilter');
        const opts = ['<option value="all">All Subregions</option>'];
        const used = new Set(allMembers.map(m => m.qiadat_id || m.subregion_id).filter(Boolean));
        used.forEach(id => { const name = subregionNames[id] || 'Unknown'; opts.push(`<option value="${id}">${escapeHtml(name)}</option>`); });
        filter.innerHTML = opts.join('');
    }

    // === RENDER MEMBERS TABLE ===
    function renderMembers() {
        const tbody = document.getElementById('membersTable');
        if (allMembers.length === 0) { tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">No members found</td></tr>'; return; }
        let html = '';
        allMembers.forEach(m => {
            const age = calculateAge(m.dob);
            const ageGroup = age !== null ? (age >= 14 ? 'khuddam' : 'atfal') : 'unknown';
            const ageText = age !== null ? age + 'y' : 'N/A';
            const subregion = m.subregion_name || '-';
            const region = m.region_name || '-';
            const status = m.status || 'Active';
            html += `<tr>
                <td><code style="font-size:0.85rem;">${escapeHtml(m.member_id || 'N/A')}</code></td>
                <td>${escapeHtml(m.full_name || '')}</td>
                <td><span class="age-badge ${ageGroup}">${ageGroup === 'khuddam' ? 'Khuddam' : ageGroup === 'atfal' ? 'Atfal' : 'Unknown'}</span><br><small style="color:#666;">${ageText}</small></td>
                <td>${escapeHtml(subregion)}</td>
                <td>${escapeHtml(region)}</td>
                <td>${escapeHtml(m.phone || '-')}</td>
                <td><span class="status-badge ${status.toLowerCase()}">${escapeHtml(status)}</span></td>
                <td><button class="action-btn view" onclick="viewMember('${m.id}')"><i class="fas fa-eye"></i></button></td>
            </tr>`;
        });
        tbody.innerHTML = html;
    }

    // === FILTER MEMBERS ===
    function filterMembers() {
        const search = document.getElementById('memberSearch').value.toLowerCase();
        const subFilter = document.getElementById('subregionFilter').value;
        const statusFilter = document.getElementById('statusFilter').value;
        const filtered = allMembers.filter(m => {
            const matchSearch = (m.full_name?.toLowerCase().includes(search) || m.member_id?.toLowerCase().includes(search) || m.phone?.includes(search));
            const subId = m.qiadat_id || m.subregion_id;
            const matchSub = subFilter === 'all' || subId === subFilter;
            const matchStatus = statusFilter === 'all' || (m.status || 'Active') === statusFilter;
            return matchSearch && matchSub && matchStatus;
        });
        const tbody = document.getElementById('membersTable');
        if (filtered.length === 0) { tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">No matching members</td></tr>'; return; }
        let html = '';
        filtered.forEach(m => {
            const age = calculateAge(m.dob);
            const ageGroup = age !== null ? (age >= 14 ? 'khuddam' : 'atfal') : 'unknown';
            const ageText = age !== null ? age + 'y' : 'N/A';
            const subregion = m.subregion_name || '-';
            const region = m.region_name || '-';
            const status = m.status || 'Active';
            html += `<tr>
                <td><code style="font-size:0.85rem;">${escapeHtml(m.member_id || 'N/A')}</code></td>
                <td>${escapeHtml(m.full_name || '')}</td>
                <td><span class="age-badge ${ageGroup}">${ageGroup === 'khuddam' ? 'Khuddam' : ageGroup === 'atfal' ? 'Atfal' : 'Unknown'}</span><br><small style="color:#666;">${ageText}</small></td>
                <td>${escapeHtml(subregion)}</td>
                <td>${escapeHtml(region)}</td>
                <td>${escapeHtml(m.phone || '-')}</td>
                <td><span class="status-badge ${status.toLowerCase()}">${escapeHtml(status)}</span></td>
                <td><button class="action-btn view" onclick="viewMember('${m.id}')"><i class="fas fa-eye"></i></button></td>
            </tr>`;
        });
        tbody.innerHTML = html;
    }

    // === AGE PREVIEW ===
    function previewAgeGroup() {
        const dob = document.getElementById('dob').value;
        const display = document.getElementById('ageGroupDisplay');
        const desc = document.getElementById('ageDescDisplay');
        const icon = document.getElementById('ageIcon');
        if (!dob) { display.textContent = 'Not calculated'; desc.textContent = 'Enter DOB to calculate'; icon.className = 'fas fa-user'; return; }
        const age = calculateAge(dob);
        const group = age >= 14 ? 'Khuddam' : 'Atfal';
        display.textContent = `${group} (${age} years)`;
        desc.textContent = age >= 14 ? 'Above 14 years' : 'Below 15 years';
        icon.className = age >= 14 ? 'fas fa-user' : 'fas fa-child';
    }

    // === GENERATE MEMBER ID ===
    async function generateMemberId() {
        const regionSel = document.getElementById('region');
        const qiadatSel = document.getElementById('qiadatId');
        const regionName = regionSel.selectedOptions[0]?.text || '';
        const qiadatId = qiadatSel.value;
        if (!regionName || !qiadatId) { showNotification('Select Region & Subregion', 'error'); return null; }
        const regionPrefix = regionName.replace(/[^a-zA-Z]/g, '').substring(0, 2).toUpperCase();
        const sub = allSubregions.find(s => s.id === qiadatId);
        const subPrefix = sub ? sub.name.replace(/[^a-zA-Z]/g, '').substring(0, 2).toUpperCase() : 'XX';
        const existing = allMembers.filter(m => (m.qiadat_id === qiadatId || m.subregion_id === qiadatId) && m.member_id?.startsWith(`${regionPrefix}-${subPrefix}-`));
        const next = (existing.length + 1).toString().padStart(4, '0');
        const id = `${regionPrefix}-${subPrefix}-${next}`;
        document.getElementById('memberId').value = id;
        return id;
    }

    // === SUBMIT FORM ===
    async function submitMemberForm() {
        const form = document.getElementById('enrollmentForm');
        if (!form.checkValidity()) { form.reportValidity(); return; }
        const memberId = await generateMemberId();
        if (!memberId) return;
        const regionSel = document.getElementById('region');
        const regionName = regionSel.selectedOptions[0]?.text;
        const memberData = {
            member_id: memberId, full_name: document.getElementById('fullName').value,
            dob: document.getElementById('dob').value, date_of_birth: document.getElementById('dob').value,
            phone: document.getElementById('phone').value || null, email: document.getElementById('email').value || null,
            region: regionName, region_id: document.getElementById('region').value || null,
            qiadat_id: document.getElementById('qiadatId').value || null, subregion_id: document.getElementById('qiadatId').value || null,
            department_id: document.getElementById('departmentId').value || null, position: document.getElementById('position').value || null,
            address: document.getElementById('address').value || null, status: document.getElementById('status').value,
            date_joined: new Date().toISOString().split('T')[0]
        };
        try {
            const { error } = await supabase.from('members').insert([memberData]);
            if (error) throw error;
            showNotification(`✓ Member registered! ID: ${memberId}`);
            closeAddModal(); form.reset(); document.getElementById('memberId').value = '';
            document.getElementById('ageGroupDisplay').textContent = 'Not calculated';
            document.getElementById('ageDescDisplay').textContent = 'Enter DOB to calculate';
            await loadAllData();
        } catch (err) { console.error('Insert error:', err); showNotification('Failed: ' + err.message, 'error'); }
    }

    // === MODALS ===
    function openAddModal() { document.getElementById('addModal').classList.add('show'); loadDropdownData(); }
    function closeAddModal() { document.getElementById('addModal').classList.remove('show'); document.getElementById('enrollmentForm').reset(); document.getElementById('memberId').value = ''; }
    function openReportsModal() { document.getElementById('reportsModal').classList.add('show'); generateOverviewReport(); }
    function closeReportsModal() { document.getElementById('reportsModal').classList.remove('show'); }

    // === REPORT SECTIONS ===
    window.showReportSection = function(section) {
        document.querySelectorAll('.report-nav-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.report-section').forEach(s => s.classList.remove('active'));
        event.target.closest('.report-nav-btn').classList.add('active');
        document.getElementById(section + 'Report').classList.add('active');
        
        // Generate specific report
        if(section === 'overview') generateOverviewReport();
        else if(section === 'members') generateMembersReport();
        else if(section === 'age') generateAgeReport();
        else if(section === 'region') generateRegionReport();
        else if(section === 'status') generateStatusReport();
        else if(section === 'department') generateDepartmentReport();
        else if(section === 'custom') resetCustomFilters();
    };

    // === OVERVIEW REPORT (COMPLETELY FIXED - NO ANIMATION, NO SCROLLING) ===
    function generateOverviewReport() {
        let k = 0, a = 0, active = 0;
        const regionSet = new Set(), subregionSet = new Set();
        allMembers.forEach(m => {
            const age = calculateAge(m.dob);
            if (age !== null) { if (age >= 14) k++; else a++; }
            if (m.status === 'Active') active++;
            if (m.region_id) regionSet.add(m.region_id);
            if (m.qiadat_id || m.subregion_id) subregionSet.add(m.qiadat_id || m.subregion_id);
        });
        
        document.getElementById('ovTotal').textContent = allMembers.length;
        document.getElementById('ovKhuddam').textContent = k;
        document.getElementById('ovAtfal').textContent = a;
        document.getElementById('ovActive').textContent = active;
        document.getElementById('ovRegions').textContent = regionSet.size || allRegions.length;
        document.getElementById('ovSubregions').textContent = subregionSet.size;

        // Age Chart - COMPLETELY STATIC
        const ageCanvas = document.getElementById('ovAgeChart');
        if (charts.ovAge) {
            charts.ovAge.destroy();
            charts.ovAge = null;
        }
        // Force complete canvas reset
        ageCanvas.width = ageCanvas.width;
        ageCanvas.height = ageCanvas.height;
        ageCanvas.style.width = '100%';
        ageCanvas.style.height = '250px';
        
        charts.ovAge = new Chart(ageCanvas, {
            type: 'doughnut',
            data: { 
                labels: ['Khuddam (14+)', 'Atfal (0-15)', 'Unknown'], 
                datasets: [{ 
                    data: [k, a, allMembers.length - k - a], 
                    backgroundColor: ['#1e3a5f', '#c6a43c', '#9e9e9e'],
                    borderWidth: 0
                }] 
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                animation: { duration: 0 }, // Zero duration animation
                transitions: { active: { animation: { duration: 0 } } }, // Disable hover animation
                plugins: { 
                    legend: { position: 'bottom', labels: { boxWidth: 12 } },
                    tooltip: { enabled: false } // Disable tooltips completely
                },
                hover: { mode: null } // Disable hover effects
            }
        });

        // Region Chart - COMPLETELY STATIC
        const regionData = new Map();
        allMembers.forEach(m => { const r = m.region_name || 'Unknown'; regionData.set(r, (regionData.get(r) || 0) + 1); });
        const regionCanvas = document.getElementById('ovRegionChart');
        if (charts.ovRegion) {
            charts.ovRegion.destroy();
            charts.ovRegion = null;
        }
        regionCanvas.width = regionCanvas.width;
        regionCanvas.height = regionCanvas.height;
        regionCanvas.style.width = '100%';
        regionCanvas.style.height = '250px';
        
        charts.ovRegion = new Chart(regionCanvas, {
            type: 'bar',
            data: { 
                labels: Array.from(regionData.keys()), 
                datasets: [{ 
                    label: 'Members', 
                    data: Array.from(regionData.values()), 
                    backgroundColor: '#1e3a5f',
                    borderWidth: 0
                }] 
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                animation: { duration: 0 }, // Zero duration animation
                transitions: { active: { animation: { duration: 0 } } },
                plugins: { 
                    legend: { display: false },
                    tooltip: { enabled: false } // Disable tooltips
                },
                hover: { mode: null },
                scales: { 
                    y: { beginAtZero: true, grid: { display: false } },
                    x: { grid: { display: false } }
                }
            }
        });
    }

    function exportOverviewReport() {
        const csv = [['Metric','Value'],['Total Members',allMembers.length],['Khuddam',document.getElementById('ovKhuddam').textContent],['Atfal',document.getElementById('ovAtfal').textContent],['Active',document.getElementById('ovActive').textContent]].map(r => r.join(',')).join('\n');
        downloadCSV(csv, 'tajneed_overview_' + new Date().toISOString().split('T')[0] + '.csv');
        showNotification('Overview exported');
    }

    // === MEMBERS REPORT ===
    window.generateMembersReport = function() {
        const region = document.getElementById('mrRegion').value;
        const subregion = document.getElementById('mrSubregion').value;
        const ageGroup = document.getElementById('mrAgeGroup').value;
        const status = document.getElementById('mrStatus').value;
        const dateFrom = document.getElementById('mrDateFrom').value;
        const dateTo = document.getElementById('mrDateTo').value;
        const search = document.getElementById('mrSearch').value.toLowerCase();
        const department = document.getElementById('mrDepartment').value;

        const filtered = allMembers.filter(m => {
            if (region !== 'all' && m.region_id !== region) return false;
            if (subregion !== 'all' && (m.qiadat_id !== subregion && m.subregion_id !== subregion)) return false;
            if (ageGroup === 'khuddam' && calculateAge(m.dob) < 14) return false;
            if (ageGroup === 'atfal' && calculateAge(m.dob) >= 14) return false;
            if (status !== 'all' && (m.status || 'Active') !== status) return false;
            if (dateFrom && m.date_joined < dateFrom) return false;
            if (dateTo && m.date_joined > dateTo) return false;
            if (department !== 'all' && m.department_id !== department) return false;
            if (search && !((m.full_name || '').toLowerCase().includes(search) || (m.member_id || '').toLowerCase().includes(search) || (m.phone || '').includes(search))) return false;
            return true;
        });

        // Summary
        let k = 0, a = 0, active = 0, inactive = 0;
        filtered.forEach(m => { const age = calculateAge(m.dob); if (age !== null) { if (age >= 14) k++; else a++; } if (m.status === 'Active') active++; else inactive++; });
        document.getElementById('mrSummary').innerHTML = `
            <div class="summary-item"><div class="value">${filtered.length}</div><div class="label">Total</div></div>
            <div class="summary-item"><div class="value">${k}</div><div class="label">Khuddam</div></div>
            <div class="summary-item"><div class="value">${a}</div><div class="label">Atfal</div></div>
            <div class="summary-item"><div class="value">${active}</div><div class="label">Active</div></div>
            <div class="summary-item"><div class="value">${inactive}</div><div class="label">Inactive</div></div>
        `;

        // Table
        const tbody = document.getElementById('mrTableBody');
        if (filtered.length === 0) { tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">No members found</td></tr>'; return; }
        let html = '';
        filtered.forEach(m => {
            const age = calculateAge(m.dob);
            html += `<tr>
                <td>${escapeHtml(m.member_id || '-')}</td>
                <td>${escapeHtml(m.full_name || '-')}</td>
                <td>${age || '-'}</td>
                <td>${escapeHtml(m.region_name || '-')}</td>
                <td>${escapeHtml(m.subregion_name || '-')}</td>
                <td>${escapeHtml(m.department_name || '-')}</td>
                <td><span class="status-badge ${(m.status || 'Active').toLowerCase()}">${escapeHtml(m.status || 'Active')}</span></td>
                <td>${m.date_joined || '-'}</td>
            </tr>`;
        });
        tbody.innerHTML = html;
    };

    window.exportMembersReport = function() {
        const rows = document.querySelectorAll('#mrTableBody tr');
        const headers = ['Member ID','Full Name','Age','Region','Subregion','Department','Status','Date Joined'];
        const data = [headers];
        rows.forEach(r => { data.push(Array.from(r.querySelectorAll('td')).map(c => c.textContent)); });
        const csv = data.map(r => r.map(c => `"${c.replace(/"/g,'""')}"`).join(',')).join('\n');
        downloadCSV(csv, 'tajneed_members_report_' + new Date().toISOString().split('T')[0] + '.csv');
        showNotification('Members report exported');
    };

    window.printMembersReport = function() { window.print(); };

    // === AGE REPORT (COMPLETELY FIXED) ===
    window.generateAgeReport = function() {
        const region = document.getElementById('arRegion').value;
        const subregion = document.getElementById('arSubregion').value;
        
        const filtered = allMembers.filter(m => {
            if (region !== 'all' && m.region_id !== region) return false;
            if (subregion !== 'all' && (m.qiadat_id !== subregion && m.subregion_id !== subregion)) return false;
            return true;
        });

        let k = 0, a = 0, u = 0;
        const ageRanges = { '0-5': 0, '6-10': 0, '11-15': 0, '16-20': 0, '21-25': 0, '26-30': 0, '31+': 0 };
        filtered.forEach(m => {
            const age = calculateAge(m.dob);
            if (age === null) u++;
            else {
                if (age >= 14) k++; else a++;
                if (age <= 5) ageRanges['0-5']++;
                else if (age <= 10) ageRanges['6-10']++;
                else if (age <= 15) ageRanges['11-15']++;
                else if (age <= 20) ageRanges['16-20']++;
                else if (age <= 25) ageRanges['21-25']++;
                else if (age <= 30) ageRanges['26-30']++;
                else ageRanges['31+']++;
            }
        });

        document.getElementById('arSummary').innerHTML = `
            <div class="summary-item"><div class="value">${filtered.length}</div><div class="label">Total</div></div>
            <div class="summary-item"><div class="value">${k}</div><div class="label">Khuddam</div></div>
            <div class="summary-item"><div class="value">${a}</div><div class="label">Atfal</div></div>
            <div class="summary-item"><div class="value">${u}</div><div class="label">Unknown</div></div>
        `;

        // Pie Chart - COMPLETELY STATIC
        const pieCanvas = document.getElementById('arPieChart');
        if (charts.arPie) {
            charts.arPie.destroy();
            charts.arPie = null;
        }
        pieCanvas.width = pieCanvas.width;
        pieCanvas.height = pieCanvas.height;
        pieCanvas.style.width = '100%';
        pieCanvas.style.height = '250px';
        
        charts.arPie = new Chart(pieCanvas, {
            type: 'pie',
            data: { 
                labels: ['Khuddam (14+)', 'Atfal (0-15)', 'Unknown'], 
                datasets: [{ 
                    data: [k, a, u], 
                    backgroundColor: ['#1e3a5f', '#c6a43c', '#9e9e9e'],
                    borderWidth: 0
                }] 
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                animation: { duration: 0 },
                transitions: { active: { animation: { duration: 0 } } },
                plugins: { 
                    legend: { position: 'bottom', labels: { boxWidth: 12 } },
                    tooltip: { enabled: false }
                },
                hover: { mode: null }
            }
        });

        // Bar Chart - COMPLETELY STATIC
        const barCanvas = document.getElementById('arBarChart');
        if (charts.arBar) {
            charts.arBar.destroy();
            charts.arBar = null;
        }
        barCanvas.width = barCanvas.width;
        barCanvas.height = barCanvas.height;
        barCanvas.style.width = '100%';
        barCanvas.style.height = '250px';
        
        charts.arBar = new Chart(barCanvas, {
            type: 'bar',
            data: { 
                labels: Object.keys(ageRanges), 
                datasets: [{ 
                    label: 'Members', 
                    data: Object.values(ageRanges), 
                    backgroundColor: '#1e3a5f',
                    borderWidth: 0
                }] 
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                animation: { duration: 0 },
                transitions: { active: { animation: { duration: 0 } } },
                plugins: { 
                    legend: { display: false },
                    tooltip: { enabled: false }
                },
                hover: { mode: null },
                scales: { 
                    y: { beginAtZero: true, grid: { display: false } },
                    x: { grid: { display: false } }
                }
            }
        });

        // Table
        const tbody = document.getElementById('arTableBody');
        let html = '';
        Object.entries(ageRanges).forEach(([range, count]) => {
            const pct = filtered.length > 0 ? ((count / filtered.length) * 100).toFixed(1) : 0;
            const khuddamInRange = range === '16-20' || range === '21-25' || range === '26-30' || range === '31+' ? count : 0;
            const atfalInRange = range === '0-5' || range === '6-10' || range === '11-15' ? count : 0;
            html += `<tr><td>${range}</td><td>${khuddamInRange}</td><td>${atfalInRange}</td><td>${count}</td><td>${pct}%</td></tr>`;
        });
        tbody.innerHTML = html;
    };

    window.exportAgeReport = function() {
        const csv = [['Age Range','Khuddam','Atfal','Total','Percentage'],['0-5','0',document.querySelector('#arTableBody tr:nth-child(1) td:nth-child(2)').textContent,document.querySelector('#arTableBody tr:nth-child(1) td:nth-child(4)').textContent,document.querySelector('#arTableBody tr:nth-child(1) td:nth-child(5)').textContent]].map(r => r.join(',')).join('\n');
        downloadCSV(csv, 'tajneed_age_report_' + new Date().toISOString().split('T')[0] + '.csv');
        showNotification('Age report exported');
    };

    // === REGION REPORT (COMPLETELY FIXED) ===
    window.generateRegionReport = function() {
        const ageGroup = document.getElementById('rrAgeGroup').value;
        const status = document.getElementById('rrStatus').value;
        
        const regionStats = new Map();
        allRegions.forEach(r => { regionStats.set(r.id, { name: r.name, total: 0, k: 0, a: 0, active: 0, inactive: 0, subregions: new Set() }); });
        
        allMembers.forEach(m => {
            if (!m.region_id) return;
            if (ageGroup === 'khuddam' && calculateAge(m.dob) < 14) return;
            if (ageGroup === 'atfal' && calculateAge(m.dob) >= 14) return;
            if (status !== 'all' && (m.status || 'Active') !== status) return;
            
            const stats = regionStats.get(m.region_id);
            if (stats) {
                stats.total++;
                const age = calculateAge(m.dob);
                if (age !== null) { if (age >= 14) stats.k++; else stats.a++; }
                if (m.status === 'Active') stats.active++; else stats.inactive++;
                if (m.qiadat_id || m.subregion_id) stats.subregions.add(m.qiadat_id || m.subregion_id);
            }
        });

        let total = 0, totalK = 0, totalA = 0;
        const tbody = document.getElementById('rrTableBody');
        let html = '';
        regionStats.forEach((stats, id) => {
            if (stats.total > 0) {
                total += stats.total; totalK += stats.k; totalA += stats.a;
                html += `<tr>
                    <td>${escapeHtml(stats.name)}</td>
                    <td>${stats.subregions.size}</td>
                    <td>${stats.total}</td>
                    <td>${stats.k}</td>
                    <td>${stats.a}</td>
                    <td>${stats.active}</td>
                    <td>${stats.inactive}</td>
                </tr>`;
            }
        });
        tbody.innerHTML = html || '<tr><td colspan="7" style="text-align:center;">No data</td></tr>';

        document.getElementById('rrSummary').innerHTML = `
            <div class="summary-item"><div class="value">${total}</div><div class="label">Total</div></div>
            <div class="summary-item"><div class="value">${totalK}</div><div class="label">Khuddam</div></div>
            <div class="summary-item"><div class="value">${totalA}</div><div class="label">Atfal</div></div>
        `;

        // Bar Chart - COMPLETELY STATIC
        const barCanvas = document.getElementById('rrBarChart');
        if (charts.rrBar) {
            charts.rrBar.destroy();
            charts.rrBar = null;
        }
        barCanvas.width = barCanvas.width;
        barCanvas.height = barCanvas.height;
        barCanvas.style.width = '100%';
        barCanvas.style.height = '250px';
        
        const regionNames2 = [], regionValues = [];
        regionStats.forEach((stats, id) => { if (stats.total > 0) { regionNames2.push(stats.name); regionValues.push(stats.total); } });
        
        charts.rrBar = new Chart(barCanvas, {
            type: 'bar',
            data: { 
                labels: regionNames2, 
                datasets: [{ 
                    label: 'Members', 
                    data: regionValues, 
                    backgroundColor: '#1e3a5f',
                    borderWidth: 0
                }] 
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                animation: { duration: 0 },
                transitions: { active: { animation: { duration: 0 } } },
                plugins: { 
                    legend: { display: false },
                    tooltip: { enabled: false }
                },
                hover: { mode: null },
                scales: { 
                    y: { beginAtZero: true, grid: { display: false } },
                    x: { grid: { display: false } }
                }
            }
        });
    };

    window.exportRegionReport = function() {
        const rows = document.querySelectorAll('#rrTableBody tr');
        const headers = ['Region','Subregions','Total','Khuddam','Atfal','Active','Inactive'];
        const data = [headers];
        rows.forEach(r => { data.push(Array.from(r.querySelectorAll('td')).map(c => c.textContent)); });
        const csv = data.map(r => r.map(c => `"${c.replace(/"/g,'""')}"`).join(',')).join('\n');
        downloadCSV(csv, 'tajneed_region_report_' + new Date().toISOString().split('T')[0] + '.csv');
        showNotification('Region report exported');
    };

    // === STATUS REPORT (COMPLETELY FIXED) ===
    window.generateStatusReport = function() {
        const region = document.getElementById('srRegion').value;
        const ageGroup = document.getElementById('srAgeGroup').value;
        
        const statusStats = { Active: { total: 0, k: 0, a: 0 }, Inactive: { total: 0, k: 0, a: 0 }, Suspended: { total: 0, k: 0, a: 0 } };
        
        allMembers.forEach(m => {
            if (region !== 'all' && m.region_id !== region) return;
            if (ageGroup === 'khuddam' && calculateAge(m.dob) < 14) return;
            if (ageGroup === 'atfal' && calculateAge(m.dob) >= 14) return;
            
            const status = m.status || 'Active';
            const age = calculateAge(m.dob);
            if (statusStats[status]) {
                statusStats[status].total++;
                if (age !== null) { if (age >= 14) statusStats[status].k++; else statusStats[status].a++; }
            }
        });

        const total = Object.values(statusStats).reduce((sum, s) => sum + s.total, 0);
        document.getElementById('srSummary').innerHTML = `
            <div class="summary-item"><div class="value">${total}</div><div class="label">Total</div></div>
            <div class="summary-item"><div class="value">${statusStats.Active.total}</div><div class="label">Active</div></div>
            <div class="summary-item"><div class="value">${statusStats.Inactive.total}</div><div class="label">Inactive</div></div>
            <div class="summary-item"><div class="value">${statusStats.Suspended.total}</div><div class="label">Suspended</div></div>
        `;

        // Pie Chart - COMPLETELY STATIC
        const pieCanvas = document.getElementById('srPieChart');
        if (charts.srPie) {
            charts.srPie.destroy();
            charts.srPie = null;
        }
        pieCanvas.width = pieCanvas.width;
        pieCanvas.height = pieCanvas.height;
        pieCanvas.style.width = '100%';
        pieCanvas.style.height = '250px';
        
        charts.srPie = new Chart(pieCanvas, {
            type: 'pie',
            data: { 
                labels: ['Active', 'Inactive', 'Suspended'], 
                datasets: [{ 
                    data: [statusStats.Active.total, statusStats.Inactive.total, statusStats.Suspended.total], 
                    backgroundColor: ['#28a745', '#6c757d', '#dc3545'],
                    borderWidth: 0
                }] 
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                animation: { duration: 0 },
                transitions: { active: { animation: { duration: 0 } } },
                plugins: { 
                    legend: { position: 'bottom', labels: { boxWidth: 12 } },
                    tooltip: { enabled: false }
                },
                hover: { mode: null }
            }
        });

        // Table
        const tbody = document.getElementById('srTableBody');
        let html = '';
        Object.entries(statusStats).forEach(([status, stats]) => {
            const pct = total > 0 ? ((stats.total / total) * 100).toFixed(1) : 0;
            html += `<tr><td><span class="status-badge ${status.toLowerCase()}">${status}</span></td><td>${stats.total}</td><td>${stats.k}</td><td>${stats.a}</td><td>${pct}%</td></tr>`;
        });
        tbody.innerHTML = html;
    };

    window.exportStatusReport = function() {
        const rows = document.querySelectorAll('#srTableBody tr');
        const headers = ['Status','Total','Khuddam','Atfal','Percentage'];
        const data = [headers];
        rows.forEach(r => { data.push(Array.from(r.querySelectorAll('td')).map(c => c.textContent)); });
        const csv = data.map(r => r.map(c => `"${c.replace(/"/g,'""')}"`).join(',')).join('\n');
        downloadCSV(csv, 'tajneed_status_report_' + new Date().toISOString().split('T')[0] + '.csv');
        showNotification('Status report exported');
    };

    // === DEPARTMENT REPORT (COMPLETELY FIXED) ===
    window.generateDepartmentReport = function() {
        const region = document.getElementById('drRegion').value;
        const status = document.getElementById('drStatus').value;
        
        const deptStats = new Map();
        allDepartments.forEach(d => { deptStats.set(d.id, { name: d.name, total: 0, k: 0, a: 0, active: 0, inactive: 0 }); });
        deptStats.set(null, { name: 'No Department', total: 0, k: 0, a: 0, active: 0, inactive: 0 });
        
        allMembers.forEach(m => {
            if (region !== 'all' && m.region_id !== region) return;
            if (status !== 'all' && (m.status || 'Active') !== status) return;
            
            const deptId = m.department_id;
            const stats = deptStats.get(deptId) || deptStats.get(null);
            if (stats) {
                stats.total++;
                const age = calculateAge(m.dob);
                if (age !== null) { if (age >= 14) stats.k++; else stats.a++; }
                if (m.status === 'Active') stats.active++; else stats.inactive++;
            }
        });

        let total = 0;
        const tbody = document.getElementById('drTableBody');
        let html = '';
        const deptNames = [], deptValues = [];
        deptStats.forEach((stats, id) => {
            if (stats.total > 0) {
                total += stats.total;
                deptNames.push(stats.name);
                deptValues.push(stats.total);
                html += `<tr>
                    <td>${escapeHtml(stats.name)}</td>
                    <td>${stats.total}</td>
                    <td>${stats.k}</td>
                    <td>${stats.a}</td>
                    <td>${stats.active}</td>
                    <td>${stats.inactive}</td>
                </tr>`;
            }
        });
        tbody.innerHTML = html || '<tr><td colspan="6" style="text-align:center;">No data</td></tr>';

        document.getElementById('drSummary').innerHTML = `<div class="summary-item"><div class="value">${total}</div><div class="label">Total Members</div></div>`;

        // Bar Chart - COMPLETELY STATIC
        const barCanvas = document.getElementById('drBarChart');
        if (charts.drBar) {
            charts.drBar.destroy();
            charts.drBar = null;
        }
        barCanvas.width = barCanvas.width;
        barCanvas.height = barCanvas.height;
        barCanvas.style.width = '100%';
        barCanvas.style.height = '250px';
        
        charts.drBar = new Chart(barCanvas, {
            type: 'bar',
            data: { 
                labels: deptNames, 
                datasets: [{ 
                    label: 'Members', 
                    data: deptValues, 
                    backgroundColor: '#1e3a5f',
                    borderWidth: 0
                }] 
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                animation: { duration: 0 },
                transitions: { active: { animation: { duration: 0 } } },
                plugins: { 
                    legend: { display: false },
                    tooltip: { enabled: false }
                },
                hover: { mode: null },
                scales: { 
                    y: { beginAtZero: true, grid: { display: false } },
                    x: { grid: { display: false } }
                }, 
                indexAxis: 'y' 
            }
        });
    };

    window.exportDepartmentReport = function() {
        const rows = document.querySelectorAll('#drTableBody tr');
        const headers = ['Department','Total','Khuddam','Atfal','Active','Inactive'];
        const data = [headers];
        rows.forEach(r => { data.push(Array.from(r.querySelectorAll('td')).map(c => c.textContent)); });
        const csv = data.map(r => r.map(c => `"${c.replace(/"/g,'""')}"`).join(',')).join('\n');
        downloadCSV(csv, 'tajneed_department_report_' + new Date().toISOString().split('T')[0] + '.csv');
        showNotification('Department report exported');
    };

    // === CUSTOM REPORT ===
    window.resetCustomFilters = function() {
        document.getElementById('crRegion').value = 'all';
        document.getElementById('crSubregion').innerHTML = '<option value="all">All Subregions</option>';
        document.getElementById('crAgeGroup').value = 'all';
        document.getElementById('crStatus').value = 'all';
        document.getElementById('crDepartment').value = 'all';
        document.getElementById('crDateFrom').value = '';
        document.getElementById('crDateTo').value = '';
        document.getElementById('crSearch').value = '';
        document.getElementById('crSummary').innerHTML = '';
        document.getElementById('crTableBody').innerHTML = '<tr><td colspan="8" style="text-align:center;">Apply filters and click Generate Report</td></tr>';
    };

    window.generateCustomReport = function() {
        const region = document.getElementById('crRegion').value;
        const subregion = document.getElementById('crSubregion').value;
        const ageGroup = document.getElementById('crAgeGroup').value;
        const status = document.getElementById('crStatus').value;
        const department = document.getElementById('crDepartment').value;
        const dateFrom = document.getElementById('crDateFrom').value;
        const dateTo = document.getElementById('crDateTo').value;
        const search = document.getElementById('crSearch').value.toLowerCase();

        const filtered = allMembers.filter(m => {
            if (region !== 'all' && m.region_id !== region) return false;
            if (subregion !== 'all' && (m.qiadat_id !== subregion && m.subregion_id !== subregion)) return false;
            if (ageGroup === 'khuddam' && calculateAge(m.dob) < 14) return false;
            if (ageGroup === 'atfal' && calculateAge(m.dob) >= 14) return false;
            if (status !== 'all' && (m.status || 'Active') !== status) return false;
            if (department !== 'all' && m.department_id !== department) return false;
            if (dateFrom && m.date_joined < dateFrom) return false;
            if (dateTo && m.date_joined > dateTo) return false;
            if (search && !((m.full_name || '').toLowerCase().includes(search) || (m.member_id || '').toLowerCase().includes(search) || (m.phone || '').includes(search))) return false;
            return true;
        });

        let k = 0, a = 0, active = 0;
        filtered.forEach(m => { const age = calculateAge(m.dob); if (age !== null) { if (age >= 14) k++; else a++; } if (m.status === 'Active') active++; });
        document.getElementById('crSummary').innerHTML = `
            <div class="summary-item"><div class="value">${filtered.length}</div><div class="label">Total</div></div>
            <div class="summary-item"><div class="value">${k}</div><div class="label">Khuddam</div></div>
            <div class="summary-item"><div class="value">${a}</div><div class="label">Atfal</div></div>
            <div class="summary-item"><div class="value">${active}</div><div class="label">Active</div></div>
        `;

        const tbody = document.getElementById('crTableBody');
        if (filtered.length === 0) { tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">No members found</td></tr>'; return; }
        let html = '';
        filtered.forEach(m => {
            const age = calculateAge(m.dob);
            html += `<tr>
                <td>${escapeHtml(m.member_id || '-')}</td>
                <td>${escapeHtml(m.full_name || '-')}</td>
                <td>${age || '-'}</td>
                <td>${escapeHtml(m.region_name || '-')}</td>
                <td>${escapeHtml(m.subregion_name || '-')}</td>
                <td>${escapeHtml(m.department_name || '-')}</td>
                <td><span class="status-badge ${(m.status || 'Active').toLowerCase()}">${escapeHtml(m.status || 'Active')}</span></td>
                <td>${m.date_joined || '-'}</td>
            </tr>`;
        });
        tbody.innerHTML = html;
    };

    window.exportCustomReport = function() {
        const rows = document.querySelectorAll('#crTableBody tr');
        const headers = ['Member ID','Full Name','Age','Region','Subregion','Department','Status','Date Joined'];
        const data = [headers];
        rows.forEach(r => { data.push(Array.from(r.querySelectorAll('td')).map(c => c.textContent)); });
        const csv = data.map(r => r.map(c => `"${c.replace(/"/g,'""')}"`).join(',')).join('\n');
        downloadCSV(csv, 'tajneed_custom_report_' + new Date().toISOString().split('T')[0] + '.csv');
        showNotification('Custom report exported');
    };

    window.printCustomReport = function() { window.print(); };

    // === EXPORT/UTILS ===
    function downloadCSV(csv, filename) {
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
        URL.revokeObjectURL(url);
    }

    function viewMember(id) {
        const member = allMembers.find(m => m.id === id);
        if (!member) return;
        alert(`Member Details\n\nID: ${member.member_id}\nName: ${member.full_name}\nRegion: ${member.region_name}\nSubregion: ${member.subregion_name}\nStatus: ${member.status}\nPhone: ${member.phone}\nEmail: ${member.email}`);
    }

    // === INIT ===
    async function init() {
        await loadAllData();
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.remove('show'); });
        });
    }

    // Expose globals
    window.switchRegion = switchRegion;
    window.loadAllData = loadAllData;
    window.filterMembers = filterMembers;
    window.openAddModal = openAddModal;
    window.closeAddModal = closeAddModal;
    window.openReportsModal = openReportsModal;
    window.closeReportsModal = closeReportsModal;
    window.submitMemberForm = submitMemberForm;
    window.loadSubregionsForForm = loadSubregionsForForm;
    window.previewAgeGroup = previewAgeGroup;
    window.viewMember = viewMember;

    document.addEventListener('DOMContentLoaded', init);
})();
</script>
</body>
</html>