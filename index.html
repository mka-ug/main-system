<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MKA Uganda â€¢ Complete Management System</title>
<!-- Fonts & Icons -->
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600;700&family=Libre+Franklin:wght@300;400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<style>
:root {
--green: #00331A;
--deep-green: #001F12;
--gold: #B89B5E;
--cream: #FAF9F5;
--border: #E8E2D9;
--primary-btn: #00331A;
--secondary-btn: #B89B5E;
--active-bg: #e8f5e9;
--active-text: #2e7d32;
--inactive-bg: #ffebee;
--inactive-text: #c62828;
--pending-bg: #fff9c4;
--pending-text: #f57f17;
--suspended-bg: #fff3e0;
--suspended-text: #ef6c00;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Libre Franklin',sans-serif; background:var(--cream); color:#2d2d2d; min-height: 100vh; }
/* Header */
header { position:fixed; top:0; left:0; right:0; height:70px; background:white; border-bottom:1px solid var(--border); z-index:100; }
.flag-banner { height:4px; background:linear-gradient(to right, #000 33%, #FFCD00 33%, #FFCD00 66%, #D90000 66%); }
.header-container { display:flex; align-items:center; justify-content:space-between; padding:0 2rem; height:100%; }
.logo { font-family:'Cormorant Garamond',serif; font-size:1.8rem; color:var(--deep-green); display:flex; align-items:center; gap:12px; text-decoration:none; }
.logo small { font-size:0.75rem; color:var(--gold); letter-spacing:1px; display:block; margin-top:-3px; }
/* Sidebar */
.sidebar { position:fixed; left:0; top:70px; bottom:0; width:240px; background:white; border-right:1px solid var(--border); padding-top:1.5rem; overflow-y:auto; }
.sidebar h3 { font-family:'Cormorant Garamond',serif; font-size:1.6rem; color:var(--deep-green); text-align:center; margin-bottom:1.8rem; }
.menu-item { padding:12px 24px; display:flex; align-items:center; gap:14px; color:#444; font-weight:500; cursor:pointer; transition:0.2s; }
.menu-item:hover, .menu-item.active { background:rgba(184,155,94,0.1); color:var(--deep-green); font-weight:600; }
.menu-item i { width:20px; text-align:center; font-size:1.1rem; }
/* Main Content */
.main { margin-left:240px; padding:100px 30px 40px; }
.dashboard-header { text-align:center; margin-bottom:2.5rem; }
.dashboard-header h1 { font-family:'Cormorant Garamond',serif; font-size:2.5rem; color:var(--deep-green); margin-bottom:0.5rem; }
.dashboard-header p { color:#666; font-size:1.05rem; max-width:600px; margin:0 auto; line-height:1.5; }
/* Stats Cards */
.stats { display:grid; grid-template-columns:repeat(4,1fr); gap:18px; margin-bottom:25px; }
.stat { background:white; padding:18px; border-radius:10px; text-align:center; box-shadow:0 2px 8px rgba(0,0,0,0.05); }
.stat i { font-size:1.8rem; color:var(--gold); margin-bottom:10px; }
.stat div:first-child { font-size:0.95rem; color:#777; margin-bottom:6px; }
.stat .number { font-size:1.9rem; font-weight:700; font-family:'Cormorant Garamond',serif; color:var(--deep-green); }
/* Charts */
.charts { display:grid; grid-template-columns:repeat(3,1fr); gap:20px; }
.chart-box { background:white; border-radius:10px; padding:15px; box-shadow:0 2px 8px rgba(0,0,0,0.05); }
.chart-box h4 { text-align:center; font-size:1.2rem; color:var(--deep-green); margin-bottom:15px; font-weight:600; }
canvas { height:200px !important; }
/* Quick Actions */
.quick-actions { display:grid; grid-template-columns:repeat(4,1fr); gap:15px; margin-bottom:25px; }
.quick-actions button { padding:14px; border:none; border-radius:10px; background:#f8f9fa; font-weight:500; cursor:pointer; display:flex; flex-direction:column; align-items:center; gap:8px; transition:0.2s; }
.quick-actions button:hover { background:var(--gold); color:white; transform:translateY(-2px); }
.quick-actions i { font-size:1.5rem; }
/* Department Card Styles */
.department-card { background: white; border-radius: 12px; padding: 25px; margin-bottom: 20px; box-shadow: 0 3px 10px rgba(0,0,0,0.08); transition: transform 0.3s, box-shadow 0.3s; }
.department-card.active-department { background: linear-gradient(to right, #e8f5e9, white); border-left: 4px solid #2e7d32; }
.department-card.inactive-department { background: linear-gradient(to right, #ffebee, white); border-left: 4px solid #c62828; }
.department-card.pending-department { background: linear-gradient(to right, #fff9c4, white); border-left: 4px solid #f57f17; }
.department-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.12); }
.department-card h3 { color: var(--deep-green); font-family: 'Cormorant Garamond', serif; font-size: 1.8rem; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
.department-card p { color: #555; margin: 12px 0; line-height: 1.6; }
.department-stats { display: flex; gap: 25px; margin: 15px 0; padding: 12px; background: rgba(184, 155, 94, 0.08); border-radius: 8px; font-size: 0.95rem; flex-wrap: wrap; }
.department-stats span { display: flex; align-items: center; gap: 8px; color: var(--deep-green); font-weight: 600; }
.department-stats i { color: var(--gold); font-size: 1.1rem; }
.department-actions { display: flex; gap: 12px; margin-top: 15px; justify-content: flex-end; }
/* Button Styles */
.btn-manage { padding: 10px 20px; background: var(--primary-btn); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; transition: background 0.3s; }
.btn-manage:hover { background: #002614; transform: translateY(-1px); box-shadow: 0 3px 8px rgba(0,0,0,0.15); }
.btn-manage i { font-size: 1rem; }
/* Status Badge Styles */
.status-badge { padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; transition: transform 0.2s, box-shadow 0.2s; cursor: default; }
.status-badge:hover { transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
.status-badge.active { background: var(--active-bg); color: var(--active-text); }
.status-badge.inactive { background: var(--inactive-bg); color: var(--inactive-text); }
.status-badge.pending { background: var(--pending-bg); color: var(--pending-text); }
.status-badge.suspended { background: var(--suspended-bg); color: var(--suspended-text); }
/* Status Filter Buttons */
.status-filters { display: flex; gap: 10px; margin-bottom: 25px; justify-content: center; flex-wrap: wrap; padding: 0 20px; }
.status-filter-btn { padding: 10px 20px; border: none; border-radius: 25px; font-weight: 500; cursor: pointer; transition: all 0.2s; background: white; color: #555; border: 1px solid var(--border); font-size: 0.95rem; }
.status-filter-btn:hover { transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
.status-filter-btn.active { transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
.status-filter-btn[data-status="active"]:hover, .status-filter-btn[data-status="active"].active { background: var(--active-bg); color: var(--active-text); border-color: var(--active-text); }
.status-filter-btn[data-status="inactive"]:hover, .status-filter-btn[data-status="inactive"].active { background: var(--inactive-bg); color: var(--inactive-text); border-color: var(--inactive-text); }
.status-filter-btn[data-status="pending"]:hover, .status-filter-btn[data-status="pending"].active { background: var(--pending-bg); color: var(--pending-text); border-color: var(--pending-text); }
.status-filter-btn[data-status="suspended"]:hover, .status-filter-btn[data-status="suspended"].active { background: var(--suspended-bg); color: var(--suspended-text); border-color: var(--suspended-text); }
.status-filter-btn[data-status="all"]:hover, .status-filter-btn[data-status="all"].active { background: var(--deep-green); color: white; border-color: var(--deep-green); }
/* Region Card Styles */
.region-card { background: white; border-radius: 12px; padding: 25px; margin-bottom: 20px; box-shadow: 0 3px 10px rgba(0,0,0,0.08); border-left: 4px solid var(--gold); transition: transform 0.3s, box-shadow 0.3s; position: relative; overflow: hidden; }
.region-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.12); }
.region-card::before { content: ''; position: absolute; top: 0; right: 0; width: 100px; height: 100px; background: linear-gradient(135deg, transparent 50%, rgba(184, 155, 94, 0.1) 50%); border-radius: 0 0 0 100px; }
.region-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; position: relative; z-index: 1; }
.region-header h3 { color: var(--deep-green); font-family: 'Cormorant Garamond', serif; font-size: 1.8rem; display: flex; align-items: center; gap: 10px; }
.region-header h3 i { color: var(--gold); font-size: 1.6rem; }
.region-badge { background: var(--deep-green); color: white; padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 500; letter-spacing: 0.5px; }
.region-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0; position: relative; z-index: 1; }
.region-stat-item { background: rgba(184, 155, 94, 0.08); padding: 12px; border-radius: 10px; text-align: center; transition: background 0.3s; cursor: pointer; }
.region-stat-item:hover { background: rgba(184, 155, 94, 0.15); }
.region-stat-item i { color: var(--gold); font-size: 1.3rem; margin-bottom: 5px; }
.region-stat-item .stat-label { font-size: 0.75rem; color: #777; text-transform: uppercase; letter-spacing: 0.5px; }
.region-stat-item .stat-value { font-size: 1.4rem; font-weight: 700; color: var(--deep-green); font-family: 'Cormorant Garamond', serif; line-height: 1.2; }
.region-actions { display: flex; gap: 12px; margin-top: 20px; justify-content: flex-end; position: relative; z-index: 1; }
.btn-view { padding: 12px 24px; background: var(--gold); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 10px; transition: all 0.3s; }
.btn-view:hover { background: #a6894f; transform: translateY(-1px); box-shadow: 0 3px 8px rgba(184, 155, 94, 0.3); }
.btn-view i { font-size: 1rem; }
.btn-view-sub { padding: 12px 24px; background: transparent; color: var(--deep-green); border: 2px solid var(--gold); border-radius: 8px; font-weight: 600; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 10px; transition: all 0.3s; }
.btn-view-sub:hover { background: rgba(184, 155, 94, 0.1); transform: translateY(-1px); }
.region-description { color: #555; line-height: 1.6; margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 3px solid var(--gold); position: relative; z-index: 1; }
.sub-regions-preview { display: flex; flex-wrap: wrap; gap: 8px; margin: 15px 0; position: relative; z-index: 1; }
.sub-region-tag { background: white; border: 1px solid var(--border); padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; color: var(--deep-green); display: inline-flex; align-items: center; gap: 5px; }
.sub-region-tag i { color: var(--gold); font-size: 0.75rem; }
.sub-region-tag.more { background: var(--deep-green); color: white; border: none; }
/* Modal Styles */
.modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
.modal.active { display: flex; }
.modal-content { background: white; border-radius: 12px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
.modal-header { padding: 20px 25px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: var(--deep-green); color: white; border-radius: 12px 12px 0 0; }
.modal-header h2 { font-family: 'Cormorant Garamond', serif; font-size: 1.8rem; display: flex; align-items: center; gap: 10px; }
.modal-header h2 i { color: var(--gold); }
.modal-close { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 5px; transition: transform 0.3s; }
.modal-close:hover { transform: scale(1.1); }
.modal-body { padding: 25px; }
.sub-region-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid var(--border); transition: background 0.3s; }
.sub-region-item:hover { background: rgba(184, 155, 94, 0.05); }
.sub-region-item:last-child { border-bottom: none; }
.sub-region-info h4 { color: var(--deep-green); font-family: 'Cormorant Garamond', serif; font-size: 1.3rem; margin-bottom: 5px; }
.sub-region-info p { color: #666; font-size: 0.9rem; display: flex; align-items: center; gap: 8px; }
.sub-region-stats { display: flex; gap: 15px; }
.sub-region-stat { text-align: center; min-width: 60px; }
.sub-region-stat .stat-number { font-size: 1.2rem; font-weight: 700; color: var(--deep-green); font-family: 'Cormorant Garamond', serif; }
.sub-region-stat .stat-label { font-size: 0.7rem; color: #777; text-transform: uppercase; }
/* Utilities */
.page { display:none; }
.page.active { display:block; }
.department-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
/* Member Card Styles */
.member-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 3px 10px rgba(0,0,0,0.08); border-left: 4px solid var(--gold); transition: transform 0.3s, box-shadow 0.3s; }
.member-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.12); }
/* Settings Tabs */
.settings-tabs { display: flex; background: #f8f9fa; border-bottom: 1px solid var(--border); flex-wrap: wrap; }
.settings-tab { padding: 15px 25px; background: none; border: none; font-weight: 600; color: #555; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.3s; }
.settings-tab i { color: var(--gold); }
.settings-tab:hover { background: white; color: var(--deep-green); }
.settings-tab.active { background: white; color: var(--deep-green); border-bottom: 3px solid var(--gold); }
.data-table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; }
.data-table th { background: var(--deep-green); color: white; font-weight: 600; padding: 12px; text-align: left; }
.data-table td { padding: 12px; border-bottom: 1px solid var(--border); }
.data-table tr:last-child td { border-bottom: none; }
.data-table tr:hover { background: rgba(184, 155, 94, 0.05); }
.form-group { margin-bottom: 15px; }
.form-group label { display: block; font-weight: 600; color: var(--deep-green); margin-bottom: 5px; }
.form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-family: inherit; }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
.id-card-preview { background: linear-gradient(135deg, var(--deep-green), #002614); color: white; padding: 20px; border-radius: 10px; max-width: 350px; margin: 0 auto; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
.id-card-preview .mosque-icon { font-size: 2.5rem; color: var(--gold); }
.id-card-preview .divider { height: 2px; background: var(--gold); margin: 10px 0; }
.id-card-preview .photo-placeholder { width: 80px; height: 80px; background: rgba(255,255,255,0.2); border-radius: 50%; margin: 10px auto; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: var(--gold); border: 2px solid var(--gold); }
/* Khuddam Tab Enhanced Styles */
.khuddam-stats-summary { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-bottom: 25px; }
.khuddam-stat-card { background: white; padding: 15px; border-radius: 10px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-left: 4px solid var(--gold); }
.khuddam-stat-card .stat-number { font-size: 2rem; font-weight: 700; color: var(--deep-green); font-family: 'Cormorant Garamond', serif; line-height: 1.2; }
.khuddam-stat-card .stat-label { font-size: 0.85rem; color: #777; text-transform: uppercase; letter-spacing: 0.5px; }
.khuddam-filters { display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; align-items: center; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
.khuddam-search { flex: 1; min-width: 250px; position: relative; }
.khuddam-search i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--gold); }
.khuddam-search input { width: 100%; padding: 12px 15px 12px 45px; border: 1px solid var(--border); border-radius: 8px; font-size: 0.95rem; transition: border-color 0.3s; }
.khuddam-search input:focus { outline: none; border-color: var(--gold); }
.khuddam-filter-group { display: flex; gap: 10px; flex-wrap: wrap; }
.khuddam-filter-select { padding: 12px 25px 12px 15px; border: 1px solid var(--border); border-radius: 8px; background: white; font-size: 0.95rem; cursor: pointer; min-width: 150px; }
.khuddam-filter-select:focus { outline: none; border-color: var(--gold); }
.khuddam-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
/* Flip Card Styles */
.flip-card { background-color: transparent; height: 420px; perspective: 1000px; cursor: pointer; }
.flip-card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.8s; transform-style: preserve-3d; }
.flip-card.flipped .flip-card-inner { transform: rotateY(180deg); }
.flip-card-front, .flip-card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 12px; overflow-y: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
.flip-card-front { background: white; }
.flip-card-back { background: linear-gradient(135deg, var(--deep-green), #002614); color: white; transform: rotateY(180deg); padding: 20px; display: flex; flex-direction: column; }
.id-card-header { border-bottom: 2px solid var(--gold); padding-bottom: 10px; margin-bottom: 15px; }
.id-card-header i { font-size: 2.5rem; color: var(--gold); }
.id-card-header h3 { font-family: 'Cormorant Garamond', serif; font-size: 1.4rem; margin-top: 5px; }
.id-card-photo { width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; border: 3px solid var(--gold); }
.id-card-photo i { font-size: 3rem; color: var(--gold); }
.id-card-details { text-align: left; flex: 1; }
.id-card-detail { margin-bottom: 8px; font-size: 0.9rem; display: flex; align-items: center; gap: 8px; }
.id-card-detail i { color: var(--gold); width: 20px; }
.id-card-footer { border-top: 2px solid var(--gold); padding-top: 10px; margin-top: 10px; font-size: 0.8rem; color: rgba(255,255,255,0.8); }
/* QR Code Styles */
.qr-code-container { display: flex; justify-content: center; align-items: center; margin: 15px 0; }
.qr-code { width: 120px; height: 120px; background: white; padding: 8px; border-radius: 8px; }
.flip-instruction { position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.5); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; }
/* Tab Content Styles */
.tab-content { background: white; border-radius: 12px; padding: 20px; }
.sample-item { padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; transition: background 0.3s; }
.sample-item:hover { background: rgba(184, 155, 94, 0.05); }
.sample-item:last-child { border-bottom: none; }
.sample-item h3 { color: var(--deep-green); font-family: 'Cormorant Garamond', serif; font-size: 1.3rem; margin-bottom: 5px; }
.sample-item p { color: #666; font-size: 0.9rem; }
.sample-item .badge { background: var(--gold); color: white; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; }
.sample-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-top: 15px; }
@media (max-width: 1100px) { .charts { grid-template-columns: repeat(2,1fr); } .stats { grid-template-columns: repeat(2,1fr); } .khuddam-stats-summary { grid-template-columns: repeat(3,1fr); } }
@media (max-width: 768px) { .sidebar { width:70px; } .sidebar h3, .menu-item span { display:none; } .menu-item { justify-content:center; padding:15px; } .menu-item i { margin:0; font-size:1.3rem; } .main { margin-left:70px; padding:90px 15px 30px; } .quick-actions, .stats, .charts { grid-template-columns: 1fr; } .khuddam-stats-summary { grid-template-columns: 1fr; } .khuddam-filters { flex-direction: column; } .khuddam-filter-group { width: 100%; } .khuddam-filter-select { flex: 1; } .department-actions { flex-direction: column; align-items: stretch; } .btn-manage { width: 100%; justify-content: center; } .department-header { flex-direction: column; gap: 10px; } .department-stats { flex-direction: column; gap: 10px; } .region-stats { grid-template-columns: 1fr; } .region-actions { flex-direction: column; } .btn-view, .btn-view-sub { width: 100%; justify-content: center; } .sub-region-item { flex-direction: column; text-align: center; gap: 10px; } .sub-region-stats { width: 100%; justify-content: center; } }
</style>
</head>
<body>
<!-- Header -->
<header>
<div class="flag-banner"></div>
<div class="header-container">
<a href="#" class="logo" onclick="showPage('dashboard'); return false;">
<i class="fas fa-mosque"></i>
<div>
MKA UGANDA
<small>MAJLIS KHUDDAMUL AHMADIYYA</small>
</div>
</a>
<div style="font-weight:500; color:var(--deep-green)" id="currentDate"></div>
</div>
</header>
<!-- Sidebar -->
<div class="sidebar">
<h3>MKA Uganda</h3>
<div class="menu-item active" data-page="dashboard">
<i class="fas fa-tachometer-alt"></i> <span>Dashboard</span>
</div>
<div class="menu-item" data-page="khuddam">
<i class="fas fa-users"></i> <span>Khuddam</span>
</div>
<div class="menu-item" data-page="departments">
<i class="fas fa-building-columns"></i> <span>Departments</span>
</div>
<div class="menu-item" data-page="regions">
<i class="fas fa-map"></i> <span>Regions</span>
</div>
<div class="menu-item" data-page="rcourses">
<i class="fas fa-book-quran"></i> <span>R. Courses</span>
</div>
<div class="menu-item" data-page="ijtima">
<i class="fas fa-calendar-check"></i> <span>Ijtima</span>
</div>
<div class="menu-item" data-page="reports">
<i class="fas fa-file-contract"></i> <span>Reports</span>
</div>
<div class="menu-item" data-page="settings">
<i class="fas fa-gear"></i> <span>Settings</span>
</div>
</div>
<!-- Main Content -->
<div class="main">
<!-- Dashboard Page -->
<div id="dashboard" class="page active">
<div class="dashboard-header">
<h1>MAJLIS KHUDDAMUL AHMADIYYA - UGANDA</h1>
<p>"A nation cannot be reformed without the reformation of its youth."</p>
</div>
<div class="quick-actions">
<button id="btnMsg"><i class="fas fa-envelope"></i> Messages</button>
<button id="btnRem"><i class="fas fa-bell"></i> Reminders</button>
<button id="btnEvt"><i class="fas fa-calendar"></i> Events</button>
<button id="btnRep"><i class="fas fa-file-alt"></i> Reports</button>
</div>
<div class="stats">
<div class="stat"><i class="fas fa-users"></i><div>Total Members</div><div class="number" id="totalMembers">0</div></div>
<div class="stat"><i class="fas fa-user-check"></i><div>Active Members</div><div class="number" id="activeMembers">0</div></div>
<div class="stat"><i class="fas fa-map-marker-alt"></i><div>Regions</div><div class="number" id="regionsCount">0</div></div>
<div class="stat"><i class="fas fa-clock"></i><div>Last Activity</div><div class="number" id="lastScan">Loading...</div></div>
</div>
<div class="charts">
<div class="chart-box"><h4>Members by Region</h4><canvas id="membersRegionChart"></canvas></div>
<div class="chart-box"><h4>Activity Trend (7 Days)</h4><canvas id="scanTrendChart"></canvas></div>
<div class="chart-box"><h4>Regional Activity</h4><canvas id="activeRegionChart"></canvas></div>
</div>
</div>
<!-- Departments Page -->
<div id="departments" class="page">
<div class="dashboard-header"><h1>Departments</h1><p>All MKA departments and committees</p></div>
<div id="departmentsContainer" style="padding:20px;">
<div id="departmentsList" style="text-align:center; padding:40px;">
<i class="fas fa-spinner fa-spin fa-3x"></i><p style="margin-top:15px; color:#777;">Loading departments...</p>
</div>
</div>
</div>
<!-- Khuddam Page -->
<div id="khuddam" class="page">
<div class="dashboard-header"><h1>Khuddam Members</h1><p>Complete directory of all Khuddam across Uganda</p></div>
<div class="khuddam-stats-summary" id="khuddamStatsSummary">
<div class="khuddam-stat-card"><div class="stat-number" id="totalKhuddamCount">0</div><div class="stat-label">Total Members</div></div>
<div class="khuddam-stat-card" style="border-left-color: var(--active-text);"><div class="stat-number" id="activeKhuddamCount">0</div><div class="stat-label">Active</div></div>
<div class="khuddam-stat-card" style="border-left-color: var(--inactive-text);"><div class="stat-number" id="inactiveKhuddamCount">0</div><div class="stat-label">Inactive</div></div>
<div class="khuddam-stat-card" style="border-left-color: var(--suspended-text);"><div class="stat-number" id="suspendedKhuddamCount">0</div><div class="stat-label">Suspended</div></div>
<div class="khuddam-stat-card" style="border-left-color: var(--gold);"><div class="stat-number" id="regionsKhuddamCount">0</div><div class="stat-label">Regions</div></div>
</div>
<div class="khuddam-filters">
<div class="khuddam-search"><i class="fas fa-search"></i><input type="text" id="khuddamSearch" placeholder="Search by name, ID, email, phone..."></div>
<div class="khuddam-filter-group">
<select id="khuddamStatusFilter" class="khuddam-filter-select"><option value="all">All Status</option><option value="active">Active</option><option value="inactive">Inactive</option><option value="suspended">Suspended</option></select>
<select id="khuddamRegionFilter" class="khuddam-filter-select"><option value="all">All Regions</option></select>
<select id="khuddamDepartmentFilter" class="khuddam-filter-select"><option value="all">All Departments</option></select>
</div>
</div>
<div class="chart-box"><div id="khuddamList" style="padding:20px;"><div class="khuddam-grid" id="khuddamGrid"></div></div></div>
</div>
<!-- Regions Page -->
<div id="regions" class="page">
<div class="dashboard-header"><h1>Regions</h1><p>Regional structure across Uganda</p></div>
<div class="chart-box"><div id="regionsList" style="padding:20px; text-align:center;"><i class="fas fa-spinner fa-spin"></i> Loading regions...</div></div>
</div>
<!-- R. Courses Page -->
<div id="rcourses" class="page">
<div class="dashboard-header"><h1>Religious Courses</h1><p>Education and spiritual development</p></div>
<div class="tab-content">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
<h2 style="font-family: 'Cormorant Garamond', serif; color: var(--deep-green);">Current Courses</h2><span class="badge">2024 Session</span>
</div>
<div class="sample-grid" id="rcoursesList"></div>
</div>
</div>
<!-- Ijtima Page -->
<div id="ijtima" class="page">
<div class="dashboard-header"><h1>Ijtima</h1><p>National gatherings and events</p></div>
<div class="tab-content">
<div style="margin-bottom: 20px;"><h2 style="font-family: 'Cormorant Garamond', serif; color: var(--deep-green);">Upcoming & Past Events</h2></div>
<div id="ijtimaList" class="sample-grid"></div>
</div>
</div>
<!-- Reports Page -->
<div id="reports" class="page">
<div class="dashboard-header"><h1>Reports</h1><p>Generate and view organizational reports</p></div>
<div class="tab-content">
<div style="margin-bottom: 20px;"><h2 style="font-family: 'Cormorant Garamond', serif; color: var(--deep-green);">Available Reports</h2></div>
<div id="reportsList" class="sample-grid"></div>
</div>
</div>
<!-- Popup Modals -->
<div id="subregionModal" class="modal"><div class="modal-content"><div class="modal-header"><h2><i class="fas fa-map-pin"></i> <span id="subregionModalTitle">Sub-Regions</span></h2><button class="modal-close" onclick="closeModal('subregionModal')">&times;</button></div><div class="modal-body" id="subregionModalBody"></div></div></div>
<div id="regionMembersModal" class="modal"><div class="modal-content"><div class="modal-header"><h2><i class="fas fa-users"></i> <span id="regionMembersModalTitle">Members in Region</span></h2><button class="modal-close" onclick="closeModal('regionMembersModal')">&times;</button></div><div class="modal-body" id="regionMembersModalBody"></div></div></div>
<div id="regionMosquesModal" class="modal"><div class="modal-content"><div class="modal-header"><h2><i class="fas fa-mosque"></i> <span id="regionMosquesModalTitle">Mosques in Region</span></h2><button class="modal-close" onclick="closeModal('regionMosquesModal')">&times;</button></div><div class="modal-body" id="regionMosquesModalBody"></div></div></div>
<!-- Settings Page -->
<div id="settings" class="page">
<div class="dashboard-header"><h1>System Settings & Management</h1><p>Complete control over all MKA Uganda data and configurations</p></div>
<div class="settings-container">
<div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-bottom: 10px;">
<div style="background: white; padding: 15px; border-radius: 10px; text-align: center; border-left: 4px solid var(--gold);"><i class="fas fa-users" style="color: var(--gold); font-size: 1.5rem;"></i><div style="font-size: 1.2rem; font-weight: 700; color: var(--deep-green);" id="statTotalMembers">0</div><div style="font-size: 0.8rem; color: #777;">Total Members</div></div>
<div style="background: white; padding: 15px; border-radius: 10px; text-align: center; border-left: 4px solid var(--gold);"><i class="fas fa-building-columns" style="color: var(--gold); font-size: 1.5rem;"></i><div style="font-size: 1.2rem; font-weight: 700; color: var(--deep-green);" id="statTotalDepts">0</div><div style="font-size: 0.8rem; color: #777;">Departments</div></div>
<div style="background: white; padding: 15px; border-radius: 10px; text-align: center; border-left: 4px solid var(--gold);"><i class="fas fa-map" style="color: var(--gold); font-size: 1.5rem;"></i><div style="font-size: 1.2rem; font-weight: 700; color: var(--deep-green);" id="statTotalRegions">0</div><div style="font-size: 0.8rem; color: #777;">Regions</div></div>
<div style="background: white; padding: 15px; border-radius: 10px; text-align: center; border-left: 4px solid var(--gold);"><i class="fas fa-mosque" style="color: var(--gold); font-size: 1.5rem;"></i><div style="font-size: 1.2rem; font-weight: 700; color: var(--deep-green);" id="statTotalMosques">0</div><div style="font-size: 0.8rem; color: #777;">Mosques</div></div>
<div style="background: white; padding: 15px; border-radius: 10px; text-align: center; border-left: 4px solid var(--gold);"><i class="fas fa-book-quran" style="color: var(--gold); font-size: 1.5rem;"></i><div style="font-size: 1.2rem; font-weight: 700; color: var(--deep-green);" id="statTotalCourses">0</div><div style="font-size: 0.8rem; color: #777;">Courses</div></div>
</div>
<div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 3px 10px rgba(0,0,0,0.08);">
<div class="settings-tabs">
<button class="settings-tab active" data-tab="members"><i class="fas fa-users"></i> Members</button>
<button class="settings-tab" data-tab="departments"><i class="fas fa-building-columns"></i> Departments</button>
<button class="settings-tab" data-tab="regions"><i class="fas fa-map"></i> Regions</button>
<button class="settings-tab" data-tab="mosques"><i class="fas fa-mosque"></i> Mosques</button>
<!-- ID Cards Tab -->
<button class="settings-tab" data-tab="idcards"><i class="fas fa-id-card"></i> ID Cards</button>
<button class="settings-tab" data-tab="system"><i class="fas fa-gear"></i> System</button>
</div>
<div style="padding: 25px; max-height: 600px; overflow-y: auto;">
<!-- Members Management Tab -->
<div id="settings-members" class="settings-tab-content active">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
<h3 style="font-family: 'Cormorant Garamond', serif; font-size: 1.8rem; color: var(--deep-green);"><i class="fas fa-users" style="color: var(--gold); margin-right: 10px;"></i> Member Management</h3>
<button class="btn-manage" onclick="openMemberModal('add')" style="background: var(--gold);"><i class="fas fa-plus"></i> Add New Member</button>
</div>
<div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
<input type="text" id="memberSearchAdmin" placeholder="Search members..." style="flex: 1; min-width: 200px; padding: 10px 15px; border: 1px solid var(--border); border-radius: 8px;">
<select id="memberDeptFilter" style="padding: 10px 15px; border: 1px solid var(--border); border-radius: 8px; min-width: 150px;"><option value="all">All Departments</option></select>
<select id="memberStatusFilter" style="padding: 10px 15px; border: 1px solid var(--border); border-radius: 8px; min-width: 150px;"><option value="all">All Status</option><option value="active">Active</option><option value="inactive">Inactive</option><option value="suspended">Suspended</option></select>
</div>
<div style="overflow-x: auto;"><table class="data-table"><thead><tr><th>ID</th><th>Name</th><th>Department</th><th>Region</th><th>Status</th><th>Actions</th></tr></thead><tbody id="membersTableBody"><tr><td colspan="6" style="text-align: center; padding: 30px;">Loading members...</td></tr></tbody></table></div>
</div>
<!-- Departments Management Tab -->
<div id="settings-departments" class="settings-tab-content" style="display: none;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
<h3 style="font-family: 'Cormorant Garamond', serif; font-size: 1.8rem; color: var(--deep-green);"><i class="fas fa-building-columns" style="color: var(--gold); margin-right: 10px;"></i> Department Management</h3>
<button class="btn-manage" onclick="openDepartmentModal('add')" style="background: var(--gold);"><i class="fas fa-plus"></i> Add Department</button>
</div>
<div id="departmentsListAdmin"></div>
</div>
<!-- Regions Management Tab -->
<div id="settings-regions" class="settings-tab-content" style="display: none;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
<h3 style="font-family: 'Cormorant Garamond', serif; font-size: 1.8rem; color: var(--deep-green);"><i class="fas fa-map" style="color: var(--gold); margin-right: 10px;"></i> Regions & Sub-Regions</h3>
<div style="display: flex; gap: 10px;">
<button class="btn-manage" onclick="openRegionModal('add')" style="background: var(--gold);"><i class="fas fa-plus"></i> Add Region</button>
<button class="btn-manage" onclick="openSubRegionModal('add')" style="background: var(--deep-green);"><i class="fas fa-plus"></i> Add Sub-Region</button>
</div>
</div>
<div id="regionsListAdmin"></div>
</div>
<!-- Mosques Management Tab -->
<div id="settings-mosques" class="settings-tab-content" style="display: none;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
<h3 style="font-family: 'Cormorant Garamond', serif; font-size: 1.8rem; color: var(--deep-green);"><i class="fas fa-mosque" style="color: var(--gold); margin-right: 10px;"></i> Mosque Management</h3>
<button class="btn-manage" onclick="openMosqueModal('add')" style="background: var(--gold);"><i class="fas fa-plus"></i> Add Mosque</button>
</div>
<div id="mosquesListAdmin"></div>
</div>
<!-- ID Cards Management Tab (Placeholder - Redirects to id-cards.html) -->
<div id="settings-idcards" class="settings-tab-content" style="display: none;">
<h3 style="font-family: 'Cormorant Garamond', serif; font-size: 1.8rem; color: var(--deep-green); margin-bottom: 20px;"><i class="fas fa-id-card" style="color: var(--gold); margin-right: 10px;"></i> ID Card Generation</h3>
<p>Redirecting to ID Card Printer...</p>
</div>
<!-- System Settings Tab -->
<div id="settings-system" class="settings-tab-content" style="display: none;">
<h3 style="font-family: 'Cormorant Garamond', serif; font-size: 1.8rem; color: var(--deep-green); margin-bottom: 20px;"><i class="fas fa-gear" style="color: var(--gold); margin-right: 10px;"></i> System Configuration</h3>
<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
<div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
<h4 style="color: var(--deep-green); margin-bottom: 15px;">Organization Info</h4>
<div class="form-group"><label>Organization Name</label><input type="text" value="Majlis Khuddamul Ahmadiyya Uganda"></div>
<div class="form-group"><label>Headquarters</label><input type="text" value="Kampala, Uganda"></div>
<div class="form-group"><label>Contact Email</label><input type="email" value="info@mkauganda.org"></div>
</div>
<div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
<h4 style="color: var(--deep-green); margin-bottom: 15px;">Appearance</h4>
<div class="form-group"><label>Theme</label><select><option>Light (Default)</option><option>Dark</option><option>High Contrast</option></select></div>
<div class="form-group"><label>Language</label><select><option>English</option><option>Kiswahili</option><option>Urdu</option></select></div>
<div class="form-group"><label>Date Format</label><select><option>DD/MM/YYYY</option><option>MM/DD/YYYY</option><option>YYYY-MM-DD</option></select></div>
</div>
<div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
<h4 style="color: var(--deep-green); margin-bottom: 15px;">Backup & Restore</h4>
<button class="btn-manage" style="width: 100%; margin-bottom: 10px; background: var(--deep-green);" onclick="backupData()"><i class="fas fa-download"></i> Download Backup</button>
<button class="btn-manage" style="width: 100%; margin-bottom: 10px; background: var(--gold);" onclick="restoreData()"><i class="fas fa-upload"></i> Restore from Backup</button>
<button class="btn-manage" style="width: 100%; background: #dc3545;" onclick="exportLogs()"><i class="fas fa-file-export"></i> Export Activity Logs</button>
</div>
<div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
<h4 style="color: var(--deep-green); margin-bottom: 15px;">User Permissions</h4>
<div style="margin-bottom: 10px;"><label style="display: flex; align-items: center; gap: 10px;"><input type="checkbox" checked> Allow member registration</label></div>
<div style="margin-bottom: 10px;"><label style="display: flex; align-items: center; gap: 10px;"><input type="checkbox" checked> Require admin approval</label></div>
<div style="margin-bottom: 10px;"><label style="display: flex; align-items: center; gap: 10px;"><input type="checkbox"> Enable public profiles</label></div>
<button class="btn-manage" style="width: 100%; margin-top: 15px; background: var(--deep-green);">Save Permissions</button>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<!-- CRUD Modals (Member, Department, Region, Sub-Region, Mosque) -->
<!-- Member Modal -->
<div id="memberModal" class="modal"><div class="modal-content"><div class="modal-header"><h2><i class="fas fa-user"></i> <span id="memberModalTitle">Add Member</span></h2><button class="modal-close" onclick="closeModal('memberModal')">&times;</button></div><div class="modal-body"><form id="memberForm"><input type="hidden" id="memberId"><div class="form-row"><div class="form-group"><label>Full Name *</label><input type="text" id="memberName" required></div><div class="form-group"><label>Member ID <small style="color: var(--gold);">(Auto-generated if left blank)</small></label><div style="display: flex; gap: 5px;"><input type="text" id="memberIdNumber" placeholder="Leave blank to auto-generate"><button type="button" class="btn-manage" onclick="generateMemberId()" style="padding: 5px 10px; font-size: 0.8rem; background: var(--gold); white-space: nowrap;"><i class="fas fa-sync-alt"></i> Generate</button></div></div></div><div class="form-row"><div class="form-group"><label>Email</label><input type="email" id="memberEmail"></div><div class="form-group"><label>Phone</label><input type="tel" id="memberPhone"></div></div><div class="form-row"><div class="form-group"><label>Department</label><select id="memberDepartment"><option value="">Select Department</option></select></div><div class="form-group"><label>Region</label><select id="memberRegion"><option value="">Select Region</option></select></div></div><div class="form-row"><div class="form-group"><label>Sub-Region</label><select id="memberSubRegion"><option value="">Select Sub-Region</option></select></div><div class="form-group"><label>Status</label><select id="memberStatus"><option value="active">Active</option><option value="inactive">Inactive</option><option value="suspended">Suspended</option></select></div></div><div class="form-group"><label>Address</label><textarea id="memberAddress" rows="2"></textarea></div><div class="form-group"><label>Photo URL</label><input type="url" id="memberPhoto"></div><div style="display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end;"><button type="button" class="btn-manage" onclick="closeModal('memberModal')" style="background: #666;">Cancel</button><button type="submit" class="btn-manage" style="background: var(--gold);">Save Member</button></div></form></div></div></div>
<!-- Department Modal -->
<div id="departmentModal" class="modal"><div class="modal-content"><div class="modal-header"><h2><i class="fas fa-building-columns"></i> <span id="departmentModalTitle">Add Department</span></h2><button class="modal-close" onclick="closeModal('departmentModal')">&times;</button></div><div class="modal-body"><form id="departmentForm"><input type="hidden" id="departmentId"><div class="form-group"><label>Department Name *</label><input type="text" id="departmentName" required></div><div class="form-group"><label>Description</label><textarea id="departmentDescription" rows="3"></textarea></div><div class="form-group"><label>Status</label><select id="departmentStatus"><option value="active">Active</option><option value="inactive">Inactive</option><option value="pending">Pending</option><option value="suspended">Suspended</option></select></div><div style="display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end;"><button type="button" class="btn-manage" onclick="closeModal('departmentModal')" style="background: #666;">Cancel</button><button type="submit" class="btn-manage" style="background: var(--gold);">Save Department</button></div></form></div></div></div>
<!-- Region Modal -->
<div id="regionModal" class="modal"><div class="modal-content"><div class="modal-header"><h2><i class="fas fa-map"></i> <span id="regionModalTitle">Add Region</span></h2><button class="modal-close" onclick="closeModal('regionModal')">&times;</button></div><div class="modal-body"><form id="regionForm"><input type="hidden" id="regionId"><div class="form-group"><label>Region Name *</label><input type="text" id="regionName" required></div><div class="form-group"><label>Region Code</label><input type="text" id="regionCode" placeholder="e.g., KLA, MBA"></div><div class="form-group"><label>Description</label><textarea id="regionDescription" rows="3"></textarea></div><div style="display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end;"><button type="button" class="btn-manage" onclick="closeModal('regionModal')" style="background: #666;">Cancel</button><button type="submit" class="btn-manage" style="background: var(--gold);">Save Region</button></div></form></div></div></div>
<!-- Sub-Region Modal -->
<div id="subRegionModal" class="modal"><div class="modal-content"><div class="modal-header"><h2><i class="fas fa-map-pin"></i> <span id="subRegionModalTitle">Add Sub-Region</span></h2><button class="modal-close" onclick="closeModal('subRegionModal')">&times;</button></div><div class="modal-body"><form id="subRegionForm"><input type="hidden" id="subRegionId"><div class="form-group"><label>Parent Region *</label><select id="parentRegion" required><option value="">Select Region</option></select></div><div class="form-group"><label>Sub-Region Name *</label><input type="text" id="subRegionName" required></div><div class="form-group"><label>Location</label><input type="text" id="subRegionLocation" placeholder="e.g., Central Kampala"></div><div style="display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end;"><button type="button" class="btn-manage" onclick="closeModal('subRegionModal')" style="background: #666;">Cancel</button><button type="submit" class="btn-manage" style="background: var(--gold);">Save Sub-Region</button></div></form></div></div></div>
<!-- Mosque Modal -->
<div id="mosqueModal" class="modal"><div class="modal-content"><div class="modal-header"><h2><i class="fas fa-mosque"></i> <span id="mosqueModalTitle">Add Mosque</span></h2><button class="modal-close" onclick="closeModal('mosqueModal')">&times;</button></div><div class="modal-body"><form id="mosqueForm"><input type="hidden" id="mosqueId"><div class="form-group"><label>Mosque Name *</label><input type="text" id="mosqueName" required></div><div class="form-group"><label>Region *</label><select id="mosqueRegion" required><option value="">Select Region</option></select></div><div class="form-group"><label>Sub-Region</label><select id="mosqueSubRegion"><option value="">Select Sub-Region</option></select></div><div class="form-group"><label>Address</label><textarea id="mosqueAddress" rows="2"></textarea></div><div class="form-group"><label>Imam Name</label><input type="text" id="mosqueImam"></div><div style="display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end;"><button type="button" class="btn-manage" onclick="closeModal('mosqueModal')" style="background: #666;">Cancel</button><button type="submit" class="btn-manage" style="background: var(--gold);">Save Mosque</button></div></form></div></div></div>
<script>
// ==========================
// SUPABASE CONFIG
// ==========================
const SUPABASE_URL = "https://pqrsljahrnjgkadflbmr.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBxcnNsamFocm5qZ2thZGZsYm1yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NTg0NTYsImV4cCI6MjA4NjEzNDQ1Nn0.egED0C2iRp6j3Xp4ldgrdI0GBep2J7VUR52rBbzsVdo";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
// Set current date
const now = new Date();
document.getElementById('currentDate').textContent = now.toLocaleDateString('en-UG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
// Page navigation
document.querySelectorAll('.menu-item').forEach(item => {
item.addEventListener('click', () => {
const pageId = item.dataset.page;
showPage(pageId);
});
});
function showPage(pageId) {
document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
document.getElementById(pageId).classList.add('active');
document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
document.querySelector(`[data-page="${pageId}"]`).classList.add('active');
if (pageId === 'dashboard') { initCharts(); }
if (pageId === 'departments') loadDepartments();
if (pageId === 'khuddam') loadKhuddamMembers();
if (pageId === 'regions') loadRegions();
if (pageId === 'rcourses') loadRCoursesSample();
if (pageId === 'ijtima') loadIjtimaSample();
if (pageId === 'reports') loadReportsSample();
if (pageId === 'settings') { loadSettingsStats(); loadMembersAdmin(); loadDepartmentsAdmin(); loadRegionsAdmin(); loadMosquesAdmin(); loadIDCardData(); }
}
// ==========================
// HELPER FUNCTIONS
// ==========================
function getStatusStyle(status) {
const statusLower = status ? status.toLowerCase() : 'active';
switch(statusLower) {
case 'active': return { bg: 'var(--active-bg)', text: 'var(--active-text)', icon: 'fa-check-circle', borderColor: 'var(--active-text)', class: 'active' };
case 'inactive': return { bg: 'var(--inactive-bg)', text: 'var(--inactive-text)', icon: 'fa-times-circle', borderColor: 'var(--inactive-text)', class: 'inactive' };
case 'pending': return { bg: 'var(--pending-bg)', text: 'var(--pending-text)', icon: 'fa-clock', borderColor: 'var(--pending-text)', class: 'pending' };
case 'suspended': return { bg: 'var(--suspended-bg)', text: 'var(--suspended-text)', icon: 'fa-ban', borderColor: 'var(--suspended-text)', class: 'suspended' };
default: return { bg: 'var(--active-bg)', text: 'var(--active-text)', icon: 'fa-check-circle', borderColor: 'var(--active-text)', class: 'active' };
}
}
// ==========================
// AUTO-GENERATE MEMBER ID FUNCTION
// ==========================
async function generateMemberId() {
const prefix = "MKA-UG";
const timestamp = Date.now().toString().slice(-6);
const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
const memberId = `${prefix}-${timestamp}${random}`;
document.getElementById('memberIdNumber').value = memberId;
}
// ==========================
// ENHANCED KHUDDAM PAGE FUNCTIONS
// ==========================
let allKhuddamMembers = [];
let filteredKhuddamMembers = [];
let searchTimeout = null;
async function loadKhuddamMembers() {
const grid = document.getElementById('khuddamGrid');
if (!grid) return;
grid.innerHTML = `<div style="grid-column: 1/-1; text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin fa-3x"></i><p style="margin-top:15px;">Loading members...</p></div>`;
try {
const { data: members, error } = await supabaseClient.from('members').select('*, departments(name)').order('full_name');
if (error) throw error;
allKhuddamMembers = Array.isArray(members) ? members : [];
const regions = [...new Set(allKhuddamMembers.map(m => (m.region || m.region_name || '').trim()).filter(Boolean))];
const depts = [...new Set(allKhuddamMembers.map(m => (m.departments?.name || m.department || '').trim()).filter(Boolean))];
const regionFilter = document.getElementById('khuddamRegionFilter');
if (regionFilter) { regionFilter.innerHTML = '<option value="all">All Regions</option>' + regions.sort().map(r => `<option value="${escapeHtml(r)}">${escapeHtml(r)}</option>`).join(''); }
const deptFilter = document.getElementById('khuddamDepartmentFilter');
if (deptFilter) { deptFilter.innerHTML = '<option value="all">All Departments</option>' + depts.sort().map(d => `<option value="${escapeHtml(d)}">${escapeHtml(d)}</option>`).join(''); }
updateKhuddamStats(allKhuddamMembers);
filterKhuddamMembers();
const searchInput = document.getElementById('khuddamSearch');
if (searchInput) { searchInput.addEventListener('input', () => { clearTimeout(searchTimeout); searchTimeout = setTimeout(filterKhuddamMembers, 300); }); }
document.getElementById('khuddamStatusFilter')?.addEventListener('change', filterKhuddamMembers);
document.getElementById('khuddamRegionFilter')?.addEventListener('change', filterKhuddamMembers);
document.getElementById('khuddamDepartmentFilter')?.addEventListener('change', filterKhuddamMembers);
} catch (error) {
console.error('Error loading Khuddam members:', error);
grid.innerHTML = `<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: red;"><i class="fas fa-exclamation-triangle fa-3x"></i><p style="margin-top:15px;">Failed to load members. Please try again.</p></div>`;
}
}
function escapeHtml(str = '') { return String(str).replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }
function updateKhuddamStats(members) {
const total = members.length;
const active = members.filter(m => (m.status || '').toLowerCase() === 'active').length;
const inactive = members.filter(m => (m.status || '').toLowerCase() === 'inactive').length;
const suspended = members.filter(m => (m.status || '').toLowerCase() === 'suspended').length;
const regions = [...new Set(members.map(m => (m.region || '').trim()).filter(Boolean))].length;
document.getElementById('totalKhuddamCount').textContent = total;
document.getElementById('activeKhuddamCount').textContent = active;
document.getElementById('inactiveKhuddamCount').textContent = inactive;
document.getElementById('suspendedKhuddamCount').textContent = suspended;
document.getElementById('regionsKhuddamCount').textContent = regions;
}
function filterKhuddamMembers() {
const searchTermRaw = document.getElementById('khuddamSearch')?.value || '';
const searchTerm = searchTermRaw.trim().toLowerCase();
const statusFilter = (document.getElementById('khuddamStatusFilter')?.value || 'all').toLowerCase();
const regionFilter = (document.getElementById('khuddamRegionFilter')?.value || 'all');
const deptFilter = (document.getElementById('khuddamDepartmentFilter')?.value || 'all');
filteredKhuddamMembers = allKhuddamMembers.filter(member => {
const fullName = (member.full_name || member.name || '').toString();
const memberId = (member.member_id || member.id_number || member.id || '').toString();
const email = (member.email || '').toString();
const phone = (member.phone || member.phone_number || '').toString();
const status = (member.status || '').toString();
const region = (member.region || member.region_name || '').toString();
const deptName = (member.departments?.name || member.department || '').toString();
const matchesSearch = searchTerm === '' || fullName.toLowerCase().includes(searchTerm) || memberId.toLowerCase().includes(searchTerm) || email.toLowerCase().includes(searchTerm) || phone.toLowerCase().includes(searchTerm);
const matchesStatus = statusFilter === 'all' || status.toLowerCase() === statusFilter;
const matchesRegion = regionFilter === 'all' || region === regionFilter;
const matchesDept = deptFilter === 'all' || deptName === deptFilter;
return matchesSearch && matchesStatus && matchesRegion && matchesDept;
});
renderKhuddamMembers();
}
function generateMemberQRData(member) {
const payload = { id: member.id || memberIdFrom(member), member_id: member.member_id || member.member_id || memberIdFrom(member), name: member.full_name || member.name || 'Unknown', department: member.departments?.name || member.department || 'Member', region: member.region || member.region_name || 'Uganda', valid_until: '2026-12-31' };
const signature = btoa(JSON.stringify(payload)).substring(0, 12);
payload.signature = signature;
return JSON.stringify(payload);
}
function memberIdFrom(member) { return member.member_id || member.id || (member.email ? 'email:' + member.email : 'unknown'); }
function renderKhuddamMembers() {
const grid = document.getElementById('khuddamGrid');
if (!grid) return;
if (filteredKhuddamMembers.length === 0) {
grid.innerHTML = `<div style="grid-column: 1/-1; text-align: center; padding: 40px;"><i class="fas fa-users-slash fa-4x" style="color: var(--gold);"></i><h3 style="margin-top: 15px; color: var(--deep-green);">No members found</h3><p style="color: #777;">Try adjusting your filters</p></div>`;
return;
}
grid.innerHTML = filteredKhuddamMembers.map(member => {
const statusStyle = getStatusStyle(member.status);
const initials = (member.full_name || member.name || 'Member').split(' ').map(n => n[0] || '').join('').toUpperCase().substring(0, 2) || 'MK';
const qrId = `qr-${member.id || escapeHtml(memberIdFrom(member))}`;
const safeFullName = escapeHtml(member.full_name || member.name || 'Unknown Member');
const safeDept = escapeHtml(member.departments?.name || member.department || 'Not assigned');
const safeMemberId = escapeHtml(member.member_id || member.id || 'N/A');
const safeRegion = escapeHtml(member.region || member.region_name || 'No region');
const photoUrl = escapeHtml(member.photo_url || member.photo || '');
const debugJson = escapeHtml(JSON.stringify(member));
return `
<div class="flip-card" data-member-id="${escapeHtml(member.id || memberIdFrom(member))}">
<div class="flip-card-inner">
<div class="flip-card-front" onclick="this.parentElement.parentElement.classList.toggle('flipped'); generateQROnFlip('${escapeHtml(member.id || memberIdFrom(member))}')">
<div style="padding: 20px; height: 100%; display: flex; flex-direction: column;">
<div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
${photoUrl ? `<img src="${photoUrl}" alt="${safeFullName}" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid var(--gold);">` : `<div style="width: 50px; height: 50px; border-radius: 50%; background: ${statusStyle.bg}; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; font-weight: 700; color: ${statusStyle.text}; border: 2px solid ${statusStyle.borderColor};">${initials}</div>`}
<div style="flex: 1; text-align: left;">
<h3 style="font-family: 'Cormorant Garamond', serif; font-size: 1.3rem; color: var(--deep-green); margin-bottom: 3px;">${safeFullName}</h3>
<span class="status-badge ${statusStyle.class}" style="font-size: 0.75rem;"><i class="fas ${statusStyle.icon}"></i> ${escapeHtml(member.status || 'Active')}</span>
</div>
</div>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 8px; text-align: left;">
<div><div style="font-size: 0.7rem; color: #777; text-transform: uppercase;">Department</div><div style="font-weight: 600; color: var(--deep-green); font-size: 0.9rem;"><i class="fas fa-building-columns" style="color: var(--gold); width: 16px;"></i>${safeDept}</div></div>
<div><div style="font-size: 0.7rem; color: #777; text-transform: uppercase;">Member ID</div><div style="font-weight: 600; color: var(--deep-green); font-size: 0.9rem;"><i class="fas fa-id-card" style="color: var(--gold); width: 16px;"></i>${safeMemberId}</div></div>
</div>
<div style="text-align: left; margin: 10px 0; flex: 1;">
<div style="margin-bottom: 8px;"><i class="fas fa-map-marker-alt" style="color: var(--gold); width: 20px;"></i><span style="font-size: 0.9rem;">${safeRegion} ${member.sub_region ? `â€¢ ${escapeHtml(member.sub_region)}` : ''}</span></div>
${member.email ? `<div style="margin-bottom: 8px;"><i class="fas fa-envelope" style="color: var(--gold); width: 20px;"></i><span style="font-size: 0.9rem;">${escapeHtml(member.email)}</span></div>` : ''}
${member.phone ? `<div style="margin-bottom: 8px;"><i class="fas fa-phone" style="color: var(--gold); width: 20px;"></i><span style="font-size: 0.9rem;">${escapeHtml(member.phone)}</span></div>` : ''}
</div>
<div style="border-top: 1px solid var(--border); padding-top: 10px; font-size: 0.8rem; color: var(--gold); display:flex; justify-content:space-between; align-items:center;">
<div><i class="fas fa-hand-pointer"></i> Click card to view ID & QR Code</div>
<button class="debug-toggle" style="background:transparent;border:none;color:var(--deep-green);cursor:pointer;font-size:0.8rem;" onclick="toggleDebugOverlay(event, '${escapeHtml(member.id || memberIdFrom(member))}', '${escapeHtml(debugJson)}')">Debug</button>
</div>
</div>
</div>
<div class="flip-card-back" onclick="this.parentElement.parentElement.classList.toggle('flipped')">
<div class="id-card-header"><i class="fas fa-mosque"></i><h3>MKA UGANDA</h3><div style="height: 2px; background: var(--gold); width: 100%;"></div></div>
<div class="id-card-photo">${photoUrl ? `<img src="${photoUrl}" alt="${safeFullName}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">` : `<i class="fas fa-user"></i>`}</div>
<div class="id-card-details">
<div class="id-card-detail"><i class="fas fa-user"></i><span><strong>${safeFullName}</strong></span></div>
<div class="id-card-detail"><i class="fas fa-id-card"></i><span>ID: ${safeMemberId}</span></div>
<div class="id-card-detail"><i class="fas fa-building-columns"></i><span>${safeDept}</span></div>
<div class="id-card-detail"><i class="fas fa-map-marker-alt"></i><span>${safeRegion}</span></div>
</div>
<div class="qr-code-container" id="${qrId}" style="display:flex;flex-direction:column;align-items:center;gap:6px;"><small style="color:#777;">Scan for Member Info</small></div>
<div class="id-card-footer"><span>Valid Until: Dec 2026</span><span><i class="fas fa-check-circle" style="color: var(--gold);"></i> Active Member</span></div>
<div class="flip-instruction"><i class="fas fa-undo-alt"></i> Click to flip back</div>
</div>
</div>
<div class="member-debug-overlay" id="debug-${escapeHtml(member.id || memberIdFrom(member))}" style="display:none;position:absolute;z-index:50;background:#fff;border:1px solid #ddd;padding:10px;max-width:320px;box-shadow:0 4px 12px rgba(0,0,0,0.1);"><div style="font-weight:700;margin-bottom:6px;color:var(--deep-green);">Raw member JSON</div><pre style="white-space:pre-wrap;word-break:break-word;font-size:12px;margin:0;">${debugJson}</pre></div>
</div>
`;
}).join('');
}
function toggleDebugOverlay(event, memberId, debugJson) {
event.stopPropagation();
const overlayId = `debug-${memberId}`;
const overlay = document.getElementById(overlayId);
if (!overlay) return;
overlay.style.display = overlay.style.display === 'none' ? 'block' : 'none';
const rect = event.target.getBoundingClientRect();
overlay.style.top = (rect.bottom + window.scrollY + 6) + 'px';
overlay.style.left = (rect.left + window.scrollX) + 'px';
}
function generateQROnFlip(memberId) {
const member = filteredKhuddamMembers.find(m => String(m.id) === String(memberId)) || filteredKhuddamMembers.find(m => memberIdFrom(m) === memberId);
if (!member) { console.warn('generateQROnFlip: member not found for id', memberId); return; }
const qrId = `qr-${member.id || escapeHtml(memberIdFrom(member))}`;
const qrContainer = document.getElementById(qrId);
if (qrContainer && qrContainer.childNodes.length <= 1) {
const qrData = generateMemberQRData(member);
QRCode.toCanvas(qrData, { width: 120, margin: 1, color: { dark: '#000000', light: '#ffffff' } }, (err, canvas) => {
if (err) { console.error('Error generating QR code:', err); } else {
canvas.classList.add('qr-code');
Array.from(qrContainer.childNodes).forEach(n => { if (n.tagName === 'CANVAS') qrContainer.removeChild(n); });
qrContainer.appendChild(canvas);
}
});
}
}
// ==========================
// SAMPLE DATA FUNCTIONS
// ==========================
function loadRCoursesSample() {
const container = document.getElementById('rcoursesList');
const sampleCourses = [ { id: 1, title: "Tafsir-ul-Quran", instructor: "Maulana Abdullah", level: "Advanced", duration: "12 weeks", students: 45, status: "Ongoing" }, { id: 2, title: "Seerat-un-Nabi (SAW)", instructor: "Maulana Yusuf", level: "Intermediate", duration: "8 weeks", students: 67, status: "Starting Soon" }, { id: 3, title: "Fiqh & Shariah", instructor: "Maulana Ibrahim", level: "Advanced", duration: "10 weeks", students: 38, status: "Ongoing" }, { id: 4, title: "Arabic Language", instructor: "Maulana Musa", level: "Beginner", duration: "16 weeks", students: 89, status: "Enrolling" }, { id: 5, title: "History of Ahmadiyyat", instructor: "Maulana Khalid", level: "All Levels", duration: "6 weeks", students: 112, status: "Completed" }, { id: 6, title: "Tajweed-ul-Quran", instructor: "Qari Rashid", level: "Intermediate", duration: "14 weeks", students: 56, status: "Ongoing" } ];
container.innerHTML = sampleCourses.map(course => `
<div class="sample-item" style="flex-direction: column; align-items: flex-start;">
<div style="display: flex; justify-content: space-between; width: 100%; margin-bottom: 10px;"><h3>${course.title}</h3><span class="badge">${course.level}</span></div>
<p><i class="fas fa-chalkboard-teacher" style="color: var(--gold); width: 20px;"></i> Instructor: ${course.instructor}</p>
<p><i class="fas fa-clock" style="color: var(--gold); width: 20px;"></i> Duration: ${course.duration}</p>
<p><i class="fas fa-users" style="color: var(--gold); width: 20px;"></i> Students: ${course.students}</p>
<div style="display: flex; justify-content: space-between; width: 100%; margin-top: 10px;">
<span class="status-badge ${course.status === 'Ongoing' ? 'active' : course.status === 'Completed' ? 'inactive' : ''}">${course.status}</span>
<button class="btn-manage" style="padding: 5px 15px; font-size: 0.8rem;" onclick="alert('Course details for ${course.title}')">View Details</button>
</div>
</div>`).join('');
}
function loadIjtimaSample() {
const container = document.getElementById('ijtimaList');
const sampleIjtima = [ { id: 1, title: "National Ijtema 2024", location: "Kampala", date: "2024-12-25", attendees: 1200, status: "Upcoming", type: "National" }, { id: 2, title: "Regional Ijtema - Central", location: "Masaka", date: "2024-11-15", attendees: 450, status: "Registration Open", type: "Regional" }, { id: 3, title: "Regional Ijtema - Western", location: "Mbarara", date: "2024-11-22", attendees: 380, status: "Registration Open", type: "Regional" }, { id: 4, title: "Regional Ijtema - Eastern", location: "Jinja", date: "2024-11-29", attendees: 420, status: "Planning", type: "Regional" }, { id: 5, title: "Regional Ijtema - Northern", location: "Gulu", date: "2024-12-06", attendees: 290, status: "Planning", type: "Regional" }, { id: 6, title: "National Ijtema 2023", location: "Kampala", date: "2023-12-26", attendees: 980, status: "Completed", type: "National" } ];
container.innerHTML = sampleIjtima.map(event => {
const date = new Date(event.date);
const formattedDate = date.toLocaleDateString('en-UG', { year: 'numeric', month: 'long', day: 'numeric' });
return `
<div class="sample-item" style="flex-direction: column; align-items: flex-start;">
<div style="display: flex; justify-content: space-between; width: 100%; margin-bottom: 10px;"><h3>${event.title}</h3><span class="badge">${event.type}</span></div>
<p><i class="fas fa-map-marker-alt" style="color: var(--gold); width: 20px;"></i> Location: ${event.location}</p>
<p><i class="fas fa-calendar" style="color: var(--gold); width: 20px;"></i> Date: ${formattedDate}</p>
<p><i class="fas fa-users" style="color: var(--gold); width: 20px;"></i> Expected Attendees: ${event.attendees}</p>
<div style="display: flex; justify-content: space-between; width: 100%; margin-top: 10px;">
<span class="status-badge ${event.status === 'Completed' ? 'inactive' : event.status === 'Registration Open' ? 'active' : ''}">${event.status}</span>
<button class="btn-manage" style="padding: 5px 15px; font-size: 0.8rem;" onclick="alert('Ijtema details for ${event.title}')">View Details</button>
</div>
</div>`;
}).join('');
}
function loadReportsSample() {
const container = document.getElementById('reportsList');
const sampleReports = [ { id: 1, title: "Annual Membership Report 2024", type: "Membership", generated: "2024-10-15", format: "PDF", size: "2.4 MB" }, { id: 2, title: "Regional Activity Summary - Q3 2024", type: "Activity", generated: "2024-10-01", format: "Excel", size: "1.8 MB" }, { id: 3, title: "Department Performance Analysis", type: "Performance", generated: "2024-09-28", format: "PDF", size: "3.1 MB" }, { id: 4, title: "Ijtema Attendance Statistics 2024", type: "Event", generated: "2024-09-15", format: "PDF", size: "1.5 MB" }, { id: 5, title: "Course Completion Rates", type: "Education", generated: "2024-09-10", format: "Excel", size: "0.9 MB" }, { id: 6, title: "Financial Summary - Q3 2024", type: "Financial", generated: "2024-10-05", format: "PDF", size: "4.2 MB" }, { id: 7, title: "New Member Onboarding Report", type: "Membership", generated: "2024-10-12", format: "Word", size: "1.2 MB" }, { id: 8, title: "Mosque Activity Dashboard", type: "Facility", generated: "2024-10-08", format: "PDF", size: "2.7 MB" } ];
container.innerHTML = sampleReports.map(report => {
const date = new Date(report.generated);
const formattedDate = date.toLocaleDateString('en-UG', { year: 'numeric', month: 'short', day: 'numeric' });
return `
<div class="sample-item" style="flex-direction: column; align-items: flex-start;">
<div style="display: flex; justify-content: space-between; width: 100%; margin-bottom: 10px;"><h3>${report.title}</h3><span class="badge">${report.type}</span></div>
<p><i class="fas fa-file-${report.format === 'PDF' ? 'pdf' : report.format === 'Excel' ? 'excel' : 'word'}" style="color: var(--gold); width: 20px;"></i> Format: ${report.format} (${report.size})</p>
<p><i class="fas fa-calendar-alt" style="color: var(--gold); width: 20px;"></i> Generated: ${formattedDate}</p>
<div style="display: flex; gap: 10px; width: 100%; margin-top: 10px;">
<button class="btn-manage" style="flex: 1; padding: 5px; font-size: 0.8rem;" onclick="alert('Downloading ${report.title}')"><i class="fas fa-download"></i> Download</button>
<button class="btn-manage" style="flex: 1; padding: 5px; font-size: 0.8rem; background: var(--gold);" onclick="alert('Previewing ${report.title}')"><i class="fas fa-eye"></i> Preview</button>
</div>
</div>`;
}).join('');
}
// ==========================
// SETTINGS PAGE FUNCTIONS
// ==========================
document.addEventListener('DOMContentLoaded', function() {
document.querySelectorAll('.settings-tab').forEach(tab => {
tab.addEventListener('click', function() {
const tabName = this.dataset.tab;
// REDIRECT LOGIC FOR ID CARDS
if (tabName === 'idcards') {
window.location.href = 'id-cards.html';
return;
}
// Update tab styling
document.querySelectorAll('.settings-tab').forEach(t => { t.classList.remove('active'); });
this.classList.add('active');
// Show corresponding content
document.querySelectorAll('.settings-tab-content').forEach(content => { content.style.display = 'none'; });
document.getElementById(`settings-${tabName}`).style.display = 'block';
// Load data based on tab
if (tabName === 'members') loadMembersAdmin();
if (tabName === 'departments') loadDepartmentsAdmin();
if (tabName === 'regions') loadRegionsAdmin();
if (tabName === 'mosques') loadMosquesAdmin();
if (tabName === 'idcards') loadIDCardData();
});
});
});
async function loadSettingsStats() {
try {
const { count: members } = await supabaseClient.from('members').select('*', { count: 'exact', head: true });
const { count: depts } = await supabaseClient.from('departments').select('*', { count: 'exact', head: true });
const { count: regions } = await supabaseClient.from('regions').select('*', { count: 'exact', head: true });
const { count: mosques } = await supabaseClient.from('mosques').select('*', { count: 'exact', head: true });
const { count: courses } = await supabaseClient.from('rcourses').select('*', { count: 'exact', head: true });
document.getElementById('statTotalMembers').textContent = members || 0;
document.getElementById('statTotalDepts').textContent = depts || 0;
document.getElementById('statTotalRegions').textContent = regions || 0;
document.getElementById('statTotalMosques').textContent = mosques || 0;
document.getElementById('statTotalCourses').textContent = courses || 0;
} catch (error) { console.error('Error loading stats:', error); }
}
async function loadMembersAdmin() {
const tbody = document.getElementById('membersTableBody');
try {
const { data: members, error } = await supabaseClient.from('members').select('*, departments(name)').order('full_name');
if (error) throw error;
const deptFilter = document.getElementById('memberDeptFilter');
const departments = [...new Set(members.map(m => m.departments?.name).filter(Boolean))];
deptFilter.innerHTML = '<option value="all">All Departments</option>' + departments.map(d => `<option value="${d}">${d}</option>`).join('');
tbody.innerHTML = members.map(member => {
const statusStyle = getStatusStyle(member.status);
return `
<tr>
<td style="padding: 12px;">${member.member_id || 'N/A'}</td>
<td style="padding: 12px; font-weight: 600;">${member.full_name}</td>
<td style="padding: 12px;">${member.departments?.name || 'Not assigned'}</td>
<td style="padding: 12px;">${member.region || 'N/A'}</td>
<td style="padding: 12px;"><span class="status-badge ${statusStyle.class}"><i class="fas ${statusStyle.icon}"></i> ${member.status || 'Active'}</span></td>
<td style="padding: 12px;">
<button class="btn-manage" style="padding: 5px 10px; font-size: 0.8rem;" onclick="editMember('${member.id}')"><i class="fas fa-edit"></i></button>
<button class="btn-manage" style="padding: 5px 10px; font-size: 0.8rem; background: #dc3545;" onclick="deleteMember('${member.id}')"><i class="fas fa-trash"></i></button>
<button class="btn-manage" style="padding: 5px 10px; font-size: 0.8rem; background: var(--gold);" onclick="printSingleID('${member.id}')"><i class="fas fa-id-card"></i></button>
</td>
</tr>`;
}).join('');
document.getElementById('memberSearchAdmin').addEventListener('input', filterMembersAdmin);
document.getElementById('memberDeptFilter').addEventListener('change', filterMembersAdmin);
document.getElementById('memberStatusFilter').addEventListener('change', filterMembersAdmin);
} catch (error) {
console.error('Error loading members admin:', error);
tbody.innerHTML = '<tr><td colspan="6" style="color: red; padding: 30px;">Failed to load members</td></tr>';
}
}
function filterMembersAdmin() {
const searchTerm = document.getElementById('memberSearchAdmin').value.toLowerCase();
const deptFilter = document.getElementById('memberDeptFilter').value;
const statusFilter = document.getElementById('memberStatusFilter').value;
const rows = document.querySelectorAll('#membersTableBody tr');
rows.forEach(row => {
const name = row.cells[1]?.textContent.toLowerCase() || '';
const dept = row.cells[2]?.textContent || '';
const status = row.cells[4]?.querySelector('.status-badge')?.textContent.trim().toLowerCase() || '';
const matchesSearch = name.includes(searchTerm);
const matchesDept = deptFilter === 'all' || dept === deptFilter;
const matchesStatus = statusFilter === 'all' || status.includes(statusFilter);
row.style.display = matchesSearch && matchesDept && matchesStatus ? '' : 'none';
});
}
window.openMemberModal = async function(mode, memberId = null) {
const modal = document.getElementById('memberModal');
const title = document.getElementById('memberModalTitle');
await loadDepartmentDropdown();
await loadRegionDropdown();
if (mode === 'add') {
title.textContent = 'Add New Member';
document.getElementById('memberForm').reset();
document.getElementById('memberId').value = '';
generateMemberId();
} else {
title.textContent = 'Edit Member';
const { data: member, error } = await supabaseClient.from('members').select('*').eq('id', memberId).single();
if (member) {
document.getElementById('memberId').value = member.id;
document.getElementById('memberName').value = member.full_name || '';
document.getElementById('memberIdNumber').value = member.member_id || '';
document.getElementById('memberEmail').value = member.email || '';
document.getElementById('memberPhone').value = member.phone || '';
document.getElementById('memberDepartment').value = member.department || '';
document.getElementById('memberRegion').value = member.region || '';
document.getElementById('memberSubRegion').value = member.sub_region || '';
document.getElementById('memberStatus').value = member.status || 'active';
document.getElementById('memberAddress').value = member.address || '';
document.getElementById('memberPhoto').value = member.photo_url || '';
if (member.region) {
const { data: region } = await supabaseClient.from('regions').select('id').eq('name', member.region).single();
if (region) {
const { data: subRegions } = await supabaseClient.from('sub_regions').select('name').eq('region_id', region.id);
const subSelect = document.getElementById('memberSubRegion');
subSelect.innerHTML = '<option value="">Select Sub-Region</option>' + (subRegions || []).map(s => `<option value="${s.name}" ${s.name === member.sub_region ? 'selected' : ''}>${s.name}</option>`).join('');
}
}
}
}
modal.classList.add('active');
}
window.editMember = function(memberId) { openMemberModal('edit', memberId); }
window.deleteMember = async function(memberId) {
if (confirm('Are you sure you want to delete this member? This action cannot be undone.')) {
try {
const { error } = await supabaseClient.from('members').delete().eq('id', memberId);
if (error) throw error;
loadMembersAdmin();
loadSettingsStats();
loadKhuddamMembers();
alert('Member deleted successfully');
} catch (error) {
console.error('Error deleting member:', error);
alert('Failed to delete member: ' + error.message);
}
}
}
document.getElementById('memberForm')?.addEventListener('submit', async (e) => {
e.preventDefault();
const memberId = document.getElementById('memberId').value;
const memberIdNumber = document.getElementById('memberIdNumber').value;
const finalMemberId = memberIdNumber || await generateMemberIdPromise();
const memberData = {
full_name: document.getElementById('memberName').value,
member_id: finalMemberId,
email: document.getElementById('memberEmail').value || null,
phone: document.getElementById('memberPhone').value || null,
department: document.getElementById('memberDepartment').value || null,
region: document.getElementById('memberRegion').value || null,
sub_region: document.getElementById('memberSubRegion').value || null,
status: document.getElementById('memberStatus').value,
address: document.getElementById('memberAddress').value || null,
photo_url: document.getElementById('memberPhoto').value || null
};
try {
let error;
if (memberId) {
const { error: updateError } = await supabaseClient.from('members').update(memberData).eq('id', memberId);
error = updateError;
} else {
const { error: insertError } = await supabaseClient.from('members').insert([memberData]);
error = insertError;
}
if (error) throw error;
closeModal('memberModal');
loadMembersAdmin();
loadSettingsStats();
loadKhuddamMembers();
alert(`Member ${memberId ? 'updated' : 'added'} successfully!`);
} catch (error) {
console.error('Error saving member:', error);
alert('Failed to save member: ' + error.message);
}
});
async function generateMemberIdPromise() {
const prefix = "MKA-UG";
const timestamp = Date.now().toString().slice(-6);
const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
return `${prefix}-${timestamp}${random}`;
}
window.openDepartmentModal = async function(mode, deptId = null) {
const modal = document.getElementById('departmentModal');
const title = document.getElementById('departmentModalTitle');
if (mode === 'add') {
title.textContent = 'Add New Department';
document.getElementById('departmentForm').reset();
document.getElementById('departmentId').value = '';
} else {
title.textContent = 'Edit Department';
const { data: dept, error } = await supabaseClient.from('departments').select('*').eq('id', deptId).single();
if (dept) {
document.getElementById('departmentId').value = dept.id;
document.getElementById('departmentName').value = dept.name || '';
document.getElementById('departmentDescription').value = dept.description || '';
document.getElementById('departmentStatus').value = dept.status || 'active';
}
}
modal.classList.add('active');
}
document.getElementById('departmentForm')?.addEventListener('submit', async (e) => {
e.preventDefault();
const deptData = { name: document.getElementById('departmentName').value, description: document.getElementById('departmentDescription').value || null, status: document.getElementById('departmentStatus').value };
const deptId = document.getElementById('departmentId').value;
try {
let error;
if (deptId) {
const { error: updateError } = await supabaseClient.from('departments').update(deptData).eq('id', deptId);
error = updateError;
} else {
const { error: insertError } = await supabaseClient.from('departments').insert([deptData]);
error = insertError;
}
if (error) throw error;
closeModal('departmentModal');
loadDepartmentsAdmin();
loadSettingsStats();
alert(`Department ${deptId ? 'updated' : 'added'} successfully!`);
} catch (error) {
console.error('Error saving department:', error);
alert('Failed to save department: ' + error.message);
}
});
async function loadDepartmentDropdown() {
try {
const { data: departments, error } = await supabaseClient.from('departments').select('name').order('name');
if (error) throw error;
const select = document.getElementById('memberDepartment');
if (select) { select.innerHTML = '<option value="">Select Department</option>' + (departments || []).map(d => `<option value="${d.name}">${d.name}</option>`).join(''); }
} catch (error) { console.error('Error loading departments:', error); }
}
async function loadRegionDropdown() {
try {
const { data: regions, error } = await supabaseClient.from('regions').select('name').order('name');
if (error) throw error;
const regionSelect = document.getElementById('memberRegion');
if (regionSelect) {
regionSelect.innerHTML = '<option value="">Select Region</option>' + (regions || []).map(r => `<option value="${r.name}">${r.name}</option>`).join('');
regionSelect.removeEventListener('change', loadSubRegionsForRegion);
regionSelect.addEventListener('change', loadSubRegionsForRegion);
}
} catch (error) { console.error('Error loading regions:', error); }
}
async function loadSubRegionsForRegion(e) {
const regionName = e.target.value;
const subSelect = document.getElementById('memberSubRegion');
if (!regionName) { subSelect.innerHTML = '<option value="">Select Sub-Region</option>'; return; }
try {
const { data: region, error: regionError } = await supabaseClient.from('regions').select('id').eq('name', regionName).single();
if (regionError) throw regionError;
if (region) {
const { data: subRegions, error: subError } = await supabaseClient.from('sub_regions').select('name').eq('region_id', region.id).order('name');
if (subError) throw subError;
subSelect.innerHTML = '<option value="">Select Sub-Region</option>' + (subRegions || []).map(s => `<option value="${s.name}">${s.name}</option>`).join('');
}
} catch (error) { console.error('Error loading sub-regions:', error); }
}
async function loadDepartmentsAdmin() {
const container = document.getElementById('departmentsListAdmin');
try {
const { data: departments, error } = await supabaseClient.from('departments').select('*').order('name');
if (error) throw error;
if (!departments || departments.length === 0) { container.innerHTML = '<p style="text-align:center; color:#777;">No departments found.</p>'; return; }
container.innerHTML = departments.map(dept => {
const statusStyle = getStatusStyle(dept.status);
return `
<div style="background: #f8f9fa; padding: 15px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
<div>
<h4 style="color: var(--deep-green); margin-bottom: 5px;">${dept.name}</h4>
<p style="color: #666; font-size: 0.9rem;">${dept.description || 'No description'}</p>
<span class="status-badge ${statusStyle.class}" style="margin-top: 5px; display: inline-block;"><i class="fas ${statusStyle.icon}"></i> ${dept.status || 'Active'}</span>
</div>
<div>
<button class="btn-manage" style="padding: 5px 10px;" onclick="openDepartmentModal('edit', '${dept.id}')"><i class="fas fa-edit"></i></button>
<button class="btn-manage" style="padding: 5px 10px; background: #dc3545;" onclick="deleteDepartment('${dept.id}')"><i class="fas fa-trash"></i></button>
</div>
</div>`;
}).join('');
} catch (error) {
console.error('Error loading departments admin:', error);
container.innerHTML = '<p style="color: red; text-align: center;">Failed to load departments.</p>';
}
}
window.deleteDepartment = async function(deptId) {
if (confirm('Are you sure you want to delete this department?')) {
try {
const { error } = await supabaseClient.from('departments').delete().eq('id', deptId);
if (error) throw error;
loadDepartmentsAdmin();
loadSettingsStats();
alert('Department deleted successfully');
} catch (error) {
console.error('Error deleting department:', error);
alert('Failed to delete department: ' + error.message);
}
}
}
async function loadRegionsAdmin() {
const container = document.getElementById('regionsListAdmin');
try {
const { data: regions, error } = await supabaseClient.from('regions').select('*').order('name');
if (error) throw error;
if (!regions || regions.length === 0) { container.innerHTML = '<p style="text-align:center; color:#777;">No regions found.</p>'; return; }
container.innerHTML = regions.map(region => `
<div style="background: #f8f9fa; padding: 15px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
<div>
<h4 style="color: var(--deep-green); margin-bottom: 5px;">${region.name}</h4>
<p style="color: #666; font-size: 0.9rem;">${region.description || 'No description'}</p>
${region.code ? `<span style="background: var(--gold); color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.8rem;">${region.code}</span>` : ''}
</div>
<div>
<button class="btn-manage" style="padding: 5px 10px;" onclick="openRegionModal('edit', '${region.id}')"><i class="fas fa-edit"></i></button>
<button class="btn-manage" style="padding: 5px 10px; background: #dc3545;" onclick="deleteRegion('${region.id}')"><i class="fas fa-trash"></i></button>
</div>
</div>`).join('');
} catch (error) {
console.error('Error loading regions admin:', error);
container.innerHTML = '<p style="color: red; text-align: center;">Failed to load regions.</p>';
}
}
window.openRegionModal = async function(mode, regionId = null) {
const modal = document.getElementById('regionModal');
const title = document.getElementById('regionModalTitle');
if (mode === 'add') {
title.textContent = 'Add Region';
document.getElementById('regionForm').reset();
document.getElementById('regionId').value = '';
} else {
title.textContent = 'Edit Region';
const { data: region, error } = await supabaseClient.from('regions').select('*').eq('id', regionId).single();
if (region) {
document.getElementById('regionId').value = region.id;
document.getElementById('regionName').value = region.name || '';
document.getElementById('regionCode').value = region.code || '';
document.getElementById('regionDescription').value = region.description || '';
}
}
modal.classList.add('active');
}
document.getElementById('regionForm')?.addEventListener('submit', async (e) => {
e.preventDefault();
const regionData = { name: document.getElementById('regionName').value, code: document.getElementById('regionCode').value || null, description: document.getElementById('regionDescription').value || null };
const regionId = document.getElementById('regionId').value;
try {
let error;
if (regionId) {
const { error: updateError } = await supabaseClient.from('regions').update(regionData).eq('id', regionId);
error = updateError;
} else {
const { error: insertError } = await supabaseClient.from('regions').insert([regionData]);
error = insertError;
}
if (error) throw error;
closeModal('regionModal');
loadRegionsAdmin();
loadSettingsStats();
loadRegionDropdown();
alert(`Region ${regionId ? 'updated' : 'added'} successfully!`);
} catch (error) {
console.error('Error saving region:', error);
alert('Failed to save region: ' + error.message);
}
});
window.deleteRegion = async function(regionId) {
if (confirm('Are you sure you want to delete this region?')) {
try {
const { error } = await supabaseClient.from('regions').delete().eq('id', regionId);
if (error) throw error;
loadRegionsAdmin();
loadSettingsStats();
loadRegionDropdown();
alert('Region deleted successfully');
} catch (error) {
console.error('Error deleting region:', error);
alert('Failed to delete region: ' + error.message);
}
}
}
window.openSubRegionModal = async function(mode, subRegionId = null) {
const modal = document.getElementById('subRegionModal');
const title = document.getElementById('subRegionModalTitle');
try {
const { data: regions, error } = await supabaseClient.from('regions').select('id, name').order('name');
if (error) throw error;
const parentSelect = document.getElementById('parentRegion');
parentSelect.innerHTML = '<option value="">Select Region</option>' + (regions || []).map(r => `<option value="${r.id}">${r.name}</option>`).join('');
if (mode === 'add') {
title.textContent = 'Add Sub-Region';
document.getElementById('subRegionForm').reset();
document.getElementById('subRegionId').value = '';
} else {
title.textContent = 'Edit Sub-Region';
const { data: subRegion, error: subError } = await supabaseClient.from('sub_regions').select('*').eq('id', subRegionId).single();
if (subError) throw subError;
if (subRegion) {
document.getElementById('subRegionId').value = subRegion.id;
document.getElementById('parentRegion').value = subRegion.region_id;
document.getElementById('subRegionName').value = subRegion.name || '';
document.getElementById('subRegionLocation').value = subRegion.location || '';
}
}
} catch (error) {
console.error('Error loading regions for sub-region:', error);
alert('Failed to load regions');
return;
}
modal.classList.add('active');
}
document.getElementById('subRegionForm')?.addEventListener('submit', async (e) => {
e.preventDefault();
const subRegionData = { region_id: document.getElementById('parentRegion').value, name: document.getElementById('subRegionName').value, location: document.getElementById('subRegionLocation').value || null };
const subRegionId = document.getElementById('subRegionId').value;
try {
let error;
if (subRegionId) {
const { error: updateError } = await supabaseClient.from('sub_regions').update(subRegionData).eq('id', subRegionId);
error = updateError;
} else {
const { error: insertError } = await supabaseClient.from('sub_regions').insert([subRegionData]);
error = insertError;
}
if (error) throw error;
closeModal('subRegionModal');
alert(`Sub-region ${subRegionId ? 'updated' : 'added'} successfully!`);
if (document.getElementById('regions').classList.contains('active')) { loadRegions(); }
} catch (error) {
console.error('Error saving sub-region:', error);
alert('Failed to save sub-region: ' + error.message);
}
});
async function loadMosquesAdmin() {
const container = document.getElementById('mosquesListAdmin');
try {
const { data: mosques, error } = await supabaseClient.from('mosques').select('id, name, imam_name, address, regions(name), subregions(name)').order('name');
if (error) throw error;
if (!mosques || mosques.length === 0) { container.innerHTML = '<p style="text-align:center; color:#777;">No mosques found.</p>'; return; }
container.innerHTML = mosques.map(mosque => `
<div style="background: #f8f9fa; padding: 15px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
<div>
<h4 style="color: var(--deep-green); margin-bottom: 5px;">${mosque.name}</h4>
<p style="color: #666; font-size: 0.9rem;"><i class="fas fa-map-marker-alt" style="color: var(--gold);"></i> ${mosque.regions?.name || 'No region'} | ${mosque.subregions?.name || 'No subregion'} | Imam: ${mosque.imam_name || 'Not assigned'}</p>
</div>
<div>
<button class="btn-manage" style="padding: 5px 10px;" onclick="openMosqueModal('edit', '${mosque.id}')"><i class="fas fa-edit"></i></button>
<button class="btn-manage" style="padding: 5px 10px; background: #dc3545;" onclick="deleteMosque('${mosque.id}')"><i class="fas fa-trash"></i></button>
</div>
</div>`).join('');
} catch (error) {
console.error('Error loading mosques admin:', error);
container.innerHTML = '<p style="color: red; text-align: center;">Failed to load mosques.</p>';
}
}
window.openMosqueModal = async function(mode, mosqueId = null) {
const modal = document.getElementById('mosqueModal');
const title = document.getElementById('mosqueModalTitle');
try {
const { data: regions, error } = await supabaseClient.from('regions').select('id, name').order('name');
if (error) throw error;
const regionSelect = document.getElementById('mosqueRegion');
regionSelect.innerHTML = '<option value="">Select Region</option>' + (regions || []).map(r => `<option value="${r.id}">${r.name}</option>`).join('');
if (mode === 'add') {
title.textContent = 'Add Mosque';
document.getElementById('mosqueForm').reset();
document.getElementById('mosqueId').value = '';
} else {
title.textContent = 'Edit Mosque';
const { data: mosque, error: mosqueError } = await supabaseClient.from('mosques').select('*').eq('id', mosqueId).single();
if (mosqueError) throw mosqueError;
if (mosque) {
document.getElementById('mosqueId').value = mosque.id;
document.getElementById('mosqueName').value = mosque.name || '';
document.getElementById('mosqueRegion').value = mosque.region_id || '';
document.getElementById('mosqueSubRegion').value = mosque.subregion_id || '';
document.getElementById('mosqueAddress').value = mosque.address || '';
document.getElementById('mosqueImam').value = mosque.imam_name || '';
if (mosque.region_id) {
const { data: subRegions } = await supabaseClient.from('subregions').select('id, name').eq('region_id', mosque.region_id).order('name');
const subSelect = document.getElementById('mosqueSubRegion');
subSelect.innerHTML = '<option value="">Select Sub-Region</option>' + (subRegions || []).map(s => `<option value="${s.id}" ${s.id === mosque.subregion_id ? 'selected' : ''}>${s.name}</option>`).join('');
}
}
}
document.getElementById('mosqueRegion').removeEventListener('change', loadMosqueSubRegions);
document.getElementById('mosqueRegion').addEventListener('change', loadMosqueSubRegions);
} catch (error) {
console.error('Error loading regions for mosque:', error);
alert('Failed to load regions');
return;
}
modal.classList.add('active');
}
async function loadMosqueSubRegions(e) {
const regionId = e.target.value;
const subSelect = document.getElementById('mosqueSubRegion');
if (!regionId) { subSelect.innerHTML = '<option value="">Select Sub-Region</option>'; return; }
try {
const { data: subRegions, error } = await supabaseClient.from('subregions').select('id, name').eq('region_id', regionId).order('name');
if (error) throw error;
subSelect.innerHTML = '<option value="">Select Sub-Region</option>' + (subRegions || []).map(s => `<option value="${s.id}">${s.name}</option>`).join('');
} catch (error) { console.error('Error loading sub-regions:', error); }
}
document.getElementById('mosqueForm')?.addEventListener('submit', async (e) => {
e.preventDefault();
const mosqueData = { name: document.getElementById('mosqueName').value, region_id: document.getElementById('mosqueRegion').value || null, subregion_id: document.getElementById('mosqueSubRegion').value || null, address: document.getElementById('mosqueAddress').value || null, imam_name: document.getElementById('mosqueImam').value || null };
const mosqueId = document.getElementById('mosqueId').value;
try {
let error;
if (mosqueId) {
const { error: updateError } = await supabaseClient.from('mosques').update(mosqueData).eq('id', mosqueId);
error = updateError;
} else {
const { error: insertError } = await supabaseClient.from('mosques').insert([mosqueData]);
error = insertError;
}
if (error) throw error;
closeModal('mosqueModal');
loadMosquesAdmin();
loadSettingsStats();
alert(`Mosque ${mosqueId ? 'updated' : 'added'} successfully!`);
} catch (error) {
console.error('Error saving mosque:', error);
alert('Failed to save mosque: ' + error.message);
}
});
window.deleteMosque = async function(mosqueId) {
if (confirm('Are you sure you want to delete this mosque?')) {
try {
const { error } = await supabaseClient.from('mosques').delete().eq('id', mosqueId);
if (error) throw error;
loadMosquesAdmin();
loadSettingsStats();
alert('Mosque deleted successfully');
} catch (error) {
console.error('Error deleting mosque:', error);
alert('Failed to delete mosque: ' + error.message);
}
}
}
async function loadIDCardData() {
try {
const { data: members, error: memberError } = await supabaseClient.from('members').select('id, full_name').order('full_name');
if (memberError) throw memberError;
const singleSelect = document.getElementById('singleMemberSelect');
if (singleSelect) { singleSelect.innerHTML = '<option value="">Select Member</option>' + (members || []).map(m => `<option value="${m.id}">${m.full_name}</option>`).join(''); }
const { data: regions, error: regionError } = await supabaseClient.from('regions').select('name').order('name');
if (regionError) throw regionError;
const regionSelect = document.getElementById('bulkRegionSelect');
if (regionSelect) { regionSelect.innerHTML = '<option value="all">All Regions</option>' + (regions || []).map(r => `<option value="${r.name}">${r.name}</option>`).join(''); }
} catch (error) { console.error('Error loading ID card data:', error); }
}
window.printSingleID = function(memberId = null) {
const id = memberId || document.getElementById('singleMemberSelect')?.value;
if (!id) { alert('Please select a member'); return; }
alert(`Printing ID card for member ID: ${id}\nThis would generate a printable ID card.`);
}
window.printBulkIDs = function() {
const region = document.getElementById('bulkRegionSelect')?.value;
const status = document.getElementById('bulkStatusSelect')?.value;
alert(`Printing bulk ID cards\nRegion: ${region}\nStatus: ${status}\nThis would generate a PDF with multiple ID cards.`);
}
window.backupData = function() { alert('Downloading system backup...\nThis would export all data as JSON.'); }
window.restoreData = function() { alert('Restore from backup feature\nPlease select a backup file to restore.'); }
window.exportLogs = function() { alert('Exporting activity logs...\nThis would download system logs as CSV.'); }
window.closeModal = function(modalId) { document.getElementById(modalId).classList.remove('active'); }
window.addEventListener('click', (e) => { if (e.target.classList.contains('modal')) { e.target.classList.remove('active'); } });
window.viewMemberDetails = function(memberId) { alert(`View details for member ID: ${memberId}\nThis will open a detailed member profile page.`); }
function setupStatusFilters() {
const filterBtns = document.querySelectorAll('.status-filter-btn');
const departmentCards = document.querySelectorAll('.department-card');
if (!filterBtns.length || !departmentCards.length) return;
filterBtns.forEach(btn => {
btn.addEventListener('click', () => {
filterBtns.forEach(b => b.classList.remove('active'));
btn.classList.add('active');
const status = btn.dataset.status;
departmentCards.forEach(card => {
const statusBadge = card.querySelector('.status-badge');
if (!statusBadge) return;
const cardStatus = statusBadge.classList.contains('active') ? 'active' : statusBadge.classList.contains('inactive') ? 'inactive' : statusBadge.classList.contains('pending') ? 'pending' : statusBadge.classList.contains('suspended') ? 'suspended' : '';
if (status === 'all' || cardStatus === status) { card.style.display = 'block'; } else { card.style.display = 'none'; }
});
});
});
}
async function loadDepartments() {
const container = document.getElementById('departmentsList');
container.innerHTML = `<i class="fas fa-spinner fa-spin fa-3x"></i><p style="margin-top:15px; color:#777;">Loading departments...</p>`;
const { data: departments, error: deptError } = await supabaseClient.from('departments').select('*').order('created_at', { ascending: true });
if (deptError) { container.innerHTML = `<div style="color:red; padding:20px;">Failed to load departments. Please try again.</div>`; console.error(deptError); return; }
if (!departments || departments.length === 0) { container.innerHTML = `<div style="padding:40px; text-align:center; color:#777;">No departments found.</div>`; return; }
const departmentsWithCounts = await Promise.all(
departments.map(async (dept) => {
const { count, error } = await supabaseClient.from('members').select('*', { count: 'exact', head: true }).eq('department', dept.name);
const memberCount = count || 0;
let status = dept.status ? dept.status.toLowerCase() : 'active';
return { ...dept, memberCount: memberCount, status: status };
})
);
const filtersHTML = `<div class="status-filters"><button class="status-filter-btn active" data-status="all">All Departments</button><button class="status-filter-btn" data-status="active">Active</button><button class="status-filter-btn" data-status="inactive">Inactive</button><button class="status-filter-btn" data-status="pending">Pending</button><button class="status-filter-btn" data-status="suspended">Suspended</button></div>`;
const departmentsHTML = departmentsWithCounts.map(dept => {
const statusStyle = getStatusStyle(dept.status);
const departmentClass = dept.status === 'active' ? 'active-department' : dept.status === 'inactive' ? 'inactive-department' : dept.status === 'pending' ? 'pending-department' : '';
return `
<div class="department-card ${departmentClass}" style="border-left-color: ${statusStyle.borderColor};">
<div class="department-header">
<h3><i class="fas fa-building-columns"></i> ${dept.name}</h3>
<span class="status-badge ${statusStyle.class}"><i class="fas ${statusStyle.icon}"></i> ${dept.status || 'Active'}</span>
</div>
<p>${dept.description || 'No description available'}</p>
<div class="department-stats" style="background: ${statusStyle.bg}40;">
<span><i class="fas fa-users"></i> <strong>${dept.memberCount}</strong> member${dept.memberCount !== 1 ? 's' : ''}</span>
${dept.created_at ? `<span><i class="fas fa-calendar"></i> Created: ${new Date(dept.created_at).toLocaleDateString()}</span>` : ''}
</div>
<div class="department-actions">
<button class="btn-manage" onclick="window.open('department_${dept.id}.html', '_blank')"><i class="fas fa-external-link-alt"></i> Manage Department</button>
</div>
</div>`;
}).join('');
container.innerHTML = filtersHTML + departmentsHTML;
setupStatusFilters();
}
async function loadRegions() {
const container = document.getElementById('regionsList');
container.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Loading regions...`;
try {
const { data: regions, error } = await supabaseClient.from('regions').select('*').order('name');
if (error) throw error;
if (!regions || regions.length === 0) { container.innerHTML = `<div style="padding:40px; text-align:center; color:#777;">No regions found.</div>`; return; }
const regionsWithDetails = await Promise.all(
regions.map(async (region) => {
const { data: subRegions } = await supabaseClient.from('sub_regions').select('*').eq('region_id', region.id);
const { count: memberCount } = await supabaseClient.from('members').select('*', { count: 'exact', head: true }).eq('region', region.name);
const { count: mosqueCount } = await supabaseClient.from('mosques').select('*', { count: 'exact', head: true }).eq('region', region.name);
const subWithCounts = subRegions ? await Promise.all(
subRegions.map(async (sub) => {
const { count } = await supabaseClient.from('members').select('*', { count: 'exact', head: true }).eq('sub_region', sub.name);
return { ...sub, member_count: count || 0 };
})
) : [];
return { ...region, sub_regions: subWithCounts, sub_regions_count: subRegions?.length || 0, member_count: memberCount || 0, mosque_count: mosqueCount || 0 };
})
);
const regionsHTML = regionsWithDetails.map(region => {
const previewSubRegions = region.sub_regions.slice(0, 3);
const remainingCount = region.sub_regions_count - 3;
return `
<div class="region-card" data-region-id="${region.id}" data-region-name="${region.name}">
<div class="region-header">
<h3><i class="fas fa-map-marked-alt"></i> ${region.name}</h3>
<span class="region-badge">${region.code || 'REG'}</span>
</div>
<div class="region-description">${region.description || 'No description available'}</div>
<div class="region-stats">
<div class="region-stat-item" onclick="showSubRegions('${region.id}', '${region.name}')"><i class="fas fa-map"></i><div class="stat-label">Sub-Regions</div><div class="stat-value">${region.sub_regions_count}</div></div>
<div class="region-stat-item" onclick="showRegionMembers('${region.name}')"><i class="fas fa-users"></i><div class="stat-label">Members</div><div class="stat-value">${region.member_count}</div></div>
<div class="region-stat-item" onclick="showRegionMosques('${region.name}')"><i class="fas fa-mosque"></i><div class="stat-label">Mosques</div><div class="stat-value">${region.mosque_count}</div></div>
</div>
${region.sub_regions_count > 0 ? `<div class="sub-regions-preview">${previewSubRegions.map(sub => `<span class="sub-region-tag"><i class="fas fa-circle"></i> ${sub.name}</span>`).join('')}${remainingCount > 0 ? `<span class="sub-region-tag more">+${remainingCount} more</span>` : ''}</div>` : ''}
</div>`;
}).join('');
container.innerHTML = regionsHTML;
} catch (error) {
console.error('Error loading regions:', error);
container.innerHTML = `<div style="color:red; padding:20px;">Failed to load regions.</div>`;
}
}
window.showSubRegions = async function(regionId, regionName) {
const modal = document.getElementById('subregionModal');
const title = document.getElementById('subregionModalTitle');
const body = document.getElementById('subregionModalBody');
title.innerHTML = `<i class="fas fa-map-pin"></i> Sub-Regions of ${regionName}`;
const { data: subRegions } = await supabaseClient.from('sub_regions').select('*').eq('region_id', regionId);
if (!subRegions || subRegions.length === 0) { body.innerHTML = '<p style="text-align:center; color:#777;">No sub-regions found.</p>'; } else {
const subWithCounts = await Promise.all(
subRegions.map(async (sub) => {
const { count } = await supabaseClient.from('members').select('*', { count: 'exact', head: true }).eq('sub_region', sub.name);
return { ...sub, member_count: count || 0 };
})
);
body.innerHTML = subWithCounts.map(sub => `
<div class="sub-region-item">
<div class="sub-region-info"><h4>${sub.name}</h4><p><i class="fas fa-map-marker-alt"></i> ${sub.location || 'Location not specified'}</p></div>
<div class="sub-region-stats"><div class="sub-region-stat"><div class="stat-number">${sub.member_count}</div><div class="stat-label">Members</div></div></div>
</div>`).join('');
}
modal.classList.add('active');
};
window.showRegionMembers = async function(regionName) {
const modal = document.getElementById('regionMembersModal');
const title = document.getElementById('regionMembersModalTitle');
const body = document.getElementById('regionMembersModalBody');
title.innerHTML = `<i class="fas fa-users"></i> Members in ${regionName}`;
const { data: members } = await supabaseClient.from('members').select('*').eq('region', regionName).order('full_name');
if (!members || members.length === 0) { body.innerHTML = '<p style="text-align:center; color:#777;">No members found in this region.</p>'; } else {
body.innerHTML = members.map(m => `
<div class="sub-region-item">
<div class="sub-region-info"><h4>${m.full_name}</h4><p><i class="fas fa-id-card"></i> ${m.member_id} â€¢ ${m.status || 'Active'}</p></div>
<div class="sub-region-stats"><div class="member-subregion"><i class="fas fa-map-pin"></i> ${m.sub_region || 'Main'}</div></div>
</div>`).join('');
}
modal.classList.add('active');
};
window.showRegionMosques = async function(regionName) {
const modal = document.getElementById('regionMosquesModal');
const title = document.getElementById('regionMosquesModalTitle');
const body = document.getElementById('regionMosquesModalBody');
title.innerHTML = `<i class="fas fa-mosque"></i> Mosques in ${regionName}`;
const { data: mosques } = await supabaseClient.from('mosques').select('*').eq('region', regionName).order('name');
if (!mosques || mosques.length === 0) { body.innerHTML = '<p style="text-align:center; color:#777;">No mosques found in this region.</p>'; } else {
body.innerHTML = mosques.map(m => `
<div class="sub-region-item">
<div class="sub-region-info"><h4>${m.name}</h4><p><i class="fas fa-map-marker-alt"></i> ${m.sub_region || 'Main'} â€¢ Imam: ${m.imam_name || 'Not assigned'}</p></div>
<div class="sub-region-stats">${m.address || ''}</div>
</div>`).join('');
}
modal.classList.add('active');
};
async function initCharts() {
try {
const { data: members } = await supabaseClient.from('members').select('region, status');
const { data: scans } = await supabaseClient.from('scans').select('created_at').order('created_at');
const regionCounts = {};
const regionActivity = {};
members?.forEach(m => {
if (m.region) {
regionCounts[m.region] = (regionCounts[m.region] || 0) + 1;
if (m.status === 'active') { regionActivity[m.region] = (regionActivity[m.region] || 0) + 1; }
}
});
const topRegions = Object.entries(regionCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);
const regionLabels = topRegions.map(([region]) => region);
const regionData = topRegions.map(([, count]) => count);
const last7Days = [];
const dayLabels = [];
for (let i = 6; i >= 0; i--) {
const d = new Date();
d.setDate(d.getDate() - i);
dayLabels.push(d.toLocaleDateString('en-US', { weekday: 'short' }));
last7Days.push(0);
}
scans?.forEach(scan => {
const scanDate = new Date(scan.created_at);
const today = new Date();
const diffDays = Math.floor((today - scanDate) / (1000 * 60 * 60 * 24));
if (diffDays >= 0 && diffDays < 7) { last7Days[6 - diffDays]++; }
});
const activeRegionData = Object.entries(regionActivity).sort((a, b) => b[1] - a[1]).slice(0, 4).map(([, count]) => count);
const otherActive = Object.entries(regionActivity).slice(4).reduce((sum, [, count]) => sum + count, 0);
if (otherActive > 0) { activeRegionData.push(otherActive); }
const activeLabels = topRegions.slice(0, 4).map(([region]) => region);
if (otherActive > 0) { activeLabels.push('Others'); }
if (scans && scans.length > 0) {
const lastScan = new Date(scans[scans.length - 1].created_at);
const now = new Date();
const diffHours = Math.floor((now - lastScan) / (1000 * 60 * 60));
if (diffHours < 24) { document.getElementById('lastScan').textContent = `Today, ${lastScan.toLocaleTimeString('en-UG', { hour: '2-digit', minute: '2-digit' })}`; } else if (diffHours < 48) { document.getElementById('lastScan').textContent = 'Yesterday'; } else { document.getElementById('lastScan').textContent = lastScan.toLocaleDateString(); }
}
const ctx1 = document.getElementById('membersRegionChart').getContext('2d');
if (window.chart1) window.chart1.destroy();
window.chart1 = new Chart(ctx1, { type: 'bar', data: { labels: regionLabels, datasets: [{ data: regionData, backgroundColor: 'rgba(184, 155, 94, 0.7)', borderColor: 'rgba(184, 155, 94, 1)', borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' } }, x: { grid: { display: false } } } } });
const ctx2 = document.getElementById('scanTrendChart').getContext('2d');
if (window.chart2) window.chart2.destroy();
window.chart2 = new Chart(ctx2, { type: 'line', data: { labels: dayLabels, datasets: [{ data: last7Days, fill: true, backgroundColor: 'rgba(0, 51, 26, 0.1)', borderColor: 'rgba(0, 51, 26, 1)', borderWidth: 2, tension: 0.3 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' } }, x: { grid: { display: false } } } } });
const ctx3 = document.getElementById('activeRegionChart').getContext('2d');
if (window.chart3) window.chart3.destroy();
window.chart3 = new Chart(ctx3, { type: 'doughnut', data: { labels: activeLabels, datasets: [{ data: activeRegionData, backgroundColor: ['rgba(0, 51, 26, 0.85)', 'rgba(184, 155, 94, 0.85)', 'rgba(0, 51, 26, 0.7)', 'rgba(184, 155, 94, 0.7)', 'rgba(0, 51, 26, 0.55)'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { font: { size: 10 } } } }, cutout: '70%' } });
const totalMembers = members?.length || 0;
const activeMembers = members?.filter(m => m.status === 'active').length || 0;
const regionsCount = Object.keys(regionCounts).length || 0;
document.getElementById('totalMembers').textContent = totalMembers;
document.getElementById('activeMembers').textContent = activeMembers;
document.getElementById('regionsCount').textContent = regionsCount;
} catch (error) { console.error('Error initializing charts:', error); }
}
document.addEventListener('DOMContentLoaded', () => {
document.getElementById('btnMsg').onclick = () => alert('Messages feature coming soon');
document.getElementById('btnRem').onclick = () => alert('Reminders feature coming soon');
document.getElementById('btnEvt').onclick = () => alert('Events calendar coming soon');
document.getElementById('btnRep').onclick = () => alert('Report generator coming soon');
initCharts();
});
</script>
</body>
</html>
